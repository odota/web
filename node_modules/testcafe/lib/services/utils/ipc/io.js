"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SyncWriter = exports.SyncReader = exports.AsyncWriter = exports.AsyncReader = void 0;
const fs_1 = __importDefault(require("fs"));
const debug_1 = __importDefault(require("debug"));
const packet_1 = __importDefault(require("./packet"));
const message_1 = require("./message");
const async_event_emitter_1 = __importDefault(require("../../../utils/async-event-emitter"));
const debugLogger = debug_1.default('testcafe:services:utils:ipc:io');
class AsyncReader extends async_event_emitter_1.default {
    constructor(stream) {
        super();
        this.parser = new message_1.MessageParser();
        this.stream = stream;
        this.processMessages = Promise.resolve();
    }
    _onData(data) {
        const messages = this.parser.parse(data);
        if (!messages.length)
            return;
        this.processMessages = this.processMessages.then(() => this._processMessages(messages));
    }
    async _processMessages(messages) {
        for (const message of messages) {
            try {
                await this.emit('data', message);
            }
            catch (e) {
                debugLogger(e);
            }
        }
    }
    read() {
        this.stream.on('data', data => this._onData(data));
    }
}
exports.AsyncReader = AsyncReader;
class AsyncWriter {
    constructor(stream) {
        this.serializer = new message_1.MessageSerializer();
        this.stream = stream;
        this.batchPromise = Promise.resolve();
    }
    _write(buffer) {
        if (this.stream.write(buffer))
            return Promise.resolve();
        return new Promise(r => this.stream.once('drain', r));
    }
    _writeBuffers(buffers) {
        this.batchPromise = this.batchPromise
            .catch(() => { })
            .then(async () => {
            for (const buffer of buffers)
                await this._write(buffer);
        });
        return this.batchPromise;
    }
    async write(message) {
        const buffers = this.serializer.serialize(message);
        return await this._writeBuffers(buffers);
    }
}
exports.AsyncWriter = AsyncWriter;
class SyncReader {
    constructor(fd) {
        this.parser = new message_1.MessageParser();
        this.fd = fd;
        this.messageQueue = [];
    }
    _readSync() {
        const buffer = Buffer.alloc(packet_1.default.MAX_PACKET_SIZE);
        const readLength = fs_1.default.readSync(this.fd, buffer, 0, packet_1.default.MAX_PACKET_SIZE, null);
        return buffer.slice(0, readLength);
    }
    _addMessagesToQueue() {
        let messages = this.parser.parse(this._readSync());
        while (!messages.length)
            messages = this.parser.parse(this._readSync());
        this.messageQueue.push(...messages);
    }
    readSync() {
        let message = this.messageQueue.shift();
        while (!message) {
            this._addMessagesToQueue();
            message = this.messageQueue.shift();
        }
        return message;
    }
}
exports.SyncReader = SyncReader;
class SyncWriter {
    constructor(fd) {
        this.serializer = new message_1.MessageSerializer();
        this.fd = fd;
    }
    _writeSync(buffer) {
        fs_1.default.writeSync(this.fd, buffer);
    }
    writeSync(message) {
        const buffers = this.serializer.serialize(message);
        for (const buffer of buffers)
            this._writeSync(buffer);
    }
}
exports.SyncWriter = SyncWriter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2VydmljZXMvdXRpbHMvaXBjL2lvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRDQUFvQjtBQUNwQixrREFBMEI7QUFDMUIsc0RBQThCO0FBQzlCLHVDQUE2RDtBQUM3RCw2RkFBOEQ7QUFHOUQsTUFBTSxXQUFXLEdBQUcsZUFBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7QUFFNUQsTUFBYSxXQUFZLFNBQVEsNkJBQVk7SUFLekMsWUFBb0IsTUFBNkI7UUFDN0MsS0FBSyxFQUFFLENBQUM7UUFFUixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksdUJBQWEsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLElBQUksQ0FBQyxlQUFlLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFTyxPQUFPLENBQUUsSUFBWTtRQUN6QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV6QyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU07WUFDaEIsT0FBTztRQUVYLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDNUYsQ0FBQztJQUVPLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBRSxRQUFrQjtRQUM5QyxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsRUFBRTtZQUM1QixJQUFJO2dCQUNBLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDcEM7WUFDRCxPQUFPLENBQUMsRUFBRTtnQkFDTixXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDbEI7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Q0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBRTNCLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3ZDO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztDQUNKO0FBdkNELGdDQXVDQztBQUVELE1BQWEsVUFBVTtJQUluQixZQUFvQixFQUFVO1FBQzFCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSwyQkFBaUIsRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyxFQUFFLEdBQVcsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFTyxVQUFVLENBQUUsTUFBYztRQUM5QixZQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVNLFNBQVMsQ0FBRSxPQUFlO1FBQzdCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRW5ELEtBQUssTUFBTSxNQUFNLElBQUksT0FBTztZQUN4QixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDSjtBQW5CRCxnQ0FtQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBQYWNrZXQgZnJvbSAnLi9wYWNrZXQnO1xuaW1wb3J0IHsgTWVzc2FnZVBhcnNlciwgTWVzc2FnZVNlcmlhbGl6ZXIgfSBmcm9tICcuL21lc3NhZ2UnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICcuLi8uLi8uLi91dGlscy9hc3luYy1ldmVudC1lbWl0dGVyJztcblxuXG5jb25zdCBkZWJ1Z0xvZ2dlciA9IGRlYnVnKCd0ZXN0Y2FmZTpzZXJ2aWNlczp1dGlsczppcGM6aW8nKTtcblxuZXhwb3J0IGNsYXNzIEFzeW5jUmVhZGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhcnNlcjogTWVzc2FnZVBhcnNlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0cmVhbTogTm9kZUpTLlJlYWRhYmxlU3RyZWFtO1xuICAgIHByaXZhdGUgcHJvY2Vzc01lc3NhZ2VzOiBQcm9taXNlPHZvaWQ+O1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChzdHJlYW06IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMucGFyc2VyID0gbmV3IE1lc3NhZ2VQYXJzZXIoKTtcbiAgICAgICAgdGhpcy5zdHJlYW0gPSBzdHJlYW07XG5cbiAgICAgICAgdGhpcy5wcm9jZXNzTWVzc2FnZXMgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vbkRhdGEgKGRhdGE6IEJ1ZmZlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IHRoaXMucGFyc2VyLnBhcnNlKGRhdGEpO1xuXG4gICAgICAgIGlmICghbWVzc2FnZXMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMucHJvY2Vzc01lc3NhZ2VzID0gdGhpcy5wcm9jZXNzTWVzc2FnZXMudGhlbigoKSA9PiB0aGlzLl9wcm9jZXNzTWVzc2FnZXMobWVzc2FnZXMpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9wcm9jZXNzTWVzc2FnZXMgKG1lc3NhZ2VzOiBvYmplY3RbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBmb3IgKGNvbnN0IG1lc3NhZ2Ugb2YgbWVzc2FnZXMpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0KCdkYXRhJywgbWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGRlYnVnTG9nZ2VyKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHJlYWQgKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0cmVhbS5vbignZGF0YScsIGRhdGEgPT4gdGhpcy5fb25EYXRhKGRhdGEpKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBc3luY1dyaXRlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXJpYWxpemVyOiBNZXNzYWdlU2VyaWFsaXplcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0cmVhbTogTm9kZUpTLldyaXRhYmxlU3RyZWFtO1xuXG4gICAgcHJpdmF0ZSBiYXRjaFByb21pc2U6IFByb21pc2U8dm9pZD47XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKHN0cmVhbTogTm9kZUpTLldyaXRhYmxlU3RyZWFtKSB7XG4gICAgICAgIHRoaXMuc2VyaWFsaXplciA9IG5ldyBNZXNzYWdlU2VyaWFsaXplcigpO1xuICAgICAgICB0aGlzLnN0cmVhbSAgICAgPSBzdHJlYW07XG5cbiAgICAgICAgdGhpcy5iYXRjaFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF93cml0ZSAoYnVmZmVyOiBCdWZmZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMuc3RyZWFtLndyaXRlKGJ1ZmZlcikpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHIgPT4gdGhpcy5zdHJlYW0ub25jZSgnZHJhaW4nLCByKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfd3JpdGVCdWZmZXJzIChidWZmZXJzOiBCdWZmZXJbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICB0aGlzLmJhdGNoUHJvbWlzZSA9IHRoaXMuYmF0Y2hQcm9taXNlXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge30pXG4gICAgICAgICAgICAudGhlbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBidWZmZXIgb2YgYnVmZmVycylcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fd3JpdGUoYnVmZmVyKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmJhdGNoUHJvbWlzZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgd3JpdGUgKG1lc3NhZ2U6IG9iamVjdCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBidWZmZXJzID0gdGhpcy5zZXJpYWxpemVyLnNlcmlhbGl6ZShtZXNzYWdlKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fd3JpdGVCdWZmZXJzKGJ1ZmZlcnMpO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFN5bmNSZWFkZXIge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcGFyc2VyOiBNZXNzYWdlUGFyc2VyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZmQ6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1lc3NhZ2VRdWV1ZTogb2JqZWN0W107XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKGZkOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5wYXJzZXIgPSBuZXcgTWVzc2FnZVBhcnNlcigpO1xuICAgICAgICB0aGlzLmZkICAgICA9IGZkO1xuXG4gICAgICAgIHRoaXMubWVzc2FnZVF1ZXVlID0gW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVhZFN5bmMgKCk6IEJ1ZmZlciB7XG4gICAgICAgIGNvbnN0IGJ1ZmZlciAgICAgPSBCdWZmZXIuYWxsb2MoUGFja2V0Lk1BWF9QQUNLRVRfU0laRSk7XG4gICAgICAgIGNvbnN0IHJlYWRMZW5ndGggPSBmcy5yZWFkU3luYyh0aGlzLmZkLCBidWZmZXIsIDAsIFBhY2tldC5NQVhfUEFDS0VUX1NJWkUsIG51bGwpO1xuXG4gICAgICAgIHJldHVybiBidWZmZXIuc2xpY2UoMCwgcmVhZExlbmd0aCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYWRkTWVzc2FnZXNUb1F1ZXVlICgpOiB2b2lkIHtcbiAgICAgICAgbGV0IG1lc3NhZ2VzID0gdGhpcy5wYXJzZXIucGFyc2UodGhpcy5fcmVhZFN5bmMoKSk7XG5cbiAgICAgICAgd2hpbGUgKCFtZXNzYWdlcy5sZW5ndGgpXG4gICAgICAgICAgICBtZXNzYWdlcyA9IHRoaXMucGFyc2VyLnBhcnNlKHRoaXMuX3JlYWRTeW5jKCkpO1xuXG4gICAgICAgIHRoaXMubWVzc2FnZVF1ZXVlLnB1c2goLi4ubWVzc2FnZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWFkU3luYyAoKTogb2JqZWN0IHtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2VRdWV1ZS5zaGlmdCgpO1xuXG4gICAgICAgIHdoaWxlICghbWVzc2FnZSkge1xuICAgICAgICAgICAgdGhpcy5fYWRkTWVzc2FnZXNUb1F1ZXVlKCk7XG5cbiAgICAgICAgICAgIG1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2VRdWV1ZS5zaGlmdCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgU3luY1dyaXRlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXJpYWxpemVyOiBNZXNzYWdlU2VyaWFsaXplcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZkOiBudW1iZXI7XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKGZkOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5zZXJpYWxpemVyID0gbmV3IE1lc3NhZ2VTZXJpYWxpemVyKCk7XG4gICAgICAgIHRoaXMuZmQgICAgICAgICA9IGZkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3dyaXRlU3luYyAoYnVmZmVyOiBCdWZmZXIpOiB2b2lkIHtcbiAgICAgICAgZnMud3JpdGVTeW5jKHRoaXMuZmQsIGJ1ZmZlcik7XG4gICAgfVxuXG4gICAgcHVibGljIHdyaXRlU3luYyAobWVzc2FnZTogb2JqZWN0KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGJ1ZmZlcnMgPSB0aGlzLnNlcmlhbGl6ZXIuc2VyaWFsaXplKG1lc3NhZ2UpO1xuXG4gICAgICAgIGZvciAoY29uc3QgYnVmZmVyIG9mIGJ1ZmZlcnMpXG4gICAgICAgICAgICB0aGlzLl93cml0ZVN5bmMoYnVmZmVyKTtcbiAgICB9XG59XG4iXX0=