"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const test_run_tracker_1 = __importDefault(require("../../api/test-run-tracker"));
const test_controller_1 = __importDefault(require("../../api/test-controller"));
const observed_callsites_storage_1 = __importDefault(require("../../test-run/observed-callsites-storage"));
const warning_log_1 = __importDefault(require("../../notifications/warning-log"));
const type_1 = __importDefault(require("../../test-run/commands/type"));
const base_1 = require("../../test-run/commands/base");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const re_executable_promise_1 = __importDefault(require("../../utils/re-executable-promise"));
const async_event_emitter_1 = __importDefault(require("../../utils/async-event-emitter"));
const marker_symbol_1 = __importDefault(require("../../test-run/marker-symbol"));
const constants_1 = require("../../test-run/execute-js-expression/constants");
const marker_1 = require("../serialization/replicator/transforms/function-marker-transform/marker");
const get_fn_1 = __importDefault(require("../../assertions/get-fn"));
const thennable_1 = require("../../utils/thennable");
const marker_2 = require("../serialization/replicator/transforms/promise-marker-transform/marker");
const observation_1 = require("../../test-run/commands/observation");
class TestRunProxy extends async_event_emitter_1.default {
    constructor({ dispatcher, id, test, options, browser, activeWindowId, messageBus }) {
        super();
        this.debugging = false;
        this[marker_symbol_1.default] = true;
        this.dispatcher = dispatcher;
        this.id = id;
        this.test = test;
        this.ctx = Object.create(null);
        this.fixtureCtx = Object.create(null);
        this._options = options;
        this.browser = browser;
        this.assertionCommands = new Map();
        this.switchToWindowByPredicateCommands = new Map();
        this.asyncJsExpressionCallsites = new Map();
        this.controller = new test_controller_1.default(this);
        this.observedCallsites = new observed_callsites_storage_1.default();
        this.warningLog = new warning_log_1.default(null, warning_log_1.default.createAddWarningCallback(messageBus));
        this.disableMultipleWindows = options.disableMultipleWindows;
        this.activeWindowId = activeWindowId;
        test_run_tracker_1.default.addActiveTestRun(this);
        this._initializeRequestHooks();
    }
    _initializeRequestHooks() {
        this.test.requestHooks.forEach(this._attachWarningLog, this);
    }
    _attachWarningLog(hook) {
        hook._warningLog = this.warningLog;
    }
    _detachWarningLog(hook) {
        hook._warningLog = null;
    }
    _storeAssertionCommand(command) {
        command.id = testcafe_hammerhead_1.generateUniqueId();
        this.assertionCommands.set(command.id, command);
    }
    _storeSwitchToWindowByPredicateCommand(command) {
        command.id = testcafe_hammerhead_1.generateUniqueId();
        this.switchToWindowByPredicateCommands.set(command.id, command);
    }
    _handleAssertionCommand(command) {
        if (lodash_1.isFunction(command.actual)) {
            command.originActual = command.actual;
            command.actual = new marker_1.FunctionMarker();
            this._storeAssertionCommand(command);
        }
        else if (command.actual instanceof re_executable_promise_1.default)
            this._storeAssertionCommand(command);
        else if (thennable_1.isThennable(command.actual)) {
            command.originActual = command.actual;
            command.actual = new marker_2.PromiseMarker();
            this._storeAssertionCommand(command);
        }
    }
    _handleExecuteClientFunctionCommandBase(command) {
        command.esmRuntime = this.test.esmRuntime;
    }
    _storeActionCallsitesForExecutedAsyncJsExpression(callsite) {
        // @ts-ignore
        if ((callsite === null || callsite === void 0 ? void 0 : callsite.filename) !== constants_1.ERROR_FILENAME)
            return;
        const id = testcafe_hammerhead_1.generateUniqueId();
        // @ts-ignore
        callsite.id = id;
        this.asyncJsExpressionCallsites.set(id, callsite);
    }
    async executeCommand(command, callsite) {
        if (command instanceof base_1.ActionCommandBase && callsite)
            this._storeActionCallsitesForExecutedAsyncJsExpression(callsite);
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        else if (command.type === type_1.default.useRole)
            this.dispatcher.onRoleAppeared(command.role);
        else if (command.type === type_1.default.switchToWindowByPredicate)
            this._storeSwitchToWindowByPredicateCommand(command);
        else if (command instanceof observation_1.ExecuteClientFunctionCommandBase)
            this._handleExecuteClientFunctionCommandBase(command);
        return this.dispatcher.executeCommand({
            command,
            callsite,
            id: this.id,
        });
    }
    executeCommandSync(command, callsite) {
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        else if (command.type === type_1.default.useRole)
            this.dispatcher.onRoleAppeared(command.role);
        return this.dispatcher.executeCommandSync({
            command,
            callsite,
            id: this.id,
        });
    }
    async addRequestHook(hook) {
        if (this.test.requestHooks.includes(hook))
            return;
        this.test.requestHooks.push(hook);
        this._attachWarningLog(hook);
        await this.dispatcher.addRequestEventListeners({
            hookId: hook.id,
            hookClassName: hook._className,
            rules: hook._requestFilterRules,
        });
    }
    async removeRequestHook(hook) {
        if (!this.test.requestHooks.includes(hook))
            return;
        lodash_1.pull(this.test.requestHooks, hook);
        this._detachWarningLog(hook);
        await this.dispatcher.removeRequestEventListeners({ rules: hook._requestFilterRules });
    }
    async getAssertionActualValue(commandId) {
        const command = this.assertionCommands.get(commandId);
        return command.actual._reExecute();
    }
    async executeAssertionFn(commandId) {
        const command = this.assertionCommands.get(commandId);
        command.actual = command.originActual;
        const fn = get_fn_1.default(command);
        return await fn();
    }
    restoreOriginCallsiteForError(err) {
        err.errCallsite = this.asyncJsExpressionCallsites.get(err.errCallsite.id);
        this.asyncJsExpressionCallsites.clear();
    }
    checkWindow(commandId, { title, url }) {
        const command = this.switchToWindowByPredicateCommands.get(commandId);
        return command.checkWindow({ title, url });
    }
}
exports.default = TestRunProxy;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1ydW4tcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvY29tcGlsZXIvdGVzdC1ydW4tcHJveHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtQ0FBMEM7QUFDMUMsa0ZBQXdEO0FBRXhELGdGQUF1RDtBQUN2RCwyR0FBaUY7QUFDakYsa0ZBQXlEO0FBR3pELHdFQUF3RDtBQUN4RCx1REFBOEU7QUFJOUUsNkRBQXVEO0FBU3ZELDhGQUFvRTtBQUNwRSwwRkFBZ0U7QUFDaEUsaUZBQXlEO0FBQ3pELDhFQUFnRjtBQUVoRixvR0FBeUc7QUFDekcscUVBQTRDO0FBQzVDLHFEQUFvRDtBQUNwRCxtR0FBdUc7QUFDdkcscUVBQXVGO0FBRXZGLE1BQU0sWUFBYSxTQUFRLDZCQUFpQjtJQW1CeEMsWUFBb0IsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQW9CO1FBQ3hHLEtBQUssRUFBRSxDQUFDO1FBWkwsY0FBUyxHQUFHLEtBQUssQ0FBQztRQWNyQixJQUFJLENBQUMsdUJBQWEsQ0FBQyxHQUFzQixJQUFJLENBQUM7UUFDOUMsSUFBSSxDQUFDLFVBQVUsR0FBMEIsVUFBVSxDQUFDO1FBQ3BELElBQUksQ0FBQyxFQUFFLEdBQWtDLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFnQyxJQUFJLENBQUM7UUFDOUMsSUFBSSxDQUFDLEdBQUcsR0FBaUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsVUFBVSxHQUEwQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxRQUFRLEdBQTRCLE9BQU8sQ0FBQztRQUNqRCxJQUFJLENBQUMsT0FBTyxHQUE2QixPQUFPLENBQUM7UUFDakQsSUFBSSxDQUFDLGlC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QUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQXFCLENBQUM7UUFFMUUsT0FBUSxPQUFPLENBQUMsTUFBOEIsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUNoRSxDQUFDO0lBRU0sS0FBSyxDQUFDLGtCQUFrQixDQUFFLFNBQWlCO1FBQzlDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFxQixDQUFDO1FBRTFFLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUV0QyxNQUFNLEVBQUUsR0FBRyxnQkFBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTFCLE9BQU8sTUFBTSxFQUFFLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRU0sNkJBQTZCLENBQUUsR0FBd0M7UUFDMUUsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFMUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFFTSxXQUFXLENBQUUsU0FBaUIsRUFBRSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQTRCO1FBQzNFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFxQyxDQUFDO1FBRTFHLE9BQU8sT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQy9DLENBQUM7Q0FDSjtBQUVELGtCQUFlLFlBQVksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHB1bGwsIGlzRnVuY3Rpb24gfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHRlc3RSdW5UcmFja2VyIGZyb20gJy4uLy4uL2FwaS90ZXN0LXJ1bi10cmFja2VyJztcbmltcG9ydCB7IFRlc3RSdW5EaXNwYXRjaGVyUHJvdG9jb2wgfSBmcm9tICcuL3Byb3RvY29sJztcbmltcG9ydCBUZXN0Q29udHJvbGxlciBmcm9tICcuLi8uLi9hcGkvdGVzdC1jb250cm9sbGVyJztcbmltcG9ydCBPYnNlcnZlZENhbGxzaXRlc1N0b3JhZ2UgZnJvbSAnLi4vLi4vdGVzdC1ydW4vb2JzZXJ2ZWQtY2FsbHNpdGVzLXN0b3JhZ2UnO1xuaW1wb3J0IFdhcm5pbmdMb2cgZnJvbSAnLi4vLi4vbm90aWZpY2F0aW9ucy93YXJuaW5nLWxvZyc7XG5pbXBvcnQgeyBBc3NlcnRpb25Db21tYW5kIH0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYXNzZXJ0aW9uJztcbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi8uLi9jb25maWd1cmF0aW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IENPTU1BTkRfVFlQRSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy90eXBlJztcbmltcG9ydCB7IEFjdGlvbkNvbW1hbmRCYXNlLCBDb21tYW5kQmFzZSB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2Jhc2UnO1xuaW1wb3J0IHsgVGVzdFJ1blByb3h5SW5pdCB9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IFRlc3QgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0JztcbmltcG9ydCBSZXF1ZXN0SG9vayBmcm9tICcuLi8uLi9hcGkvcmVxdWVzdC1ob29rcy9ob29rJztcbmltcG9ydCB7IGdlbmVyYXRlVW5pcXVlSWQgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCB7IENhbGxzaXRlUmVjb3JkIH0gZnJvbSAnY2FsbHNpdGUtcmVjb3JkJztcblxuaW1wb3J0IHtcbiAgICBDaGVja1dpbmRvd1ByZWRpY2F0ZURhdGEsXG4gICAgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQsXG4gICAgVXNlUm9sZUNvbW1hbmQsXG59IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2FjdGlvbnMnO1xuXG5pbXBvcnQgUmVFeGVjdXRhYmxlUHJvbWlzZSBmcm9tICcuLi8uLi91dGlscy9yZS1leGVjdXRhYmxlLXByb21pc2UnO1xuaW1wb3J0IEFzeW5jRXZlbnRFbWl0dGVyIGZyb20gJy4uLy4uL3V0aWxzL2FzeW5jLWV2ZW50LWVtaXR0ZXInO1xuaW1wb3J0IHRlc3RSdW5NYXJrZXIgZnJvbSAnLi4vLi4vdGVzdC1ydW4vbWFya2VyLXN5bWJvbCc7XG5pbXBvcnQgeyBFUlJPUl9GSUxFTkFNRSB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2V4ZWN1dGUtanMtZXhwcmVzc2lvbi9jb25zdGFudHMnO1xuaW1wb3J0IHsgVW5jYXVnaHRUZXN0Q2FmZUVycm9ySW5DdXN0b21TY3JpcHQgfSBmcm9tICcuLi8uLi9lcnJvcnMvdGVzdC1ydW4nO1xuaW1wb3J0IHsgRnVuY3Rpb25NYXJrZXIgfSBmcm9tICcuLi9zZXJpYWxpemF0aW9uL3JlcGxpY2F0b3IvdHJhbnNmb3Jtcy9mdW5jdGlvbi1tYXJrZXItdHJhbnNmb3JtL21hcmtlcic7XG5pbXBvcnQgZ2V0Rm4gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucy9nZXQtZm4nO1xuaW1wb3J0IHsgaXNUaGVubmFibGUgfSBmcm9tICcuLi8uLi91dGlscy90aGVubmFibGUnO1xuaW1wb3J0IHsgUHJvbWlzZU1hcmtlciB9IGZyb20gJy4uL3NlcmlhbGl6YXRpb24vcmVwbGljYXRvci90cmFuc2Zvcm1zL3Byb21pc2UtbWFya2VyLXRyYW5zZm9ybS9tYXJrZXInO1xuaW1wb3J0IHsgRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UgfSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9vYnNlcnZhdGlvbic7XG5cbmNsYXNzIFRlc3RSdW5Qcm94eSBleHRlbmRzIEFzeW5jRXZlbnRFbWl0dGVyIHtcbiAgICBwcml2YXRlIFt0ZXN0UnVuTWFya2VyXTogYm9vbGVhbjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICBwdWJsaWMgcmVhZG9ubHkgdGVzdDogVGVzdDtcbiAgICBwdWJsaWMgcmVhZG9ubHkgY29udHJvbGxlcjogVGVzdENvbnRyb2xsZXI7XG4gICAgcHVibGljIHJlYWRvbmx5IG9ic2VydmVkQ2FsbHNpdGVzOiBPYnNlcnZlZENhbGxzaXRlc1N0b3JhZ2U7XG4gICAgcHVibGljIHJlYWRvbmx5IHdhcm5pbmdMb2c6IFdhcm5pbmdMb2c7XG4gICAgcHVibGljIGZpeHR1cmVDdHg6IG9iamVjdDtcbiAgICBwdWJsaWMgZGVidWdnaW5nID0gZmFsc2U7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkaXNwYXRjaGVyOiBUZXN0UnVuRGlzcGF0Y2hlclByb3RvY29sO1xuICAgIHB1YmxpYyBjdHg6IG9iamVjdDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9vcHRpb25zOiBEaWN0aW9uYXJ5PE9wdGlvblZhbHVlPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFzc2VydGlvbkNvbW1hbmRzOiBNYXA8c3RyaW5nLCBBc3NlcnRpb25Db21tYW5kPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kczogTWFwPHN0cmluZywgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQ+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYXN5bmNKc0V4cHJlc3Npb25DYWxsc2l0ZXM6IE1hcDxzdHJpbmcsIENhbGxzaXRlUmVjb3JkPjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgYnJvd3NlcjogQnJvd3NlcjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgZGlzYWJsZU11bHRpcGxlV2luZG93czogYm9vbGVhbjtcbiAgICBwdWJsaWMgYWN0aXZlV2luZG93SWQ6IG51bGwgfCBzdHJpbmc7XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKHsgZGlzcGF0Y2hlciwgaWQsIHRlc3QsIG9wdGlvbnMsIGJyb3dzZXIsIGFjdGl2ZVdpbmRvd0lkLCBtZXNzYWdlQnVzIH06IFRlc3RSdW5Qcm94eUluaXQpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzW3Rlc3RSdW5NYXJrZXJdICAgICAgICAgICAgICAgICAgICA9IHRydWU7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hlciAgICAgICAgICAgICAgICAgICAgICAgID0gZGlzcGF0Y2hlcjtcbiAgICAgICAgdGhpcy5pZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBpZDtcbiAgICAgICAgdGhpcy50ZXN0ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0ZXN0O1xuICAgICAgICB0aGlzLmN0eCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgIHRoaXMuZml4dHVyZUN0eCAgICAgICAgICAgICAgICAgICAgICAgID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICAgICAgdGhpcy5fb3B0aW9ucyAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zO1xuICAgICAgICB0aGlzLmJyb3dzZXIgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGJyb3dzZXI7XG4gICAgICAgIHRoaXMuYXNzZXJ0aW9uQ29tbWFuZHMgICAgICAgICAgICAgICAgID0gbmV3IE1hcDxzdHJpbmcsIEFzc2VydGlvbkNvbW1hbmQ+KCk7XG4gICAgICAgIHRoaXMuc3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmRzID0gbmV3IE1hcDxzdHJpbmcsIFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kPigpO1xuICAgICAgICB0aGlzLmFzeW5jSnNFeHByZXNzaW9uQ2FsbHNpdGVzICAgICAgICA9IG5ldyBNYXA8c3RyaW5nLCBDYWxsc2l0ZVJlY29yZD4oKTtcbiAgICAgICAgdGhpcy5jb250cm9sbGVyICAgICAgICAgICAgICAgICAgICAgICAgPSBuZXcgVGVzdENvbnRyb2xsZXIodGhpcyk7XG4gICAgICAgIHRoaXMub2JzZXJ2ZWRDYWxsc2l0ZXMgICAgICAgICAgICAgICAgID0gbmV3IE9ic2VydmVkQ2FsbHNpdGVzU3RvcmFnZSgpO1xuICAgICAgICB0aGlzLndhcm5pbmdMb2cgICAgICAgICAgICAgICAgICAgICAgICA9IG5ldyBXYXJuaW5nTG9nKG51bGwsIFdhcm5pbmdMb2cuY3JlYXRlQWRkV2FybmluZ0NhbGxiYWNrKG1lc3NhZ2VCdXMpKTtcbiAgICAgICAgdGhpcy5kaXNhYmxlTXVsdGlwbGVXaW5kb3dzICAgICAgICAgICAgPSBvcHRpb25zLmRpc2FibGVNdWx0aXBsZVdpbmRvd3MgYXMgYm9vbGVhbjtcbiAgICAgICAgdGhpcy5hY3RpdmVXaW5kb3dJZCAgICAgICAgICAgICAgICAgICAgPSBhY3RpdmVXaW5kb3dJZDtcblxuICAgICAgICB0ZXN0UnVuVHJhY2tlci5hZGRBY3RpdmVUZXN0UnVuKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVSZXF1ZXN0SG9va3MoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbml0aWFsaXplUmVxdWVzdEhvb2tzICgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5mb3JFYWNoKHRoaXMuX2F0dGFjaFdhcm5pbmdMb2csIHRoaXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2F0dGFjaFdhcm5pbmdMb2cgKGhvb2s6IFJlcXVlc3RIb29rKTogdm9pZCB7XG4gICAgICAgIGhvb2suX3dhcm5pbmdMb2cgPSB0aGlzLndhcm5pbmdMb2c7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGV0YWNoV2FybmluZ0xvZyAoaG9vazogUmVxdWVzdEhvb2spOiB2b2lkIHtcbiAgICAgICAgaG9vay5fd2FybmluZ0xvZyA9IG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc3RvcmVBc3NlcnRpb25Db21tYW5kIChjb21tYW5kOiBBc3NlcnRpb25Db21tYW5kKTogdm9pZCB7XG4gICAgICAgIGNvbW1hbmQuaWQgPSBnZW5lcmF0ZVVuaXF1ZUlkKCk7XG5cbiAgICAgICAgdGhpcy5hc3NlcnRpb25Db21tYW5kcy5zZXQoY29tbWFuZC5pZCwgY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc3RvcmVTd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZCAoY29tbWFuZDogU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgY29tbWFuZC5pZCA9IGdlbmVyYXRlVW5pcXVlSWQoKTtcblxuICAgICAgICB0aGlzLnN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kcy5zZXQoY29tbWFuZC5pZCwgY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlQXNzZXJ0aW9uQ29tbWFuZCAoY29tbWFuZDogQXNzZXJ0aW9uQ29tbWFuZCk6IHZvaWQge1xuICAgICAgICBpZiAoaXNGdW5jdGlvbihjb21tYW5kLmFjdHVhbCkpIHtcbiAgICAgICAgICAgIGNvbW1hbmQub3JpZ2luQWN0dWFsID0gY29tbWFuZC5hY3R1YWw7XG4gICAgICAgICAgICBjb21tYW5kLmFjdHVhbCAgICAgICA9IG5ldyBGdW5jdGlvbk1hcmtlcigpO1xuXG4gICAgICAgICAgICB0aGlzLl9zdG9yZUFzc2VydGlvbkNvbW1hbmQoY29tbWFuZCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZC5hY3R1YWwgaW5zdGFuY2VvZiBSZUV4ZWN1dGFibGVQcm9taXNlKVxuICAgICAgICAgICAgdGhpcy5fc3RvcmVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQpO1xuXG4gICAgICAgIGVsc2UgaWYgKGlzVGhlbm5hYmxlKGNvbW1hbmQuYWN0dWFsKSkge1xuICAgICAgICAgICAgY29tbWFuZC5vcmlnaW5BY3R1YWwgPSBjb21tYW5kLmFjdHVhbDtcbiAgICAgICAgICAgIGNvbW1hbmQuYWN0dWFsICAgICAgID0gbmV3IFByb21pc2VNYXJrZXIoKTtcblxuICAgICAgICAgICAgdGhpcy5fc3RvcmVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaGFuZGxlRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UgKGNvbW1hbmQ6IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlKTogdm9pZCB7XG4gICAgICAgIGNvbW1hbmQuZXNtUnVudGltZSA9IHRoaXMudGVzdC5lc21SdW50aW1lO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3N0b3JlQWN0aW9uQ2FsbHNpdGVzRm9yRXhlY3V0ZWRBc3luY0pzRXhwcmVzc2lvbiAoY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkKTogdm9pZCB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaWYgKGNhbGxzaXRlPy5maWxlbmFtZSAhPT0gRVJST1JfRklMRU5BTUUpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY29uc3QgaWQgPSBnZW5lcmF0ZVVuaXF1ZUlkKCk7XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjYWxsc2l0ZS5pZCA9IGlkO1xuXG4gICAgICAgIHRoaXMuYXN5bmNKc0V4cHJlc3Npb25DYWxsc2l0ZXMuc2V0KGlkLCBjYWxsc2l0ZSBhcyBDYWxsc2l0ZVJlY29yZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjb21tYW5kOiBDb21tYW5kQmFzZSB8IEFjdGlvbkNvbW1hbmRCYXNlLCBjYWxsc2l0ZT86IENhbGxzaXRlUmVjb3JkIHwgc3RyaW5nKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGlmIChjb21tYW5kIGluc3RhbmNlb2YgQWN0aW9uQ29tbWFuZEJhc2UgJiYgY2FsbHNpdGUpXG4gICAgICAgICAgICB0aGlzLl9zdG9yZUFjdGlvbkNhbGxzaXRlc0ZvckV4ZWN1dGVkQXN5bmNKc0V4cHJlc3Npb24oY2FsbHNpdGUgYXMgQ2FsbHNpdGVSZWNvcmQpO1xuXG4gICAgICAgIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5hc3NlcnRpb24pXG4gICAgICAgICAgICB0aGlzLl9oYW5kbGVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQgYXMgQXNzZXJ0aW9uQ29tbWFuZCk7XG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnVzZVJvbGUpXG4gICAgICAgICAgICB0aGlzLmRpc3BhdGNoZXIub25Sb2xlQXBwZWFyZWQoKGNvbW1hbmQgYXMgVXNlUm9sZUNvbW1hbmQpLnJvbGUpO1xuICAgICAgICBlbHNlIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5zd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlKVxuICAgICAgICAgICAgdGhpcy5fc3RvcmVTd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZChjb21tYW5kIGFzIFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kKTtcbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZCBpbnN0YW5jZW9mIEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlKVxuICAgICAgICAgICAgdGhpcy5faGFuZGxlRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UoY29tbWFuZCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hlci5leGVjdXRlQ29tbWFuZCh7XG4gICAgICAgICAgICBjb21tYW5kLFxuICAgICAgICAgICAgY2FsbHNpdGUsXG4gICAgICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGV4ZWN1dGVDb21tYW5kU3luYyAoY29tbWFuZDogQ29tbWFuZEJhc2UsIGNhbGxzaXRlOiBDYWxsc2l0ZVJlY29yZCk6IHVua25vd24ge1xuICAgICAgICBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuYXNzZXJ0aW9uKVxuICAgICAgICAgICAgdGhpcy5faGFuZGxlQXNzZXJ0aW9uQ29tbWFuZChjb21tYW5kIGFzIEFzc2VydGlvbkNvbW1hbmQpO1xuICAgICAgICBlbHNlIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS51c2VSb2xlKVxuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaGVyLm9uUm9sZUFwcGVhcmVkKChjb21tYW5kIGFzIFVzZVJvbGVDb21tYW5kKS5yb2xlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5kaXNwYXRjaGVyLmV4ZWN1dGVDb21tYW5kU3luYyh7XG4gICAgICAgICAgICBjb21tYW5kLFxuICAgICAgICAgICAgY2FsbHNpdGUsXG4gICAgICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGFkZFJlcXVlc3RIb29rIChob29rOiBSZXF1ZXN0SG9vayk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy50ZXN0LnJlcXVlc3RIb29rcy5pbmNsdWRlcyhob29rKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLnRlc3QucmVxdWVzdEhvb2tzLnB1c2goaG9vayk7XG4gICAgICAgIHRoaXMuX2F0dGFjaFdhcm5pbmdMb2coaG9vayk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5kaXNwYXRjaGVyLmFkZFJlcXVlc3RFdmVudExpc3RlbmVycyh7XG4gICAgICAgICAgICBob29rSWQ6ICAgICAgICBob29rLmlkLFxuICAgICAgICAgICAgaG9va0NsYXNzTmFtZTogaG9vay5fY2xhc3NOYW1lLFxuICAgICAgICAgICAgcnVsZXM6ICAgICAgICAgaG9vay5fcmVxdWVzdEZpbHRlclJ1bGVzLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVtb3ZlUmVxdWVzdEhvb2sgKGhvb2s6IFJlcXVlc3RIb29rKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5pbmNsdWRlcyhob29rKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBwdWxsKHRoaXMudGVzdC5yZXF1ZXN0SG9va3MsIGhvb2spO1xuICAgICAgICB0aGlzLl9kZXRhY2hXYXJuaW5nTG9nKGhvb2spO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5yZW1vdmVSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoeyBydWxlczogaG9vay5fcmVxdWVzdEZpbHRlclJ1bGVzIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRBc3NlcnRpb25BY3R1YWxWYWx1ZSAoY29tbWFuZElkOiBzdHJpbmcpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuYXNzZXJ0aW9uQ29tbWFuZHMuZ2V0KGNvbW1hbmRJZCkgYXMgQXNzZXJ0aW9uQ29tbWFuZDtcblxuICAgICAgICByZXR1cm4gKGNvbW1hbmQuYWN0dWFsIGFzIFJlRXhlY3V0YWJsZVByb21pc2UpLl9yZUV4ZWN1dGUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUFzc2VydGlvbkZuIChjb21tYW5kSWQ6IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5hc3NlcnRpb25Db21tYW5kcy5nZXQoY29tbWFuZElkKSBhcyBBc3NlcnRpb25Db21tYW5kO1xuXG4gICAgICAgIGNvbW1hbmQuYWN0dWFsID0gY29tbWFuZC5vcmlnaW5BY3R1YWw7XG5cbiAgICAgICAgY29uc3QgZm4gPSBnZXRGbihjb21tYW5kKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgZm4oKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzdG9yZU9yaWdpbkNhbGxzaXRlRm9yRXJyb3IgKGVycjogVW5jYXVnaHRUZXN0Q2FmZUVycm9ySW5DdXN0b21TY3JpcHQpOiB2b2lkIHtcbiAgICAgICAgZXJyLmVyckNhbGxzaXRlID0gdGhpcy5hc3luY0pzRXhwcmVzc2lvbkNhbGxzaXRlcy5nZXQoZXJyLmVyckNhbGxzaXRlLmlkKTtcblxuICAgICAgICB0aGlzLmFzeW5jSnNFeHByZXNzaW9uQ2FsbHNpdGVzLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNoZWNrV2luZG93IChjb21tYW5kSWQ6IHN0cmluZywgeyB0aXRsZSwgdXJsIH06IENoZWNrV2luZG93UHJlZGljYXRlRGF0YSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5zd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZHMuZ2V0KGNvbW1hbmRJZCkgYXMgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQ7XG5cbiAgICAgICAgcmV0dXJuIGNvbW1hbmQuY2hlY2tXaW5kb3coeyB0aXRsZSwgdXJsIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVGVzdFJ1blByb3h5O1xuXG5cbiJdfQ==