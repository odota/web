"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Quarantine = exports.getQuarantineOptions = exports.validateQuarantineOptions = void 0;
const base_1 = __importDefault(require("./base"));
const quarantine_option_names_1 = __importDefault(require("../../configuration/quarantine-option-names"));
const types_1 = require("../../errors/types");
const runtime_1 = require("../../errors/runtime");
const DEFAULT_ATTEMPT_LIMIT = 5;
const DEFAULT_THRESHOLD = 3;
const MIN_ATTEMPT_LIMIT = 2;
const MIN_SUCCESS_THRESHOLD = 1;
function _isQuarantineOption(option) {
    return Object.values(quarantine_option_names_1.default).includes(option);
}
function validateQuarantineOptions(options, optionName) {
    if (Object.keys(options).some(key => !_isQuarantineOption(key)))
        throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.invalidQuarantineOption, optionName);
    const attemptLimit = typeof options.attemptLimit === 'number' ? options.attemptLimit : DEFAULT_ATTEMPT_LIMIT;
    const successThreshold = typeof options.successThreshold === 'number' ? options.successThreshold : DEFAULT_THRESHOLD;
    if (attemptLimit < MIN_ATTEMPT_LIMIT)
        throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.invalidAttemptLimitValue, quarantine_option_names_1.default.attemptLimit, MIN_ATTEMPT_LIMIT);
    if (successThreshold < MIN_SUCCESS_THRESHOLD)
        throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.invalidSuccessThresholdValue, quarantine_option_names_1.default.successThreshold, MIN_SUCCESS_THRESHOLD);
    if (successThreshold >= attemptLimit)
        throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.invalidQuarantineParametersRatio, attemptLimit, successThreshold);
}
exports.validateQuarantineOptions = validateQuarantineOptions;
async function getQuarantineOptions(optionName, options) {
    if (typeof options === 'boolean')
        return true;
    const parsedOptions = await base_1.default(options, {
        skipOptionValueTypeConversion: true,
        async onOptionParsed(key, value) {
            if (!key || !value)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.optionValueIsNotValidKeyValue, optionName);
            return Number(value);
        },
    });
    validateQuarantineOptions(parsedOptions, optionName);
    return parsedOptions;
}
exports.getQuarantineOptions = getQuarantineOptions;
class Quarantine {
    constructor() {
        this.attempts = [];
        this.attemptLimit = DEFAULT_ATTEMPT_LIMIT;
        this.successThreshold = DEFAULT_THRESHOLD;
        this.failureThreshold = DEFAULT_THRESHOLD;
    }
    getFailedAttempts() {
        return this.attempts.filter(({ errors }) => !!errors.length);
    }
    getPassedAttempts() {
        return this.attempts.filter(({ errors }) => errors.length === 0);
    }
    setCustomParameters(attemptLimit, successThreshold) {
        const needToUpdateTestRunThreshold = typeof attemptLimit === 'number';
        const needToUpdatePassedQuarantineThreshold = typeof successThreshold === 'number';
        const needToRecalculateFailedThreshold = needToUpdateTestRunThreshold || needToUpdatePassedQuarantineThreshold;
        if (needToUpdateTestRunThreshold)
            this.attemptLimit = attemptLimit;
        if (needToUpdatePassedQuarantineThreshold)
            this.successThreshold = successThreshold;
        if (needToRecalculateFailedThreshold)
            this._setFailedThreshold();
    }
    getNextAttemptNumber() {
        return this.attempts.length + 1;
    }
    isThresholdReached(extraErrors) {
        const { passedTimes, failedTimes } = this._getAttemptsResult(extraErrors);
        const successThresholdReached = passedTimes >= this.successThreshold;
        const failureThresholdReached = failedTimes >= this.failureThreshold;
        return successThresholdReached || failureThresholdReached;
    }
    isFirstAttemptSuccessful(extraErrors) {
        const { failedTimes, passedTimes } = this._getAttemptsResult(extraErrors);
        return failedTimes === 0 && passedTimes > 0;
    }
    _getAttemptsResult(extraErrors) {
        let failedTimes = this.getFailedAttempts().length;
        let passedTimes = this.getPassedAttempts().length;
        if (extraErrors) {
            if (extraErrors.length)
                failedTimes += extraErrors.length;
            else
                passedTimes += 1;
        }
        return { failedTimes, passedTimes };
    }
    _setFailedThreshold() {
        this.failureThreshold = this.attemptLimit - this.successThreshold + 1;
    }
}
exports.Quarantine = Quarantine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVhcmFudGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9nZXQtb3B0aW9ucy9xdWFyYW50aW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtEQUFvQztBQUNwQywwR0FBa0Y7QUFDbEYsOENBQW9EO0FBQ3BELGtEQUFvRDtBQUlwRCxNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUNoQyxNQUFNLGlCQUFpQixHQUFPLENBQUMsQ0FBQztBQUNoQyxNQUFNLGlCQUFpQixHQUFPLENBQUMsQ0FBQztBQUNoQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUVoQyxTQUFTLG1CQUFtQixDQUFFLE1BQWM7SUFDeEMsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLGlDQUF1QixDQUFDLENBQUMsUUFBUSxDQUFDLE1BQWlDLENBQUMsQ0FBQztBQUM5RixDQUFDO0FBRUQsU0FBZ0IseUJBQXlCLENBQUUsT0FBb0MsRUFBRSxVQUFrQjtJQUMvRixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzRCxNQUFNLElBQUksc0JBQVksQ0FBQyxzQkFBYyxDQUFDLHVCQUF1QixFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBRS9FLE1BQU0sWUFBWSxHQUFPLE9BQU8sT0FBTyxDQUFDLFlBQVksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDO0lBQ2pILE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxPQUFPLENBQUMsZ0JBQWdCLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO0lBRXJILElBQUksWUFBWSxHQUFHLGlCQUFpQjtR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SUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDckUsTUFBTSx1QkFBdUIsR0FBRyxXQUFXLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBRXJFLE9BQU8sdUJBQXVCLElBQUksdUJBQXVCLENBQUM7SUFDOUQsQ0FBQztJQUVNLHdCQUF3QixDQUFFLFdBQTZDO1FBQzFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRTFFLE9BQU8sV0FBVyxLQUFLLENBQUMsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTyxrQkFBa0IsQ0FBRSxXQUE4QztRQUN0RSxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxNQUFNLENBQUM7UUFDbEQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsTUFBTSxDQUFDO1FBRWxELElBQUksV0FBVyxFQUFFO1lBQ2IsSUFBSSxXQUFXLENBQUMsTUFBTTtnQkFDbEIsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLENBQUM7O2dCQUVsQyxXQUFXLElBQUksQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBRU8sbUJBQW1CO1FBQ3ZCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7SUFDMUUsQ0FBQztDQUNKO0FBbkVELGdDQW1FQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiYXNlR2V0T3B0aW9ucyBmcm9tICcuL2Jhc2UnO1xuaW1wb3J0IFFVQVJBTlRJTkVfT1BUSU9OX05BTUVTIGZyb20gJy4uLy4uL2NvbmZpZ3VyYXRpb24vcXVhcmFudGluZS1vcHRpb24tbmFtZXMnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gJy4uLy4uL2NvbmZpZ3VyYXRpb24vaW50ZXJmYWNlcyc7XG5pbXBvcnQgVGVzdFJ1bkVycm9yRm9ybWF0dGFibGVBZGFwdGVyIGZyb20gJy4uLy4uL2Vycm9ycy90ZXN0LXJ1bi9mb3JtYXR0YWJsZS1hZGFwdGVyJztcblxuY29uc3QgREVGQVVMVF9BVFRFTVBUX0xJTUlUID0gNTtcbmNvbnN0IERFRkFVTFRfVEhSRVNIT0xEICAgICA9IDM7XG5jb25zdCBNSU5fQVRURU1QVF9MSU1JVCAgICAgPSAyO1xuY29uc3QgTUlOX1NVQ0NFU1NfVEhSRVNIT0xEID0gMTtcblxuZnVuY3Rpb24gX2lzUXVhcmFudGluZU9wdGlvbiAob3B0aW9uOiBzdHJpbmcpOiBvcHRpb24gaXMgUVVBUkFOVElORV9PUFRJT05fTkFNRVMge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKFFVQVJBTlRJTkVfT1BUSU9OX05BTUVTKS5pbmNsdWRlcyhvcHRpb24gYXMgUVVBUkFOVElORV9PUFRJT05fTkFNRVMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVRdWFyYW50aW5lT3B0aW9ucyAob3B0aW9uczogRGljdGlvbmFyeTxzdHJpbmcgfCBudW1iZXI+LCBvcHRpb25OYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoT2JqZWN0LmtleXMob3B0aW9ucykuc29tZShrZXkgPT4gIV9pc1F1YXJhbnRpbmVPcHRpb24oa2V5KSkpXG4gICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuaW52YWxpZFF1YXJhbnRpbmVPcHRpb24sIG9wdGlvbk5hbWUpO1xuXG4gICAgY29uc3QgYXR0ZW1wdExpbWl0ICAgICA9IHR5cGVvZiBvcHRpb25zLmF0dGVtcHRMaW1pdCA9PT0gJ251bWJlcicgPyBvcHRpb25zLmF0dGVtcHRMaW1pdCA6IERFRkFVTFRfQVRURU1QVF9MSU1JVDtcbiAgICBjb25zdCBzdWNjZXNzVGhyZXNob2xkID0gdHlwZW9mIG9wdGlvbnMuc3VjY2Vzc1RocmVzaG9sZCA9PT0gJ251bWJlcicgPyBvcHRpb25zLnN1Y2Nlc3NUaHJlc2hvbGQgOiBERUZBVUxUX1RIUkVTSE9MRDtcblxuICAgIGlmIChhdHRlbXB0TGltaXQgPCBNSU5fQVRURU1QVF9MSU1JVClcbiAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5pbnZhbGlkQXR0ZW1wdExpbWl0VmFsdWUsIFFVQVJBTlRJTkVfT1BUSU9OX05BTUVTLmF0dGVtcHRMaW1pdCwgTUlOX0FUVEVNUFRfTElNSVQpO1xuXG4gICAgaWYgKHN1Y2Nlc3NUaHJlc2hvbGQgPCBNSU5fU1VDQ0VTU19USFJFU0hPTEQpXG4gICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuaW52YWxpZFN1Y2Nlc3NUaHJlc2hvbGRWYWx1ZSwgUVVBUkFOVElORV9PUFRJT05fTkFNRVMuc3VjY2Vzc1RocmVzaG9sZCwgTUlOX1NVQ0NFU1NfVEhSRVNIT0xEKTtcblxuICAgIGlmIChzdWNjZXNzVGhyZXNob2xkID49IGF0dGVtcHRMaW1pdClcbiAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5pbnZhbGlkUXVhcmFudGluZVBhcmFtZXRlcnNSYXRpbywgYXR0ZW1wdExpbWl0LCBzdWNjZXNzVGhyZXNob2xkKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFF1YXJhbnRpbmVPcHRpb25zIChvcHRpb25OYW1lOiBzdHJpbmcsIG9wdGlvbnM6IHN0cmluZyB8IGJvb2xlYW4gfCBEaWN0aW9uYXJ5PHN0cmluZyB8IG51bWJlcj4pOiBQcm9taXNlPERpY3Rpb25hcnk8bnVtYmVyPiB8IGJvb2xlYW4+IHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdib29sZWFuJylcbiAgICAgICAgcmV0dXJuIHRydWU7XG5cbiAgICBjb25zdCBwYXJzZWRPcHRpb25zID0gYXdhaXQgYmFzZUdldE9wdGlvbnMob3B0aW9ucywge1xuICAgICAgICBza2lwT3B0aW9uVmFsdWVUeXBlQ29udmVyc2lvbjogdHJ1ZSxcblxuICAgICAgICBhc3luYyBvbk9wdGlvblBhcnNlZCAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGlmICgha2V5IHx8ICF2YWx1ZSlcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLm9wdGlvblZhbHVlSXNOb3RWYWxpZEtleVZhbHVlLCBvcHRpb25OYW1lKTtcblxuICAgICAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZSk7XG4gICAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB2YWxpZGF0ZVF1YXJhbnRpbmVPcHRpb25zKHBhcnNlZE9wdGlvbnMsIG9wdGlvbk5hbWUpO1xuXG4gICAgcmV0dXJuIHBhcnNlZE9wdGlvbnM7XG59XG5cblxuaW50ZXJmYWNlIEF0dGVtcHRSZXN1bHQge1xuICAgIGZhaWxlZFRpbWVzOiBudW1iZXI7XG4gICAgcGFzc2VkVGltZXM6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFF1YXJhbnRpbmVBdHRlbXB0IHtcbiAgICB0ZXN0UnVuSWQ6IHN0cmluZztcbiAgICBlcnJvcnM6IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlcltdO1xufVxuXG5leHBvcnQgY2xhc3MgUXVhcmFudGluZSB7XG4gICAgcHVibGljIGF0dGVtcHRzOiBRdWFyYW50aW5lQXR0ZW1wdFtdO1xuICAgIHB1YmxpYyBhdHRlbXB0TGltaXQ6IG51bWJlcjtcbiAgICBwdWJsaWMgc3VjY2Vzc1RocmVzaG9sZDogbnVtYmVyO1xuICAgIHB1YmxpYyBmYWlsdXJlVGhyZXNob2xkOiBudW1iZXI7XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKCkge1xuICAgICAgICB0aGlzLmF0dGVtcHRzICAgICAgICAgPSBbXTtcbiAgICAgICAgdGhpcy5hdHRlbXB0TGltaXQgICAgID0gREVGQVVMVF9BVFRFTVBUX0xJTUlUO1xuICAgICAgICB0aGlzLnN1Y2Nlc3NUaHJlc2hvbGQgPSBERUZBVUxUX1RIUkVTSE9MRDtcbiAgICAgICAgdGhpcy5mYWlsdXJlVGhyZXNob2xkID0gREVGQVVMVF9USFJFU0hPTEQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEZhaWxlZEF0dGVtcHRzICgpOiBRdWFyYW50aW5lQXR0ZW1wdFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0ZW1wdHMuZmlsdGVyKCh7IGVycm9ycyB9KSA9PiAhIWVycm9ycy5sZW5ndGgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRQYXNzZWRBdHRlbXB0cyAoKTogUXVhcmFudGluZUF0dGVtcHRbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dGVtcHRzLmZpbHRlcigoeyBlcnJvcnMgfSkgPT4gZXJyb3JzLmxlbmd0aCA9PT0gMCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldEN1c3RvbVBhcmFtZXRlcnMgKGF0dGVtcHRMaW1pdDogbnVtYmVyIHwgdW5kZWZpbmVkLCBzdWNjZXNzVGhyZXNob2xkOiBudW1iZXIgfCB1bmRlZmluZWQpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgbmVlZFRvVXBkYXRlVGVzdFJ1blRocmVzaG9sZCAgICAgICAgICA9IHR5cGVvZiBhdHRlbXB0TGltaXQgPT09ICdudW1iZXInO1xuICAgICAgICBjb25zdCBuZWVkVG9VcGRhdGVQYXNzZWRRdWFyYW50aW5lVGhyZXNob2xkID0gdHlwZW9mIHN1Y2Nlc3NUaHJlc2hvbGQgPT09ICdudW1iZXInO1xuICAgICAgICBjb25zdCBuZWVkVG9SZWNhbGN1bGF0ZUZhaWxlZFRocmVzaG9sZCAgICAgID0gbmVlZFRvVXBkYXRlVGVzdFJ1blRocmVzaG9sZCB8fCBuZWVkVG9VcGRhdGVQYXNzZWRRdWFyYW50aW5lVGhyZXNob2xkO1xuXG4gICAgICAgIGlmIChuZWVkVG9VcGRhdGVUZXN0UnVuVGhyZXNob2xkKSB0aGlzLmF0dGVtcHRMaW1pdCA9IGF0dGVtcHRMaW1pdCBhcyBudW1iZXI7XG4gICAgICAgIGlmIChuZWVkVG9VcGRhdGVQYXNzZWRRdWFyYW50aW5lVGhyZXNob2xkKSB0aGlzLnN1Y2Nlc3NUaHJlc2hvbGQgPSBzdWNjZXNzVGhyZXNob2xkIGFzIG51bWJlcjtcbiAgICAgICAgaWYgKG5lZWRUb1JlY2FsY3VsYXRlRmFpbGVkVGhyZXNob2xkKSB0aGlzLl9zZXRGYWlsZWRUaHJlc2hvbGQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TmV4dEF0dGVtcHROdW1iZXIgKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dGVtcHRzLmxlbmd0aCArIDE7XG4gICAgfVxuXG4gICAgcHVibGljIGlzVGhyZXNob2xkUmVhY2hlZCAoZXh0cmFFcnJvcnM/OiBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXJbXSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCB7IHBhc3NlZFRpbWVzLCBmYWlsZWRUaW1lcyB9ID0gdGhpcy5fZ2V0QXR0ZW1wdHNSZXN1bHQoZXh0cmFFcnJvcnMpO1xuXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NUaHJlc2hvbGRSZWFjaGVkID0gcGFzc2VkVGltZXMgPj0gdGhpcy5zdWNjZXNzVGhyZXNob2xkO1xuICAgICAgICBjb25zdCBmYWlsdXJlVGhyZXNob2xkUmVhY2hlZCA9IGZhaWxlZFRpbWVzID49IHRoaXMuZmFpbHVyZVRocmVzaG9sZDtcblxuICAgICAgICByZXR1cm4gc3VjY2Vzc1RocmVzaG9sZFJlYWNoZWQgfHwgZmFpbHVyZVRocmVzaG9sZFJlYWNoZWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGlzRmlyc3RBdHRlbXB0U3VjY2Vzc2Z1bCAoZXh0cmFFcnJvcnM6IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlcltdKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHsgZmFpbGVkVGltZXMsIHBhc3NlZFRpbWVzIH0gPSB0aGlzLl9nZXRBdHRlbXB0c1Jlc3VsdChleHRyYUVycm9ycyk7XG5cbiAgICAgICAgcmV0dXJuIGZhaWxlZFRpbWVzID09PSAwICYmIHBhc3NlZFRpbWVzID4gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRBdHRlbXB0c1Jlc3VsdCAoZXh0cmFFcnJvcnM/OiBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXJbXSk6IEF0dGVtcHRSZXN1bHQge1xuICAgICAgICBsZXQgZmFpbGVkVGltZXMgPSB0aGlzLmdldEZhaWxlZEF0dGVtcHRzKCkubGVuZ3RoO1xuICAgICAgICBsZXQgcGFzc2VkVGltZXMgPSB0aGlzLmdldFBhc3NlZEF0dGVtcHRzKCkubGVuZ3RoO1xuXG4gICAgICAgIGlmIChleHRyYUVycm9ycykge1xuICAgICAgICAgICAgaWYgKGV4dHJhRXJyb3JzLmxlbmd0aClcbiAgICAgICAgICAgICAgICBmYWlsZWRUaW1lcyArPSBleHRyYUVycm9ycy5sZW5ndGg7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcGFzc2VkVGltZXMgKz0gMTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7IGZhaWxlZFRpbWVzLCBwYXNzZWRUaW1lcyB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NldEZhaWxlZFRocmVzaG9sZCAoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZmFpbHVyZVRocmVzaG9sZCA9IHRoaXMuYXR0ZW1wdExpbWl0IC0gdGhpcy5zdWNjZXNzVGhyZXNob2xkICsgMTtcbiAgICB9XG59XG4iXX0=