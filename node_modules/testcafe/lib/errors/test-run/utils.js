"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderDiff = exports.markup = exports.shouldSkipCallsite = exports.replaceLeadingSpacesWithNbsp = exports.formatExpressionMessage = exports.formatSelectorCallstack = exports.formatUrl = exports.renderForbiddenCharsList = void 0;
const dedent_1 = __importDefault(require("dedent"));
const lodash_1 = require("lodash");
const phase_1 = __importDefault(require("../../test-run/phase"));
const types_1 = require("../types");
const SUBTITLES = {
    [phase_1.default.initial]: '',
    [phase_1.default.inTestRunBeforeHook]: '<span class="subtitle">Error in testRun.before hook</span>\n',
    [phase_1.default.inFixtureBeforeHook]: '<span class="subtitle">Error in fixture.before hook</span>\n',
    [phase_1.default.inFixtureBeforeEachHook]: '<span class="subtitle">Error in fixture.beforeEach hook</span>\n',
    [phase_1.default.inTestBeforeHook]: '<span class="subtitle">Error in test.before hook</span>\n',
    [phase_1.default.inTest]: '',
    [phase_1.default.inTestAfterHook]: '<span class="subtitle">Error in test.after hook</span>\n',
    [phase_1.default.inFixtureAfterEachHook]: '<span class="subtitle">Error in fixture.afterEach hook</span>\n',
    [phase_1.default.inFixtureAfterHook]: '<span class="subtitle">Error in fixture.after hook</span>\n',
    [phase_1.default.inTestRunAfterHook]: '<span class="subtitle">Error in testRun.after hook</span>\n',
    [phase_1.default.inRoleInitializer]: '<span class="subtitle">Error in Role initializer</span>\n',
    [phase_1.default.inBookmarkRestore]: '<span class="subtitle">Error while restoring configuration after Role switch</span>\n',
};
function renderForbiddenCharsList(forbiddenCharsList) {
    return forbiddenCharsList.map(charInfo => `\t"${charInfo.chars}" at index ${charInfo.index}\n`).join('');
}
exports.renderForbiddenCharsList = renderForbiddenCharsList;
function formatUrl(url) {
    return `<a href="${url}">${url}</a>`;
}
exports.formatUrl = formatUrl;
function formatSelectorCallstack(apiFnChain, apiFnIndex, viewportWidth) {
    if (typeof apiFnIndex === 'undefined')
        return '';
    const emptySpaces = 10;
    const ellipsis = '...)';
    const availableWidth = viewportWidth - emptySpaces;
    return apiFnChain.map((apiFn, index) => {
        let formattedApiFn = String.fromCharCode(160);
        formattedApiFn += index === apiFnIndex ? '>' : ' ';
        formattedApiFn += ' | ';
        formattedApiFn += index !== 0 ? '  ' : '';
        formattedApiFn += apiFn;
        if (formattedApiFn.length > availableWidth)
            return formattedApiFn.substr(0, availableWidth - emptySpaces) + ellipsis;
        return formattedApiFn;
    }).join('\n');
}
exports.formatSelectorCallstack = formatSelectorCallstack;
function formatExpressionMessage(expression, line, column) {
    const expressionStr = lodash_1.escape(expression);
    if (line === void 0 || column === void 0)
        return expressionStr;
    return `${expressionStr}\nat ${line}:${column}`;
}
exports.formatExpressionMessage = formatExpressionMessage;
function replaceLeadingSpacesWithNbsp(str) {
    return str.replace(/^ +/mg, match => {
        return lodash_1.repeat('&nbsp;', match.length);
    });
}
exports.replaceLeadingSpacesWithNbsp = replaceLeadingSpacesWithNbsp;
function shouldSkipCallsite(err) {
    return err.code === types_1.TEST_RUN_ERRORS.uncaughtNonErrorObjectInTestCode ||
        err.code === types_1.TEST_RUN_ERRORS.unhandledPromiseRejection ||
        err.code === types_1.TEST_RUN_ERRORS.uncaughtException;
}
exports.shouldSkipCallsite = shouldSkipCallsite;
function markup(err, msgMarkup, errCallsite = '') {
    msgMarkup = dedent_1.default(`${SUBTITLES[err.testRunPhase]}<div class="message">${dedent_1.default(msgMarkup)}</div>`);
    const browserStr = `\n\n<strong>Browser:</strong> <span class="user-agent">${err.userAgent}</span>`;
    if (errCallsite)
        msgMarkup += `${browserStr}\n\n${errCallsite}\n`;
    else
        msgMarkup += browserStr;
    if (err.screenshotPath)
        msgMarkup += `\n<div class="screenshot-info"><strong>Screenshot:</strong> <a class="screenshot-path">${lodash_1.escape(err.screenshotPath)}</a></div>`;
    if (!shouldSkipCallsite(err)) {
        const callsiteMarkup = err.getCallsiteMarkup();
        if (callsiteMarkup)
            msgMarkup += `\n\n${callsiteMarkup}`;
    }
    return msgMarkup.replace('\t', '&nbsp;'.repeat(4));
}
exports.markup = markup;
function renderDiff(diff) {
    return diff ?
        `<span class="diff-added">+ expected</span> <span class="diff-removed">- actual</span>\n\n${diff}` : ``;
}
exports.renderDiff = renderDiff;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZXJyb3JzL3Rlc3QtcnVuL3V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG9EQUE0QjtBQUM1QixtQ0FBc0Q7QUFDdEQsaUVBQWtEO0FBQ2xELG9DQUEyQztBQUUzQyxNQUFNLFNBQVMsR0FBRztJQUNkLENBQUMsZUFBYyxDQUFDLE9BQU8sQ0FBQyxFQUFrQixFQUFFO0lBQzVDLENBQUMsZUFBYyxDQUFDLG1CQUFtQixDQUFDLEVBQU0sOERBQThEO0lBQ3hHLENBQUMsZUFBYyxDQUFDLG1CQUFtQixDQUFDLEVBQU0sOERBQThEO0lBQ3hHLENBQUMsZUFBYyxDQUFDLHVCQUF1QixDQUFDLEVBQUUsa0VBQWtFO0lBQzVHLENBQUMsZUFBYyxDQUFDLGdCQUFnQixDQUFDLEVBQVMsMkRBQTJEO0lBQ3JHLENBQUMsZUFBYyxDQUFDLE1BQU0sQ0FBQyxFQUFtQixFQUFFO0lBQzVDLENBQUMsZUFBYyxDQUFDLGVBQWUsQ0FBQyxFQUFVLDBEQUEwRDtJQUNwRyxDQUFDLGVBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFHLGlFQUFpRTtJQUMzRyxDQUFDLGVBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFPLDZEQUE2RDtJQUN2RyxDQUFDLGVBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFPLDZEQUE2RDtJQUN2RyxDQUFDLGVBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFRLDJEQUEyRDtJQUNyRyxDQUFDLGVBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFRLHVGQUF1RjtDQUNwSSxDQUFDO0FBRUYsU0FBZ0Isd0JBQXdCLENBQUUsa0JBQWtCO0lBQ3hELE9BQU8sa0JBQWtCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxRQUFRLENBQUMsS0FBSyxjQUFjLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMs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QUFJLDBGQUEwRixlQUFVLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUM7SUFFdEosSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxFQUFFO1FBQzFCLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRS9DLElBQUksY0FBYztZQUNkLFNBQVMsSUFBSSxPQUFPLGNBQWMsRUFBRSxDQUFDO0tBQzVDO0lBRUQsT0FBTyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkQsQ0FBQztBQXJCRCx3QkFxQkM7QUFFRCxTQUFnQixVQUFVLENBQUUsSUFBSTtJQUM1QixPQUFPLElBQUksQ0FBQyxDQUFDO1FBQ1QsNEZBQTRGLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDaEgsQ0FBQztBQUhELGdDQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlZGVudCBmcm9tICdkZWRlbnQnO1xuaW1wb3J0IHsgZXNjYXBlIGFzIGVzY2FwZUh0bWwsIHJlcGVhdCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgVEVTVF9SVU5fUEhBU0UgZnJvbSAnLi4vLi4vdGVzdC1ydW4vcGhhc2UnO1xuaW1wb3J0IHsgVEVTVF9SVU5fRVJST1JTIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5jb25zdCBTVUJUSVRMRVMgPSB7XG4gICAgW1RFU1RfUlVOX1BIQVNFLmluaXRpYWxdOiAgICAgICAgICAgICAgICAgJycsXG4gICAgW1RFU1RfUlVOX1BIQVNFLmluVGVzdFJ1bkJlZm9yZUhvb2tdOiAgICAgJzxzcGFuIGNsYXNzPVwic3VidGl0bGVcIj5FcnJvciBpbiB0ZXN0UnVuLmJlZm9yZSBob29rPC9zcGFuPlxcbicsXG4gICAgW1RFU1RfUlVOX1BIQVNFLmluRml4dHVyZUJlZm9yZUhvb2tdOiAgICAgJzxzcGFuIGNsYXNzPVwic3VidGl0bGVcIj5FcnJvciBpbiBmaXh0dXJlLmJlZm9yZSBob29rPC9zcGFuPlxcbicsXG4gICAgW1RFU1RfUlVOX1BIQVNFLmluRml4dHVyZUJlZm9yZUVhY2hIb29rXTogJzxzcGFuIGNsYXNzPVwic3VidGl0bGVcIj5FcnJvciBpbiBmaXh0dXJlLmJlZm9yZUVhY2ggaG9vazwvc3Bhbj5cXG4nLFxuICAgIFtURVNUX1JVTl9QSEFTRS5pblRlc3RCZWZvcmVIb29rXTogICAgICAgICc8c3BhbiBjbGFzcz1cInN1YnRpdGxlXCI+RXJyb3IgaW4gdGVzdC5iZWZvcmUgaG9vazwvc3Bhbj5cXG4nLFxuICAgIFtURVNUX1JVTl9QSEFTRS5pblRlc3RdOiAgICAgICAgICAgICAgICAgICcnLFxuICAgIFtURVNUX1JVTl9QSEFTRS5pblRlc3RBZnRlckhvb2tdOiAgICAgICAgICc8c3BhbiBjbGFzcz1cInN1YnRpdGxlXCI+RXJyb3IgaW4gdGVzdC5hZnRlciBob29rPC9zcGFuPlxcbicsXG4gICAgW1RFU1RfUlVOX1BIQVNFLmluRml4dHVyZUFmdGVyRWFjaEhvb2tdOiAgJzxzcGFuIGNsYXNzPVwic3VidGl0bGVcIj5FcnJvciBpbiBmaXh0dXJlLmFmdGVyRWFjaCBob29rPC9zcGFuPlxcbicsXG4gICAgW1RFU1RfUlVOX1BIQVNFLmluRml4dHVyZUFmdGVySG9va106ICAgICAgJzxzcGFuIGNsYXNzPVwic3VidGl0bGVcIj5FcnJvciBpbiBmaXh0dXJlLmFmdGVyIGhvb2s8L3NwYW4+XFxuJyxcbiAgICBbVEVTVF9SVU5fUEhBU0UuaW5UZXN0UnVuQWZ0ZXJIb29rXTogICAgICAnPHNwYW4gY2xhc3M9XCJzdWJ0aXRsZVwiPkVycm9yIGluIHRlc3RSdW4uYWZ0ZXIgaG9vazwvc3Bhbj5cXG4nLFxuICAgIFtURVNUX1JVTl9QSEFTRS5pblJvbGVJbml0aWFsaXplcl06ICAgICAgICc8c3BhbiBjbGFzcz1cInN1YnRpdGxlXCI+RXJyb3IgaW4gUm9sZSBpbml0aWFsaXplcjwvc3Bhbj5cXG4nLFxuICAgIFtURVNUX1JVTl9QSEFTRS5pbkJvb2ttYXJrUmVzdG9yZV06ICAgICAgICc8c3BhbiBjbGFzcz1cInN1YnRpdGxlXCI+RXJyb3Igd2hpbGUgcmVzdG9yaW5nIGNvbmZpZ3VyYXRpb24gYWZ0ZXIgUm9sZSBzd2l0Y2g8L3NwYW4+XFxuJyxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJGb3JiaWRkZW5DaGFyc0xpc3QgKGZvcmJpZGRlbkNoYXJzTGlzdCkge1xuICAgIHJldHVybiBmb3JiaWRkZW5DaGFyc0xpc3QubWFwKGNoYXJJbmZvID0+IGBcXHRcIiR7Y2hhckluZm8uY2hhcnN9XCIgYXQgaW5kZXggJHtjaGFySW5mby5pbmRleH1cXG5gKS5qb2luKCcnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFVybCAodXJsKSB7XG4gICAgcmV0dXJuIGA8YSBocmVmPVwiJHt1cmx9XCI+JHt1cmx9PC9hPmA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXRTZWxlY3RvckNhbGxzdGFjayAoYXBpRm5DaGFpbiwgYXBpRm5JbmRleCwgdmlld3BvcnRXaWR0aCkge1xuICAgIGlmICh0eXBlb2YgYXBpRm5JbmRleCA9PT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgIHJldHVybiAnJztcblxuICAgIGNvbnN0IGVtcHR5U3BhY2VzICAgID0gMTA7XG4gICAgY29uc3QgZWxsaXBzaXMgICAgICAgPSAnLi4uKSc7XG4gICAgY29uc3QgYXZhaWxhYmxlV2lkdGggPSB2aWV3cG9ydFdpZHRoIC0gZW1wdHlTcGFjZXM7XG5cbiAgICByZXR1cm4gYXBpRm5DaGFpbi5tYXAoKGFwaUZuLCBpbmRleCkgPT4ge1xuICAgICAgICBsZXQgZm9ybWF0dGVkQXBpRm4gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDE2MCk7XG5cbiAgICAgICAgZm9ybWF0dGVkQXBpRm4gKz0gaW5kZXggPT09IGFwaUZuSW5kZXggPyAnPicgOiAnICc7XG4gICAgICAgIGZvcm1hdHRlZEFwaUZuICs9ICcgfCAnO1xuICAgICAgICBmb3JtYXR0ZWRBcGlGbiArPSBpbmRleCAhPT0gMCA/ICcgICcgOiAnJztcbiAgICAgICAgZm9ybWF0dGVkQXBpRm4gKz0gYXBpRm47XG5cbiAgICAgICAgaWYgKGZvcm1hdHRlZEFwaUZuLmxlbmd0aCA+IGF2YWlsYWJsZVdpZHRoKVxuICAgICAgICAgICAgcmV0dXJuIGZvcm1hdHRlZEFwaUZuLnN1YnN0cigwLCBhdmFpbGFibGVXaWR0aCAtIGVtcHR5U3BhY2VzKSArIGVsbGlwc2lzO1xuXG4gICAgICAgIHJldHVybiBmb3JtYXR0ZWRBcGlGbjtcbiAgICB9KS5qb2luKCdcXG4nKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdEV4cHJlc3Npb25NZXNzYWdlIChleHByZXNzaW9uLCBsaW5lLCBjb2x1bW4pIHtcbiAgICBjb25zdCBleHByZXNzaW9uU3RyID0gZXNjYXBlSHRtbChleHByZXNzaW9uKTtcblxuICAgIGlmIChsaW5lID09PSB2b2lkIDAgfHwgY29sdW1uID09PSB2b2lkIDApXG4gICAgICAgIHJldHVybiBleHByZXNzaW9uU3RyO1xuXG4gICAgcmV0dXJuIGAke2V4cHJlc3Npb25TdHJ9XFxuYXQgJHtsaW5lfToke2NvbHVtbn1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZUxlYWRpbmdTcGFjZXNXaXRoTmJzcCAoc3RyKSB7XG4gICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9eICsvbWcsIG1hdGNoID0+IHtcbiAgICAgICAgcmV0dXJuIHJlcGVhdCgnJm5ic3A7JywgbWF0Y2gubGVuZ3RoKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNob3VsZFNraXBDYWxsc2l0ZSAoZXJyKSB7XG4gICAgcmV0dXJuIGVyci5jb2RlID09PSBURVNUX1JVTl9FUlJPUlMudW5jYXVnaHROb25FcnJvck9iamVjdEluVGVzdENvZGUgfHxcbiAgICAgICAgICAgZXJyLmNvZGUgPT09IFRFU1RfUlVOX0VSUk9SUy51bmhhbmRsZWRQcm9taXNlUmVqZWN0aW9uIHx8XG4gICAgICAgICAgIGVyci5jb2RlID09PSBURVNUX1JVTl9FUlJPUlMudW5jYXVnaHRFeGNlcHRpb247XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXJrdXAgKGVyciwgbXNnTWFya3VwLCBlcnJDYWxsc2l0ZSA9ICcnKSB7XG4gICAgbXNnTWFya3VwID0gZGVkZW50KGAke1NVQlRJVExFU1tlcnIudGVzdFJ1blBoYXNlXX08ZGl2IGNsYXNzPVwibWVzc2FnZVwiPiR7ZGVkZW50KG1zZ01hcmt1cCl9PC9kaXY+YCk7XG5cbiAgICBjb25zdCBicm93c2VyU3RyID0gYFxcblxcbjxzdHJvbmc+QnJvd3Nlcjo8L3N0cm9uZz4gPHNwYW4gY2xhc3M9XCJ1c2VyLWFnZW50XCI+JHtlcnIudXNlckFnZW50fTwvc3Bhbj5gO1xuXG4gICAgaWYgKGVyckNhbGxzaXRlKVxuICAgICAgICBtc2dNYXJrdXAgKz0gYCR7YnJvd3NlclN0cn1cXG5cXG4ke2VyckNhbGxzaXRlfVxcbmA7XG4gICAgZWxzZVxuICAgICAgICBtc2dNYXJrdXAgKz0gYnJvd3NlclN0cjtcblxuICAgIGlmIChlcnIuc2NyZWVuc2hvdFBhdGgpXG4gICAgICAgIG1zZ01hcmt1cCArPSBgXFxuPGRpdiBjbGFzcz1cInNjcmVlbnNob3QtaW5mb1wiPjxzdHJvbmc+U2NyZWVuc2hvdDo8L3N0cm9uZz4gPGEgY2xhc3M9XCJzY3JlZW5zaG90LXBhdGhcIj4ke2VzY2FwZUh0bWwoZXJyLnNjcmVlbnNob3RQYXRoKX08L2E+PC9kaXY+YDtcblxuICAgIGlmICghc2hvdWxkU2tpcENhbGxzaXRlKGVycikpIHtcbiAgICAgICAgY29uc3QgY2FsbHNpdGVNYXJrdXAgPSBlcnIuZ2V0Q2FsbHNpdGVNYXJrdXAoKTtcblxuICAgICAgICBpZiAoY2FsbHNpdGVNYXJrdXApXG4gICAgICAgICAgICBtc2dNYXJrdXAgKz0gYFxcblxcbiR7Y2FsbHNpdGVNYXJrdXB9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gbXNnTWFya3VwLnJlcGxhY2UoJ1xcdCcsICcmbmJzcDsnLnJlcGVhdCg0KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJEaWZmIChkaWZmKSB7XG4gICAgcmV0dXJuIGRpZmYgP1xuICAgICAgICBgPHNwYW4gY2xhc3M9XCJkaWZmLWFkZGVkXCI+KyBleHBlY3RlZDwvc3Bhbj4gPHNwYW4gY2xhc3M9XCJkaWZmLXJlbW92ZWRcIj4tIGFjdHVhbDwvc3Bhbj5cXG5cXG4ke2RpZmZ9YCA6IGBgO1xufVxuIl19