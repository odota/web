"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const temp_directory_1 = __importDefault(require("../../../../../utils/temp-directory"));
const promisified_functions_1 = require("../../../../../utils/promisified-functions");
const mime_db_1 = __importDefault(require("mime-db"));
function getMimeTypes() {
    const mimeTypes = Object.keys(mime_db_1.default);
    return mimeTypes.filter(mimeType => {
        // @ts-ignore: Export of the 'mime-db' module has no index signature.
        const { extensions } = mime_db_1.default[mimeType];
        return extensions && extensions.length;
    }).join(',');
}
async function generatePreferences(profileDir, { marionettePort, config }) {
    const prefsFileName = path_1.default.join(profileDir, 'user.js');
    const mimeTypes = getMimeTypes();
    let prefs = [
        'user_pref("browser.link.open_newwindow.override.external", 2);',
        'user_pref("app.update.enabled", false);',
        'user_pref("app.update.auto", false);',
        'user_pref("app.update.mode", 0);',
        'user_pref("app.update.service.enabled", false);',
        'user_pref("browser.shell.checkDefaultBrowser", false);',
        'user_pref("browser.usedOnWindows10", true);',
        'user_pref("browser.rights.3.shown", true);',
        'user_pref("browser.startup.homepage_override.mstone","ignore");',
        'user_pref("browser.tabs.warnOnCloseOtherTabs", false);',
        'user_pref("browser.tabs.warnOnClose", false);',
        'user_pref("browser.sessionstore.resume_from_crash", false);',
        `user_pref("browser.helperApps.neverAsk.saveToDisk", "${mimeTypes}");`,
        `user_pref("pdfjs.disabled", true);`,
        'user_pref("toolkit.telemetry.reportingpolicy.firstRun", false);',
        'user_pref("toolkit.telemetry.enabled", false);',
        'user_pref("toolkit.telemetry.rejected", true);',
        'user_pref("datareporting.healthreport.uploadEnabled", false);',
        'user_pref("datareporting.healthreport.service.enabled", false);',
        'user_pref("datareporting.healthreport.service.firstRun", false);',
        'user_pref("datareporting.policy.dataSubmissionEnabled", false);',
        'user_pref("datareporting.policy.dataSubmissionPolicyBypassNotification", true);',
        'user_pref("app.shield.optoutstudies.enabled", false);',
        'user_pref("extensions.shield-recipe-client.enabled", false);',
        'user_pref("extensions.shield-recipe-client.first_run", false);',
        'user_pref("extensions.shield-recipe-client.startupExperimentPrefs.browser.newtabpage.activity-stream.enabled", false);',
        'user_pref("devtools.toolbox.host", "window");',
        'user_pref("devtools.toolbox.previousHost", "bottom");',
        'user_pref("signon.rememberSignons", false);',
        // NOTE: dom.min_background_timeout_value should be equal to dom.min_timeout_value
        'user_pref("dom.min_background_timeout_value", 4);',
        'user_pref("dom.timeout.throttling_delay", 0);',
        'user_pref("dom.timeout.budget_throttling_max_delay", 0);',
        // NOTE: We set the foreground configuration for the background budget throttling parameters
        'user_pref("dom.timeout.background_throttling_max_budget", -1);',
        'user_pref("dom.timeout.background_budget_regeneration_rate", 1);',
        'user_pref("security.enterprise_roots.enabled", true);',
    ];
    if (marionettePort) {
        prefs = prefs.concat([
            `user_pref("marionette.port", ${marionettePort});`,
            'user_pref("marionette.enabled", true);',
        ]);
    }
    if (config.disableMultiprocessing) {
        prefs = prefs.concat([
            'user_pref("browser.tabs.remote.autostart", false);',
            'user_pref("browser.tabs.remote.autostart.2", false);',
        ]);
    }
    mimeTypes.split(',').forEach(mimeType => {
        const type = mimeType.split('/')[1];
        prefs.push(`user_pref("browser.download.viewableInternally.typeWasRegistered.${type}", true);`);
    });
    await promisified_functions_1.writeFile(prefsFileName, prefs.join('\n'));
}
async function writeHandlersFile(profileDir) {
    // NOTE: The definitions of actions are there https://searchfox.org/mozilla-release/source/netwerk/mime/nsIMIMEInfo.idl#115
    const handlersFileName = path_1.default.join(profileDir, 'handlers.json');
    const handlers = {
        defaultHandlersVersion: {
            ru: 5,
        },
        mimeTypes: {
            'application/pdf': {
                action: 0,
                extensions: [
                    'pdf',
                ],
            },
            'text/xml': {
                action: 0,
                extensions: [
                    'xml',
                    'xsl',
                    'xbl',
                ],
            },
            'image/svg+xml': {
                action: 0,
                extensions: [
                    'svg',
                ],
            },
            'image/webp': {
                action: 0,
                extensions: [
                    'webp',
                ],
            },
        },
        schemes: {},
    };
    await promisified_functions_1.writeFile(handlersFileName, JSON.stringify(handlers));
}
async function default_1(runtimeInfo) {
    const tmpDir = await temp_directory_1.default.createDirectory('firefox-profile');
    await generatePreferences(tmpDir.path, runtimeInfo);
    await writeHandlersFile(tmpDir.path);
    return tmpDir;
}
exports.default = default_1;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXRlbXAtcHJvZmlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9maXJlZm94L2NyZWF0ZS10ZW1wLXByb2ZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxnREFBd0I7QUFDeEIseUZBQWdFO0FBQ2hFLHNGQUF1RTtBQUN2RSxzREFBeUI7QUFFekIsU0FBUyxZQUFZO0lBQ2pCLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQUUsQ0FBQyxDQUFDO0lBRWxDLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUMvQixxRUFBcUU7UUFDckUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLGlCQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFcEMsT0FBTyxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDakIsQ0FBQztBQUVELEtBQUssVUFBVSxtQkFBbUIsQ0FBRSxVQUFrQixFQUFFLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBMkM7SUFDdkgsTUFBTSxhQUFhLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDdkQsTUFBTSxTQUFTLEdBQUcsWUFBWSxFQUFFLENBQUM7SUFFakMsSUFBSSxLQUFLLEdBQUc7UUFDUixnRUFBZ0U7UUFDaEUseUNBQXlDO1FBQ3pDLHNDQUFzQztRQUN0QyxrQ0FBa0M7UUFDbEMsaURBQWlEO1FBQ2pELHdEQUF3RDtRQUN4RCw2Q0FBNkM7UUFDN0MsNENBQTRDO1FBQzVDLGlFQUFpRTtRQUNqRSx3REFBd0Q7UUFDeEQsK0NBQStDO1FBQy9DLDZEQUE2RDtRQUM3RCx3REFBd0QsU0FBUyxLQUFLO1FBQ3RFLG9DQUFvQztRQUNwQyxpRUFBaUU7UUFDakUsZ0RBQWdEO1FBQ2hELGdEQUFnRDtRQUNoRCwrREFBK0Q7UUFDL0QsaUVBQWlFO1FBQ2pFLGtFQUFrRTtRQUNsRSxpRUFBaUU7UUFDakUsaUZBQWlGO1FBQ2pGLHVEQUF1RDtRQUN2RCw4REFBOEQ7UUFDOUQsZ0VBQWdFO1FBQ2hFLHdIQUF3SDtRQUN4SCwrQ0FBK0M7UUFDL0MsdURBQXVEO1FBQ3ZELDZDQUE2QztRQUM3QyxrRkFBa0Y7UUFDbEYsbURBQW1EO1FBQ25ELCtDQUErQztRQUMvQywwREFBMEQ7UUFDMUQsNEZBQTRGO1FBQzVGLGdFQUFnRTtRQUNoRSxrRUFBa0U7UUFDbEUsdURBQXVEO0tBQzFELENBQUM7SUFFRixJQUFJLGNBQWMsRUFBRTtRQUNoQixLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztZQUNqQixnQ0FBZ0MsY0FBYyxJQUFJO1lBQ2xELHdDQUF3QztTQUMzQyxDQUFDLENBQUM7S0FDTjtJQUVELElBQUksTUFBTSxDQUFDLHNCQUFzQixFQUFFO1FBQy9CLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ2pCLG9EQUFvRDtZQUNwRCxzREFBc0Q7U0FDekQsQ0FBQyxDQUFDO0tBQ047SUFFRCxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUNwQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXBDLEtBQUssQ0FBQyxJQUFJLENBQUMsb0VBQW9FLElBQUksV0FBVyxDQUFDLENBQUM7SUFDcEcsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLGlDQUFTLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNyRCxDQUFDO0FBRUQsS0FBSyxVQUFVLGlCQUFpQixDQUFFLFVBQWtCO0lBQ2hELDJIQUEySDtJQUMzSCxNQUFNLGdCQUFnQixHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0lBQ2hFLE1BQU0sUUFBUSxHQUFXO1FBQ3JCLHNCQUFzQixFQUFFO1lBQ3BCLEVBQUUsRUFBRSxDQUFDO1NBQ1I7UUFDRCxTQUFTLEVBQUU7WUFDUCxpQkFBaUIsRUFBRTtnQkFDZixNQUFNLEVBQU0sQ0FBQztnQkFDYixVQUFVLEVBQUU7b0JBQ1IsS0FBSztpQkFDUjthQUNKO1lBQ0QsVUFBVSxFQUFFO2dCQUNSLE1BQU0sRUFBTSxDQUFDO2dCQUNiLFVBQVUsRUFBRTtvQkFDUixLQUFLO29CQUNMLEtBQUs7b0JBQ0wsS0FBSztpQkFDUjthQUNKO1lBQ0QsZUFBZSxFQUFFO2dCQUNiLE1BQU0sRUFBTSxDQUFDO2dCQUNiLFVBQVUsRUFBRTtvQkFDUixLQUFLO2lCQUNSO2FBQ0o7WUFDRCxZQUFZLEVBQUU7Z0JBQ1YsTUFBTSxFQUFNLENBQUM7Z0JBQ2IsVUFBVSxFQUFFO29CQUNSLE1BQU07aUJBQ1Q7YUFDSjtTQUNKO1FBQ0QsT0FBTyxFQUFFLEVBQUU7S0FDZCxDQUFDO0lBRUYsTUFBTSxpQ0FBUyxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUNoRSxDQUFDO0FBR2MsS0FBSyxvQkFBVyxXQUFnQjtJQUMzQyxNQUFNLE1BQU0sR0FBRyxNQUFNLHdCQUFhLENBQUMsZUFBZSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFFdEUsTUFBTSxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3BELE1BQU0saUJBQWlCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXJDLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFQRCw0QkFPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFRlbXBEaXJlY3RvcnkgZnJvbSAnLi4vLi4vLi4vLi4vLi4vdXRpbHMvdGVtcC1kaXJlY3RvcnknO1xuaW1wb3J0IHsgd3JpdGVGaWxlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vdXRpbHMvcHJvbWlzaWZpZWQtZnVuY3Rpb25zJztcbmltcG9ydCBkYiBmcm9tICdtaW1lLWRiJztcblxuZnVuY3Rpb24gZ2V0TWltZVR5cGVzICgpOiBzdHJpbmcge1xuICAgIGNvbnN0IG1pbWVUeXBlcyA9IE9iamVjdC5rZXlzKGRiKTtcblxuICAgIHJldHVybiBtaW1lVHlwZXMuZmlsdGVyKG1pbWVUeXBlID0+IHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZTogRXhwb3J0IG9mIHRoZSAnbWltZS1kYicgbW9kdWxlIGhhcyBubyBpbmRleCBzaWduYXR1cmUuXG4gICAgICAgIGNvbnN0IHsgZXh0ZW5zaW9ucyB9ID0gZGJbbWltZVR5cGVdO1xuXG4gICAgICAgIHJldHVybiBleHRlbnNpb25zICYmIGV4dGVuc2lvbnMubGVuZ3RoO1xuICAgIH0pLmpvaW4oJywnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVQcmVmZXJlbmNlcyAocHJvZmlsZURpcjogc3RyaW5nLCB7IG1hcmlvbmV0dGVQb3J0LCBjb25maWcgfTogeyBtYXJpb25ldHRlUG9ydDogbnVtYmVyOyBjb25maWc6IGFueSB9KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcHJlZnNGaWxlTmFtZSA9IHBhdGguam9pbihwcm9maWxlRGlyLCAndXNlci5qcycpO1xuICAgIGNvbnN0IG1pbWVUeXBlcyA9IGdldE1pbWVUeXBlcygpO1xuXG4gICAgbGV0IHByZWZzID0gW1xuICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci5saW5rLm9wZW5fbmV3d2luZG93Lm92ZXJyaWRlLmV4dGVybmFsXCIsIDIpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJhcHAudXBkYXRlLmVuYWJsZWRcIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJhcHAudXBkYXRlLmF1dG9cIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJhcHAudXBkYXRlLm1vZGVcIiwgMCk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImFwcC51cGRhdGUuc2VydmljZS5lbmFibGVkXCIsIGZhbHNlKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci5zaGVsbC5jaGVja0RlZmF1bHRCcm93c2VyXCIsIGZhbHNlKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci51c2VkT25XaW5kb3dzMTBcIiwgdHJ1ZSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImJyb3dzZXIucmlnaHRzLjMuc2hvd25cIiwgdHJ1ZSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImJyb3dzZXIuc3RhcnR1cC5ob21lcGFnZV9vdmVycmlkZS5tc3RvbmVcIixcImlnbm9yZVwiKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci50YWJzLndhcm5PbkNsb3NlT3RoZXJUYWJzXCIsIGZhbHNlKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci50YWJzLndhcm5PbkNsb3NlXCIsIGZhbHNlKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci5zZXNzaW9uc3RvcmUucmVzdW1lX2Zyb21fY3Jhc2hcIiwgZmFsc2UpOycsXG4gICAgICAgIGB1c2VyX3ByZWYoXCJicm93c2VyLmhlbHBlckFwcHMubmV2ZXJBc2suc2F2ZVRvRGlza1wiLCBcIiR7bWltZVR5cGVzfVwiKTtgLFxuICAgICAgICBgdXNlcl9wcmVmKFwicGRmanMuZGlzYWJsZWRcIiwgdHJ1ZSk7YCxcbiAgICAgICAgJ3VzZXJfcHJlZihcInRvb2xraXQudGVsZW1ldHJ5LnJlcG9ydGluZ3BvbGljeS5maXJzdFJ1blwiLCBmYWxzZSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcInRvb2xraXQudGVsZW1ldHJ5LmVuYWJsZWRcIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJ0b29sa2l0LnRlbGVtZXRyeS5yZWplY3RlZFwiLCB0cnVlKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiZGF0YXJlcG9ydGluZy5oZWFsdGhyZXBvcnQudXBsb2FkRW5hYmxlZFwiLCBmYWxzZSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImRhdGFyZXBvcnRpbmcuaGVhbHRocmVwb3J0LnNlcnZpY2UuZW5hYmxlZFwiLCBmYWxzZSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImRhdGFyZXBvcnRpbmcuaGVhbHRocmVwb3J0LnNlcnZpY2UuZmlyc3RSdW5cIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJkYXRhcmVwb3J0aW5nLnBvbGljeS5kYXRhU3VibWlzc2lvbkVuYWJsZWRcIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJkYXRhcmVwb3J0aW5nLnBvbGljeS5kYXRhU3VibWlzc2lvblBvbGljeUJ5cGFzc05vdGlmaWNhdGlvblwiLCB0cnVlKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiYXBwLnNoaWVsZC5vcHRvdXRzdHVkaWVzLmVuYWJsZWRcIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJleHRlbnNpb25zLnNoaWVsZC1yZWNpcGUtY2xpZW50LmVuYWJsZWRcIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJleHRlbnNpb25zLnNoaWVsZC1yZWNpcGUtY2xpZW50LmZpcnN0X3J1blwiLCBmYWxzZSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImV4dGVuc2lvbnMuc2hpZWxkLXJlY2lwZS1jbGllbnQuc3RhcnR1cEV4cGVyaW1lbnRQcmVmcy5icm93c2VyLm5ld3RhYnBhZ2UuYWN0aXZpdHktc3RyZWFtLmVuYWJsZWRcIiwgZmFsc2UpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJkZXZ0b29scy50b29sYm94Lmhvc3RcIiwgXCJ3aW5kb3dcIik7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImRldnRvb2xzLnRvb2xib3gucHJldmlvdXNIb3N0XCIsIFwiYm90dG9tXCIpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJzaWdub24ucmVtZW1iZXJTaWdub25zXCIsIGZhbHNlKTsnLFxuICAgICAgICAvLyBOT1RFOiBkb20ubWluX2JhY2tncm91bmRfdGltZW91dF92YWx1ZSBzaG91bGQgYmUgZXF1YWwgdG8gZG9tLm1pbl90aW1lb3V0X3ZhbHVlXG4gICAgICAgICd1c2VyX3ByZWYoXCJkb20ubWluX2JhY2tncm91bmRfdGltZW91dF92YWx1ZVwiLCA0KTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiZG9tLnRpbWVvdXQudGhyb3R0bGluZ19kZWxheVwiLCAwKTsnLFxuICAgICAgICAndXNlcl9wcmVmKFwiZG9tLnRpbWVvdXQuYnVkZ2V0X3Rocm90dGxpbmdfbWF4X2RlbGF5XCIsIDApOycsXG4gICAgICAgIC8vIE5PVEU6IFdlIHNldCB0aGUgZm9yZWdyb3VuZCBjb25maWd1cmF0aW9uIGZvciB0aGUgYmFja2dyb3VuZCBidWRnZXQgdGhyb3R0bGluZyBwYXJhbWV0ZXJzXG4gICAgICAgICd1c2VyX3ByZWYoXCJkb20udGltZW91dC5iYWNrZ3JvdW5kX3Rocm90dGxpbmdfbWF4X2J1ZGdldFwiLCAtMSk7JyxcbiAgICAgICAgJ3VzZXJfcHJlZihcImRvbS50aW1lb3V0LmJhY2tncm91bmRfYnVkZ2V0X3JlZ2VuZXJhdGlvbl9yYXRlXCIsIDEpOycsXG4gICAgICAgICd1c2VyX3ByZWYoXCJzZWN1cml0eS5lbnRlcnByaXNlX3Jvb3RzLmVuYWJsZWRcIiwgdHJ1ZSk7JyxcbiAgICBdO1xuXG4gICAgaWYgKG1hcmlvbmV0dGVQb3J0KSB7XG4gICAgICAgIHByZWZzID0gcHJlZnMuY29uY2F0KFtcbiAgICAgICAgICAgIGB1c2VyX3ByZWYoXCJtYXJpb25ldHRlLnBvcnRcIiwgJHttYXJpb25ldHRlUG9ydH0pO2AsXG4gICAgICAgICAgICAndXNlcl9wcmVmKFwibWFyaW9uZXR0ZS5lbmFibGVkXCIsIHRydWUpOycsXG4gICAgICAgIF0pO1xuICAgIH1cblxuICAgIGlmIChjb25maWcuZGlzYWJsZU11bHRpcHJvY2Vzc2luZykge1xuICAgICAgICBwcmVmcyA9IHByZWZzLmNvbmNhdChbXG4gICAgICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci50YWJzLnJlbW90ZS5hdXRvc3RhcnRcIiwgZmFsc2UpOycsXG4gICAgICAgICAgICAndXNlcl9wcmVmKFwiYnJvd3Nlci50YWJzLnJlbW90ZS5hdXRvc3RhcnQuMlwiLCBmYWxzZSk7JyxcbiAgICAgICAgXSk7XG4gICAgfVxuXG4gICAgbWltZVR5cGVzLnNwbGl0KCcsJykuZm9yRWFjaChtaW1lVHlwZSA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBtaW1lVHlwZS5zcGxpdCgnLycpWzFdO1xuXG4gICAgICAgIHByZWZzLnB1c2goYHVzZXJfcHJlZihcImJyb3dzZXIuZG93bmxvYWQudmlld2FibGVJbnRlcm5hbGx5LnR5cGVXYXNSZWdpc3RlcmVkLiR7dHlwZX1cIiwgdHJ1ZSk7YCk7XG4gICAgfSk7XG5cbiAgICBhd2FpdCB3cml0ZUZpbGUocHJlZnNGaWxlTmFtZSwgcHJlZnMuam9pbignXFxuJykpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3cml0ZUhhbmRsZXJzRmlsZSAocHJvZmlsZURpcjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gTk9URTogVGhlIGRlZmluaXRpb25zIG9mIGFjdGlvbnMgYXJlIHRoZXJlIGh0dHBzOi8vc2VhcmNoZm94Lm9yZy9tb3ppbGxhLXJlbGVhc2Uvc291cmNlL25ldHdlcmsvbWltZS9uc0lNSU1FSW5mby5pZGwjMTE1XG4gICAgY29uc3QgaGFuZGxlcnNGaWxlTmFtZSA9IHBhdGguam9pbihwcm9maWxlRGlyLCAnaGFuZGxlcnMuanNvbicpO1xuICAgIGNvbnN0IGhhbmRsZXJzICAgICAgICAgPSB7XG4gICAgICAgIGRlZmF1bHRIYW5kbGVyc1ZlcnNpb246IHtcbiAgICAgICAgICAgIHJ1OiA1LFxuICAgICAgICB9LFxuICAgICAgICBtaW1lVHlwZXM6IHtcbiAgICAgICAgICAgICdhcHBsaWNhdGlvbi9wZGYnOiB7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiAgICAgMCxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICdwZGYnLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ3RleHQveG1sJzoge1xuICAgICAgICAgICAgICAgIGFjdGlvbjogICAgIDAsXG4gICAgICAgICAgICAgICAgZXh0ZW5zaW9uczogW1xuICAgICAgICAgICAgICAgICAgICAneG1sJyxcbiAgICAgICAgICAgICAgICAgICAgJ3hzbCcsXG4gICAgICAgICAgICAgICAgICAgICd4YmwnLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2ltYWdlL3N2Zyt4bWwnOiB7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiAgICAgMCxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICdzdmcnLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ2ltYWdlL3dlYnAnOiB7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiAgICAgMCxcbiAgICAgICAgICAgICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgICd3ZWJwJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgc2NoZW1lczoge30sXG4gICAgfTtcblxuICAgIGF3YWl0IHdyaXRlRmlsZShoYW5kbGVyc0ZpbGVOYW1lLCBKU09OLnN0cmluZ2lmeShoYW5kbGVycykpO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIChydW50aW1lSW5mbzogYW55KTogUHJvbWlzZTxUZW1wRGlyZWN0b3J5PiB7XG4gICAgY29uc3QgdG1wRGlyID0gYXdhaXQgVGVtcERpcmVjdG9yeS5jcmVhdGVEaXJlY3RvcnkoJ2ZpcmVmb3gtcHJvZmlsZScpO1xuXG4gICAgYXdhaXQgZ2VuZXJhdGVQcmVmZXJlbmNlcyh0bXBEaXIucGF0aCwgcnVudGltZUluZm8pO1xuICAgIGF3YWl0IHdyaXRlSGFuZGxlcnNGaWxlKHRtcERpci5wYXRoKTtcblxuICAgIHJldHVybiB0bXBEaXI7XG59XG4iXX0=