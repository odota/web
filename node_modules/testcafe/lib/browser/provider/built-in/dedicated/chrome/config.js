"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const device_specs_1 = require("device-specs");
const lodash_1 = require("lodash");
const argument_parsing_1 = require("../../../utils/argument-parsing");
const HEADLESS_DEFAULT_WIDTH = 1280;
const HEADLESS_DEFAULT_HEIGHT = 800;
const AVAILABLE_MODES = ['userProfile', 'headless', 'emulation'];
const configCache = {};
function parseUserArgs(userArgs) {
    const parsedArgs = {
        headless: false,
        userDataDir: false,
        windowSize: false,
    };
    const splittedArgs = userArgs.split(' ').filter(arg => !!arg);
    splittedArgs.forEach(arg => {
        const keyValuePair = arg.split('=');
        const key = lodash_1.camelCase(keyValuePair[0]);
        parsedArgs[key] = parsedArgs[key] !== void 0;
    });
    return parsedArgs;
}
function parseModes(modesStr, userArgs) {
    const parsed = argument_parsing_1.splitEscaped(modesStr, ':');
    const path = argument_parsing_1.getPathFromParsedModes(parsed, AVAILABLE_MODES);
    const detectedModes = argument_parsing_1.getModes(parsed, AVAILABLE_MODES);
    let optionsString = '';
    if (parsed.length)
        optionsString = parsed.shift();
    while (parsed.length)
        optionsString += ':' + parsed.shift();
    const userProfile = detectedModes.userProfile || userArgs.userDataDir;
    const headless = detectedModes.headless || userArgs.headless;
    const emulation = detectedModes.emulation || headless;
    const modes = {
        path,
        userProfile,
        headless,
        emulation,
    };
    return { modes, optionsString };
}
function simplifyDeviceName(deviceName) {
    return deviceName.replace(/\s/g, '').toLowerCase();
}
function findDevice(deviceName) {
    const simpleName = simplifyDeviceName(deviceName);
    return device_specs_1.emulatedDevices.filter(device => simplifyDeviceName(device.title).indexOf(simpleName) >= 0)[0];
}
function getDeviceBasedOptions(deviceName, orientation) {
    if (!deviceName)
        return {};
    const deviceData = findDevice(deviceName);
    if (!deviceData)
        return {};
    const mobile = deviceData.capabilities.indexOf('mobile') >= 0;
    if (!orientation)
        orientation = mobile ? 'vertical' : 'horizontal';
    return {
        deviceName: deviceData.title,
        mobile: mobile,
        orientation: orientation,
        touch: deviceData.capabilities.indexOf('touch') >= 0,
        width: deviceData.screen[orientation].width,
        height: deviceData.screen[orientation].height,
        scaleFactor: deviceData.screen['device-pixel-ratio'],
        userAgent: deviceData['user-agent'],
    };
}
function parseOptions(str, useDefaultDimensions) {
    const parsed = argument_parsing_1.splitEscaped(str, ';');
    const baseOptions = {
        width: useDefaultDimensions ? HEADLESS_DEFAULT_WIDTH : 0,
        height: useDefaultDimensions ? HEADLESS_DEFAULT_HEIGHT : 0,
        scaleFactor: 0,
        mobile: false,
        cdpPort: argument_parsing_1.findMatch(parsed, /^cdpPort=(.*)/),
    };
    const deviceName = argument_parsing_1.findMatch(parsed, /^device=(.*)/);
    const orientation = argument_parsing_1.findMatch(parsed, /^orientation=(.*)/);
    const deviceBasedOptions = getDeviceBasedOptions(deviceName, orientation);
    let specifiedDeviceOptions = {
        orientation: orientation,
        touch: argument_parsing_1.hasMatch(parsed, /^touch=/) ? argument_parsing_1.isMatchTrue(parsed, /^touch=(.*)/) : void 0,
        mobile: argument_parsing_1.isMatchTrue(parsed, /^mobile=(.*)/),
        width: Number(argument_parsing_1.findMatch(parsed, /^width=(.*)/) || NaN),
        height: Number(argument_parsing_1.findMatch(parsed, /^height=(.*)/) || NaN),
        scaleFactor: Number(argument_parsing_1.findMatch(parsed, /^scaleFactor=(.*)/) || NaN),
        userAgent: argument_parsing_1.findMatch(parsed, /^userAgent=(.*)/),
    };
    specifiedDeviceOptions = lodash_1.pickBy(specifiedDeviceOptions, optionValue => {
        return optionValue !== void 0 && optionValue !== '' && !Number.isNaN(optionValue);
    });
    return Object.assign(baseOptions, deviceBasedOptions, specifiedDeviceOptions);
}
function getNewConfig(configString) {
    const { userArgs, modesString } = argument_parsing_1.parseConfig(configString);
    const parsedUserArgs = parseUserArgs(userArgs);
    const { modes, optionsString } = parseModes(modesString, parsedUserArgs);
    const useDefaultDimensions = modes.headless && !parsedUserArgs.windowSize;
    const options = parseOptions(optionsString, useDefaultDimensions);
    return Object.assign({ userArgs }, modes, options);
}
function default_1(configString) {
    if (!configCache[configString])
        configCache[configString] = getNewConfig(configString);
    return configCache[configString];
}
exports.default = default_1;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jb25maWcuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQ0FBK0M7QUFDL0MsbUNBQStEO0FBQy9ELHNFQUV5QztBQUd6QyxNQUFNLHNCQUFzQixHQUFJLElBQUksQ0FBQztBQUNyQyxNQUFNLHVCQUF1QixHQUFHLEdBQUcsQ0FBQztBQUVwQyxNQUFNLGVBQWUsR0FBRyxDQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFFakUsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDO0FBRXZCLFNBQVMsYUFBYSxDQUFFLFFBQVE7SUFDNUIsTUFBTSxVQUFVLEdBQUc7UUFDZixRQUFRLEVBQUssS0FBSztRQUNsQixXQUFXLEVBQUUsS0FBSztRQUNsQixVQUFVLEVBQUcsS0FBSztLQUNyQixDQUFDO0lBRUYsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFOUQsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUN2QixNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sR0FBRyxHQUFZLGtCQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFaEQsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sVUFBVSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBRSxRQUFRLEVBQUUs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Z0IsQ0FBQyxzQkFBc0IsRUFBRSxXQUFXLENBQUMsRUFBRTtRQUM1RSxPQUFPLFdBQVcsS0FBSyxLQUFLLENBQUMsSUFBSSxXQUFXLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUN0RixDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsa0JBQWtCLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztBQUNsRixDQUFDO0FBR0QsU0FBUyxZQUFZLENBQUUsWUFBWTtJQUMvQixNQUFNLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxHQUFHLDhCQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDNUQsTUFBTSxjQUFjLEdBQWMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzFELE1BQU0sRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLEdBQUksVUFBVSxDQUFDLFdBQVcsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUMxRSxNQUFNLG9CQUFvQixHQUFRLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDO0lBQy9FLE1BQU0sT0FBTyxHQUFxQixZQUFZLENBQUMsYUFBYSxFQUFFLG9CQUFvQixDQUFDLENBQUM7SUFFcEYsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ3ZELENBQUM7QUFFRCxtQkFBeUIsWUFBWTtJQUNqQyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQztRQUMxQixXQUFXLENBQUMsWUFBWSxDQUFDLEdBQUcsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBRTNELE9BQU8sV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3JDLENBQUM7QUFMRCw0QkFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVtdWxhdGVkRGV2aWNlcyB9IGZyb20gJ2RldmljZS1zcGVjcyc7XG5pbXBvcnQgeyBwaWNrQnkgYXMgZmlsdGVyUHJvcGVydGllcywgY2FtZWxDYXNlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7XG4gICAgaGFzTWF0Y2gsIGZpbmRNYXRjaCwgaXNNYXRjaFRydWUsIGdldE1vZGVzLCBzcGxpdEVzY2FwZWQsIGdldFBhdGhGcm9tUGFyc2VkTW9kZXMsIHBhcnNlQ29uZmlnLFxufSBmcm9tICcuLi8uLi8uLi91dGlscy9hcmd1bWVudC1wYXJzaW5nJztcblxuXG5jb25zdCBIRUFETEVTU19ERUZBVUxUX1dJRFRIICA9IDEyODA7XG5jb25zdCBIRUFETEVTU19ERUZBVUxUX0hFSUdIVCA9IDgwMDtcblxuY29uc3QgQVZBSUxBQkxFX01PREVTID0gWyd1c2VyUHJvZmlsZScsICdoZWFkbGVzcycsICdlbXVsYXRpb24nXTtcblxuY29uc3QgY29uZmlnQ2FjaGUgPSB7fTtcblxuZnVuY3Rpb24gcGFyc2VVc2VyQXJncyAodXNlckFyZ3MpIHtcbiAgICBjb25zdCBwYXJzZWRBcmdzID0ge1xuICAgICAgICBoZWFkbGVzczogICAgZmFsc2UsXG4gICAgICAgIHVzZXJEYXRhRGlyOiBmYWxzZSxcbiAgICAgICAgd2luZG93U2l6ZTogIGZhbHNlLFxuICAgIH07XG5cbiAgICBjb25zdCBzcGxpdHRlZEFyZ3MgPSB1c2VyQXJncy5zcGxpdCgnICcpLmZpbHRlcihhcmcgPT4gISFhcmcpO1xuXG4gICAgc3BsaXR0ZWRBcmdzLmZvckVhY2goYXJnID0+IHtcbiAgICAgICAgY29uc3Qga2V5VmFsdWVQYWlyID0gYXJnLnNwbGl0KCc9Jyk7XG4gICAgICAgIGNvbnN0IGtleSAgICAgICAgICA9IGNhbWVsQ2FzZShrZXlWYWx1ZVBhaXJbMF0pO1xuXG4gICAgICAgIHBhcnNlZEFyZ3Nba2V5XSA9IHBhcnNlZEFyZ3Nba2V5XSAhPT0gdm9pZCAwO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBhcnNlZEFyZ3M7XG59XG5cbmZ1bmN0aW9uIHBhcnNlTW9kZXMgKG1vZGVzU3RyLCB1c2VyQXJncykge1xuICAgIGNvbnN0IHBhcnNlZCAgICAgICAgPSBzcGxpdEVzY2FwZWQobW9kZXNTdHIsICc6Jyk7XG4gICAgY29uc3QgcGF0aCAgICAgICAgICA9IGdldFBhdGhGcm9tUGFyc2VkTW9kZXMocGFyc2VkLCBBVkFJTEFCTEVfTU9ERVMpO1xuICAgIGNvbnN0IGRldGVjdGVkTW9kZXMgPSBnZXRNb2RlcyhwYXJzZWQsIEFWQUlMQUJMRV9NT0RFUyk7XG4gICAgbGV0IG9wdGlvbnNTdHJpbmcgPSAnJztcblxuICAgIGlmIChwYXJzZWQubGVuZ3RoKVxuICAgICAgICBvcHRpb25zU3RyaW5nID0gcGFyc2VkLnNoaWZ0KCk7XG5cbiAgICB3aGlsZSAocGFyc2VkLmxlbmd0aClcbiAgICAgICAgb3B0aW9uc1N0cmluZyArPSAnOicgKyBwYXJzZWQuc2hpZnQoKTtcblxuICAgIGNvbnN0IHVzZXJQcm9maWxlID0gZGV0ZWN0ZWRNb2Rlcy51c2VyUHJvZmlsZSB8fCB1c2VyQXJncy51c2VyRGF0YURpcjtcbiAgICBjb25zdCBoZWFkbGVzcyAgICA9IGRldGVjdGVkTW9kZXMuaGVhZGxlc3MgfHwgdXNlckFyZ3MuaGVhZGxlc3M7XG4gICAgY29uc3QgZW11bGF0aW9uICAgPSBkZXRlY3RlZE1vZGVzLmVtdWxhdGlvbiB8fCBoZWFkbGVzcztcblxuICAgIGNvbnN0IG1vZGVzID0ge1xuICAgICAgICBwYXRoLFxuICAgICAgICB1c2VyUHJvZmlsZSxcbiAgICAgICAgaGVhZGxlc3MsXG4gICAgICAgIGVtdWxhdGlvbixcbiAgICB9O1xuXG4gICAgcmV0dXJuIHsgbW9kZXMsIG9wdGlvbnNTdHJpbmcgfTtcbn1cblxuZnVuY3Rpb24gc2ltcGxpZnlEZXZpY2VOYW1lIChkZXZpY2VOYW1lKSB7XG4gICAgcmV0dXJuIGRldmljZU5hbWUucmVwbGFjZSgvXFxzL2csICcnKS50b0xvd2VyQ2FzZSgpO1xufVxuXG5mdW5jdGlvbiBmaW5kRGV2aWNlIChkZXZpY2VOYW1lKSB7XG4gICAgY29uc3Qgc2ltcGxlTmFtZSA9IHNpbXBsaWZ5RGV2aWNlTmFtZShkZXZpY2VOYW1lKTtcblxuICAgIHJldHVybiBlbXVsYXRlZERldmljZXMuZmlsdGVyKGRldmljZSA9PiBzaW1wbGlmeURldmljZU5hbWUoZGV2aWNlLnRpdGxlKS5pbmRleE9mKHNpbXBsZU5hbWUpID49IDApWzBdO1xufVxuXG5mdW5jdGlvbiBnZXREZXZpY2VCYXNlZE9wdGlvbnMgKGRldmljZU5hbWUsIG9yaWVudGF0aW9uKSB7XG4gICAgaWYgKCFkZXZpY2VOYW1lKVxuICAgICAgICByZXR1cm4ge307XG5cbiAgICBjb25zdCBkZXZpY2VEYXRhID0gZmluZERldmljZShkZXZpY2VOYW1lKTtcblxuICAgIGlmICghZGV2aWNlRGF0YSlcbiAgICAgICAgcmV0dXJuIHt9O1xuXG4gICAgY29uc3QgbW9iaWxlID0gZGV2aWNlRGF0YS5jYXBhYmlsaXRpZXMuaW5kZXhPZignbW9iaWxlJykgPj0gMDtcblxuICAgIGlmICghb3JpZW50YXRpb24pXG4gICAgICAgIG9yaWVudGF0aW9uID0gbW9iaWxlID8gJ3ZlcnRpY2FsJyA6ICdob3Jpem9udGFsJztcblxuICAgIHJldHVybiB7XG4gICAgICAgIGRldmljZU5hbWU6ICBkZXZpY2VEYXRhLnRpdGxlLFxuICAgICAgICBtb2JpbGU6ICAgICAgbW9iaWxlLFxuICAgICAgICBvcmllbnRhdGlvbjogb3JpZW50YXRpb24sXG4gICAgICAgIHRvdWNoOiAgICAgICBkZXZpY2VEYXRhLmNhcGFiaWxpdGllcy5pbmRleE9mKCd0b3VjaCcpID49IDAsXG4gICAgICAgIHdpZHRoOiAgICAgICBkZXZpY2VEYXRhLnNjcmVlbltvcmllbnRhdGlvbl0ud2lkdGgsXG4gICAgICAgIGhlaWdodDogICAgICBkZXZpY2VEYXRhLnNjcmVlbltvcmllbnRhdGlvbl0uaGVpZ2h0LFxuICAgICAgICBzY2FsZUZhY3RvcjogZGV2aWNlRGF0YS5zY3JlZW5bJ2RldmljZS1waXhlbC1yYXRpbyddLFxuICAgICAgICB1c2VyQWdlbnQ6ICAgZGV2aWNlRGF0YVsndXNlci1hZ2VudCddLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHBhcnNlT3B0aW9ucyAoc3RyLCB1c2VEZWZhdWx0RGltZW5zaW9ucykge1xuICAgIGNvbnN0IHBhcnNlZCA9IHNwbGl0RXNjYXBlZChzdHIsICc7Jyk7XG5cbiAgICBjb25zdCBiYXNlT3B0aW9ucyA9IHtcbiAgICAgICAgd2lkdGg6ICAgICAgIHVzZURlZmF1bHREaW1lbnNpb25zID8gSEVBRExFU1NfREVGQVVMVF9XSURUSCA6IDAsXG4gICAgICAgIGhlaWdodDogICAgICB1c2VEZWZhdWx0RGltZW5zaW9ucyA/IEhFQURMRVNTX0RFRkFVTFRfSEVJR0hUIDogMCxcbiAgICAgICAgc2NhbGVGYWN0b3I6IDAsXG4gICAgICAgIG1vYmlsZTogICAgICBmYWxzZSxcbiAgICAgICAgY2RwUG9ydDogICAgIGZpbmRNYXRjaChwYXJzZWQsIC9eY2RwUG9ydD0oLiopLyksXG4gICAgfTtcblxuICAgIGNvbnN0IGRldmljZU5hbWUgICAgICAgICA9IGZpbmRNYXRjaChwYXJzZWQsIC9eZGV2aWNlPSguKikvKTtcbiAgICBjb25zdCBvcmllbnRhdGlvbiAgICAgICAgPSBmaW5kTWF0Y2gocGFyc2VkLCAvXm9yaWVudGF0aW9uPSguKikvKTtcbiAgICBjb25zdCBkZXZpY2VCYXNlZE9wdGlvbnMgPSBnZXREZXZpY2VCYXNlZE9wdGlvbnMoZGV2aWNlTmFtZSwgb3JpZW50YXRpb24pO1xuXG4gICAgbGV0IHNwZWNpZmllZERldmljZU9wdGlvbnMgPSB7XG4gICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbixcbiAgICAgICAgdG91Y2g6ICAgICAgIGhhc01hdGNoKHBhcnNlZCwgL150b3VjaD0vKSA/IGlzTWF0Y2hUcnVlKHBhcnNlZCwgL150b3VjaD0oLiopLykgOiB2b2lkIDAsXG4gICAgICAgIG1vYmlsZTogICAgICBpc01hdGNoVHJ1ZShwYXJzZWQsIC9ebW9iaWxlPSguKikvKSxcbiAgICAgICAgd2lkdGg6ICAgICAgIE51bWJlcihmaW5kTWF0Y2gocGFyc2VkLCAvXndpZHRoPSguKikvKSB8fCBOYU4pLFxuICAgICAgICBoZWlnaHQ6ICAgICAgTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9eaGVpZ2h0PSguKikvKSB8fCBOYU4pLFxuICAgICAgICBzY2FsZUZhY3RvcjogTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9ec2NhbGVGYWN0b3I9KC4qKS8pIHx8IE5hTiksXG4gICAgICAgIHVzZXJBZ2VudDogICBmaW5kTWF0Y2gocGFyc2VkLCAvXnVzZXJBZ2VudD0oLiopLyksXG4gICAgfTtcblxuICAgIHNwZWNpZmllZERldmljZU9wdGlvbnMgPSBmaWx0ZXJQcm9wZXJ0aWVzKHNwZWNpZmllZERldmljZU9wdGlvbnMsIG9wdGlvblZhbHVlID0+IHtcbiAgICAgICAgcmV0dXJuIG9wdGlvblZhbHVlICE9PSB2b2lkIDAgJiYgb3B0aW9uVmFsdWUgIT09ICcnICYmICFOdW1iZXIuaXNOYU4ob3B0aW9uVmFsdWUpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYmFzZU9wdGlvbnMsIGRldmljZUJhc2VkT3B0aW9ucywgc3BlY2lmaWVkRGV2aWNlT3B0aW9ucyk7XG59XG5cblxuZnVuY3Rpb24gZ2V0TmV3Q29uZmlnIChjb25maWdTdHJpbmcpIHtcbiAgICBjb25zdCB7IHVzZXJBcmdzLCBtb2Rlc1N0cmluZyB9ID0gcGFyc2VDb25maWcoY29uZmlnU3RyaW5nKTtcbiAgICBjb25zdCBwYXJzZWRVc2VyQXJncyAgICAgICAgICAgID0gcGFyc2VVc2VyQXJncyh1c2VyQXJncyk7XG4gICAgY29uc3QgeyBtb2Rlcywgb3B0aW9uc1N0cmluZyB9ICA9IHBhcnNlTW9kZXMobW9kZXNTdHJpbmcsIHBhcnNlZFVzZXJBcmdzKTtcbiAgICBjb25zdCB1c2VEZWZhdWx0RGltZW5zaW9ucyAgICAgID0gbW9kZXMuaGVhZGxlc3MgJiYgIXBhcnNlZFVzZXJBcmdzLndpbmRvd1NpemU7XG4gICAgY29uc3Qgb3B0aW9ucyAgICAgICAgICAgICAgICAgICA9IHBhcnNlT3B0aW9ucyhvcHRpb25zU3RyaW5nLCB1c2VEZWZhdWx0RGltZW5zaW9ucyk7XG5cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7IHVzZXJBcmdzIH0sIG1vZGVzLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKGNvbmZpZ1N0cmluZykge1xuICAgIGlmICghY29uZmlnQ2FjaGVbY29uZmlnU3RyaW5nXSlcbiAgICAgICAgY29uZmlnQ2FjaGVbY29uZmlnU3RyaW5nXSA9IGdldE5ld0NvbmZpZyhjb25maWdTdHJpbmcpO1xuXG4gICAgcmV0dXJuIGNvbmZpZ0NhY2hlW2NvbmZpZ1N0cmluZ107XG59XG4iXX0=