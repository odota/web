"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const SharedErrors = __importStar(require("../../../../../../shared/errors"));
const execution_context_1 = __importDefault(require("./execution-context"));
const utils_1 = require("./utils");
const EXECUTION_CTX_WAS_DESTROYED_CODE = -32000;
const SELECTOR_MAX_EXECUTE_COUNT = 10;
const PROXYLESS_SCRIPT = 'window["%proxyless%"]';
class ClientFunctionExecutor {
    async evaluateScript(Runtime, expression) {
        const script = {
            expression,
            awaitPromise: true,
            contextId: execution_context_1.default.getCurrentContextId(),
        };
        try {
            const { result, exceptionDetails = null } = await Runtime.evaluate(script);
            return { result, exceptionDetails, error: null };
        }
        catch (error) {
            return { result: null, exceptionDetails: null, error };
        }
    }
    async _evaluateScriptWithReloadPageIgnore(Runtime, expression) {
        let attempts = 0;
        let result;
        let exceptionDetails;
        let error;
        while (attempts++ < SELECTOR_MAX_EXECUTE_COUNT) {
            ({ result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression));
            if (error && error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                continue;
            break;
        }
        // eslint-disable-next-line @typescript-eslint/no-object-literal-type-assertion
        return { result, exceptionDetails, error };
    }
    static _getPropertyByName(properties, name) {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return properties.find(prop => prop.name === name).value;
    }
    static _throwException(details, command, callsite) {
        var _a;
        const exception = details.exception;
        if (exception) {
            const className = exception.className;
            const properties = (_a = exception.preview) === null || _a === void 0 ? void 0 : _a.properties;
            if (className === SharedErrors.UncaughtErrorInCustomDOMPropertyCode.name) {
                throw new SharedErrors.UncaughtErrorInCustomDOMPropertyCode(command.instantiationCallsiteName, ClientFunctionExecutor._getPropertyByName(properties, 'errMsg'), ClientFunctionExecutor._getPropertyByName(properties, 'property'), callsite);
            }
            else if (className === SharedErrors.CannotObtainInfoForElementSpecifiedBySelectorError.name) {
                throw new SharedErrors.CannotObtainInfoForElementSpecifiedBySelectorError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === SharedErrors.ActionElementNotFoundError.name) {
                throw new SharedErrors.ActionElementNotFoundError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === SharedErrors.DomNodeClientFunctionResultError.name)
                throw new SharedErrors.DomNodeClientFunctionResultError(command.instantiationCallsiteName, callsite);
            else if (className === SharedErrors.InvalidSelectorResultError.name)
                throw new SharedErrors.InvalidSelectorResultError(callsite);
            else if (className === SharedErrors.ActionElementIsInvisibleError.name)
                throw new SharedErrors.ActionElementIsInvisibleError(callsite);
        }
        throw new SharedErrors.UncaughtErrorInClientFunctionCode(command.instantiationCallsiteName, details.text, callsite);
    }
    async executeClientFunction(Runtime, command, callsite) {
        const expression = `${PROXYLESS_SCRIPT}.executeClientFunctionCommand(${JSON.stringify(command)});`;
        const { result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression);
        if (error) {
            if (error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                throw new SharedErrors.ClientFunctionExecutionInterruptionError(command.instantiationCallsiteName, callsite);
            throw error;
        }
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        return JSON.parse(result.value); // eslint-disable-line @typescript-eslint/no-non-null-assertion
    }
    async executeSelector(args) {
        const { Runtime, command, callsite, selectorTimeout, errCtors } = args;
        const returnNodeObjId = 'DOM' in args;
        const expression = `${PROXYLESS_SCRIPT}.executeSelectorCommand(${JSON.stringify(command)}, ${selectorTimeout}, ${Date.now()},
                                 ${returnNodeObjId}, ${JSON.stringify(errCtors)});`;
        const { result, exceptionDetails, error } = await this._evaluateScriptWithReloadPageIgnore(Runtime, expression);
        if (error)
            throw error;
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return returnNodeObjId ? result.objectId : JSON.parse(result.value);
    }
    async getNode(args) {
        const objectId = await this.executeSelector(args);
        return utils_1.describeNode(args.DOM, objectId);
    }
}
exports.default = ClientFunctionExecutor;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LWZ1bmN0aW9uLWV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jZHAtY2xpZW50L2NsaWVudC1mdW5jdGlvbi1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFTQSw4RUFBZ0U7QUFPaEUsNEVBQW1EO0FBRW5ELG1DQUF1QztBQTBCdkMsTUFBTSxnQ0FBZ0MsR0FBRyxDQUFDLEtBQUssQ0FBQztBQUNoRCxNQUFNLDBCQUEwQixHQUFTLEVBQUUsQ0FBQztBQUM1QyxNQUFNLGdCQUFnQixHQUFtQix1QkFBdUIsQ0FBQztBQUdqRSxNQUFxQixzQkFBc0I7SUFDaEMsS0FBSyxDQUFDLGNBQWMsQ0FBRSxPQUFtQixFQUFFLFVBQWtCO1FBQ2hFLE1BQU0sTUFBTSxHQUFvQjtZQUM1QixVQUFVO1lBQ1YsWUFBWSxFQUFFLElBQUk7WUFDbEIsU0FBUyxFQUFLLDJCQUFnQixDQUFDLG1CQUFtQixFQUFFO1NBQ3ZELENBQUM7UUFFRixJQUFJO1lBQ0EsTUFBTSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsR0FBRyxJQUFJLEVBQUUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFM0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUM7U0FDcEQ7UUFDRCxPQUFPLEtBQUssRUFBRTtZQUNWLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQztTQUMxRDtJQUNMLENBQUM7SUFFTyxLQUFLLENBQUMsbUNBQW1DLENBQUUsT0FBbUIsRUFBRSxVQUFrQjtRQUN0RixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7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LEtBQUssZUFBZSxLQUFLLElBQUksQ0FBQyxHQUFHLEVBQUU7bUNBQ3JHLGVBQWUsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFFNUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFaEgsSUFBSSxLQUFLO1lBQ0wsTUFBTSxLQUFLLENBQUM7UUFFaEIsSUFBSSxnQkFBZ0I7WUFDaEIsc0JBQXNCLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUVoRixvRUFBb0U7UUFDcEUsT0FBTyxlQUFlLENBQUMsQ0FBQyxDQUFDLE1BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTyxDQUFFLElBQXNCO1FBQ3hDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVsRCxPQUFPLG9CQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBQ0o7QUF4SEQseUNBd0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb3RvY29sIGZyb20gJ2RldnRvb2xzLXByb3RvY29sJztcbmltcG9ydCB7IENhbGxzaXRlUmVjb3JkIH0gZnJvbSAnY2FsbHNpdGUtcmVjb3JkJztcbmltcG9ydCBQcm90b2NvbFByb3h5QXBpIGZyb20gJ2RldnRvb2xzLXByb3RvY29sL3R5cGVzL3Byb3RvY29sLXByb3h5LWFwaSc7XG5pbXBvcnQgUnVudGltZUFwaSA9IFByb3RvY29sUHJveHlBcGkuUnVudGltZUFwaTtcbmltcG9ydCBFdmFsdWF0ZVJlcXVlc3QgPSBQcm90b2NvbC5SdW50aW1lLkV2YWx1YXRlUmVxdWVzdDtcbmltcG9ydCBSZW1vdGVPYmplY3QgPSBQcm90b2NvbC5SdW50aW1lLlJlbW90ZU9iamVjdDtcbmltcG9ydCBFeGNlcHRpb25EZXRhaWxzID0gUHJvdG9jb2wuUnVudGltZS5FeGNlcHRpb25EZXRhaWxzO1xuaW1wb3J0IFByb3BlcnR5UHJldmlldyA9IFByb3RvY29sLlJ1bnRpbWUuUHJvcGVydHlQcmV2aWV3O1xuaW1wb3J0IERPTUFwaSA9IFByb3RvY29sUHJveHlBcGkuRE9NQXBpO1xuaW1wb3J0ICogYXMgU2hhcmVkRXJyb3JzIGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3NoYXJlZC9lcnJvcnMnO1xuaW1wb3J0IHtcbiAgICBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kLFxuICAgIEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlLFxuICAgIEV4ZWN1dGVTZWxlY3RvckNvbW1hbmQsXG59IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL29ic2VydmF0aW9uJztcbmltcG9ydCB7IEF1dG9tYXRpb25FcnJvckN0b3JzIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vc2hhcmVkL3R5cGVzJztcbmltcG9ydCBFeGVjdXRpb25Db250ZXh0IGZyb20gJy4vZXhlY3V0aW9uLWNvbnRleHQnO1xuaW1wb3J0IHsgU2VydmVyTm9kZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgZGVzY3JpYmVOb2RlIH0gZnJvbSAnLi91dGlscyc7XG5cbmludGVyZmFjZSBFdmFsdWF0aW9uRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgcmVxdWVzdDogRXZhbHVhdGVSZXF1ZXN0O1xuICAgIHJlc3BvbnNlOiB7IGNvZGU6IG51bWJlciB9O1xufVxuXG5pbnRlcmZhY2UgRXZhbHVhdGVTY3JpcHRSZXN1bHQge1xuICAgIHJlc3VsdDogUmVtb3RlT2JqZWN0IHwgbnVsbDtcbiAgICBleGNlcHRpb25EZXRhaWxzOiBFeGNlcHRpb25EZXRhaWxzIHwgbnVsbDtcbiAgICBlcnJvcjogRXZhbHVhdGlvbkVycm9yIHwgbnVsbDtcbn1cblxuaW50ZXJmYWNlIFNlbGVjdG9yU25hcHNob3RBcmdzIHtcbiAgICBSdW50aW1lOiBSdW50aW1lQXBpO1xuICAgIGNvbW1hbmQ6IEV4ZWN1dGVTZWxlY3RvckNvbW1hbmQ7XG4gICAgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkO1xuICAgIHNlbGVjdG9yVGltZW91dDogbnVtYmVyO1xuICAgIGVyckN0b3JzOiBBdXRvbWF0aW9uRXJyb3JDdG9ycztcbn1cblxuaW50ZXJmYWNlIFNlbGVjdG9yTm9kZUFyZ3MgZXh0ZW5kcyBTZWxlY3RvclNuYXBzaG90QXJncyB7XG4gICAgRE9NOiBET01BcGk7XG59XG5cblxuY29uc3QgRVhFQ1VUSU9OX0NUWF9XQVNfREVTVFJPWUVEX0NPREUgPSAtMzIwMDA7XG5jb25zdCBTRUxFQ1RPUl9NQVhfRVhFQ1VURV9DT1VOVCAgICAgICA9IDEwO1xuY29uc3QgUFJPWFlMRVNTX1NDUklQVCAgICAgICAgICAgICAgICAgPSAnd2luZG93W1wiJXByb3h5bGVzcyVcIl0nO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENsaWVudEZ1bmN0aW9uRXhlY3V0b3Ige1xuICAgIHB1YmxpYyBhc3luYyBldmFsdWF0ZVNjcmlwdCAoUnVudGltZTogUnVudGltZUFwaSwgZXhwcmVzc2lvbjogc3RyaW5nKTogUHJvbWlzZTxFdmFsdWF0ZVNjcmlwdFJlc3VsdD4ge1xuICAgICAgICBjb25zdCBzY3JpcHQ6IEV2YWx1YXRlUmVxdWVzdCA9IHtcbiAgICAgICAgICAgIGV4cHJlc3Npb24sXG4gICAgICAgICAgICBhd2FpdFByb21pc2U6IHRydWUsXG4gICAgICAgICAgICBjb250ZXh0SWQ6ICAgIEV4ZWN1dGlvbkNvbnRleHQuZ2V0Q3VycmVudENvbnRleHRJZCgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscyA9IG51bGwgfSA9IGF3YWl0IFJ1bnRpbWUuZXZhbHVhdGUoc2NyaXB0KTtcblxuICAgICAgICAgICAgcmV0dXJuIHsgcmVzdWx0LCBleGNlcHRpb25EZXRhaWxzLCBlcnJvcjogbnVsbCB9O1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiBudWxsLCBleGNlcHRpb25EZXRhaWxzOiBudWxsLCBlcnJvciB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZXZhbHVhdGVTY3JpcHRXaXRoUmVsb2FkUGFnZUlnbm9yZSAoUnVudGltZTogUnVudGltZUFwaSwgZXhwcmVzc2lvbjogc3RyaW5nKTogUHJvbWlzZTxFdmFsdWF0ZVNjcmlwdFJlc3VsdD4ge1xuICAgICAgICBsZXQgYXR0ZW1wdHMgPSAwO1xuICAgICAgICBsZXQgcmVzdWx0O1xuICAgICAgICBsZXQgZXhjZXB0aW9uRGV0YWlscztcbiAgICAgICAgbGV0IGVycm9yO1xuXG4gICAgICAgIHdoaWxlIChhdHRlbXB0cysrIDwgU0VMRUNUT1JfTUFYX0VYRUNVVEVfQ09VTlQpIHtcbiAgICAgICAgICAgICh7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscywgZXJyb3IgfSA9IGF3YWl0IHRoaXMuZXZhbHVhdGVTY3JpcHQoUnVudGltZSwgZXhwcmVzc2lvbikpO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3IgJiYgZXJyb3IucmVzcG9uc2UuY29kZSA9PT0gRVhFQ1VUSU9OX0NUWF9XQVNfREVTVFJPWUVEX0NPREUpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1vYmplY3QtbGl0ZXJhbC10eXBlLWFzc2VydGlvblxuICAgICAgICByZXR1cm4geyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gYXMgRXZhbHVhdGVTY3JpcHRSZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldFByb3BlcnR5QnlOYW1lIChwcm9wZXJ0aWVzOiBQcm9wZXJ0eVByZXZpZXdbXSwgbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgcmV0dXJuIHByb3BlcnRpZXMuZmluZChwcm9wID0+IHByb3AubmFtZSA9PT0gbmFtZSkhLnZhbHVlITtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfdGhyb3dFeGNlcHRpb24gKGRldGFpbHM6IEV4Y2VwdGlvbkRldGFpbHMsIGNvbW1hbmQ6IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlLCBjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQpOiBuZXZlciB7XG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IGRldGFpbHMuZXhjZXB0aW9uO1xuXG4gICAgICAgIGlmIChleGNlcHRpb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzTmFtZSAgPSBleGNlcHRpb24uY2xhc3NOYW1lO1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IGV4Y2VwdGlvbi5wcmV2aWV3Py5wcm9wZXJ0aWVzIGFzIFByb3BlcnR5UHJldmlld1tdO1xuXG4gICAgICAgICAgICBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuVW5jYXVnaHRFcnJvckluQ3VzdG9tRE9NUHJvcGVydHlDb2RlLm5hbWUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVkRXJyb3JzLlVuY2F1Z2h0RXJyb3JJbkN1c3RvbURPTVByb3BlcnR5Q29kZShjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIENsaWVudEZ1bmN0aW9uRXhlY3V0b3IuX2dldFByb3BlcnR5QnlOYW1lKHByb3BlcnRpZXMsICdlcnJNc2cnKSxcbiAgICAgICAgICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ3Byb3BlcnR5JyksXG4gICAgICAgICAgICAgICAgICAgIGNhbGxzaXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGNsYXNzTmFtZSA9PT0gU2hhcmVkRXJyb3JzLkNhbm5vdE9idGFpbkluZm9Gb3JFbGVtZW50U3BlY2lmaWVkQnlTZWxlY3RvckVycm9yLm5hbWUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVkRXJyb3JzLkNhbm5vdE9idGFpbkluZm9Gb3JFbGVtZW50U3BlY2lmaWVkQnlTZWxlY3RvckVycm9yKGNhbGxzaXRlLCB7XG4gICAgICAgICAgICAgICAgICAgIGFwaUZuQ2hhaW46IGNvbW1hbmQuYXBpRm5DaGFpbixcbiAgICAgICAgICAgICAgICAgICAgYXBpRm5JbmRleDogcGFyc2VJbnQoQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ2FwaUZuSW5kZXgnKSwgMTApLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudE5vdEZvdW5kRXJyb3IubmFtZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudE5vdEZvdW5kRXJyb3IoY2FsbHNpdGUsIHtcbiAgICAgICAgICAgICAgICAgICAgYXBpRm5DaGFpbjogY29tbWFuZC5hcGlGbkNoYWluLFxuICAgICAgICAgICAgICAgICAgICBhcGlGbkluZGV4OiBwYXJzZUludChDbGllbnRGdW5jdGlvbkV4ZWN1dG9yLl9nZXRQcm9wZXJ0eUJ5TmFtZShwcm9wZXJ0aWVzLCAnYXBpRm5JbmRleCcpLCAxMCksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5Eb21Ob2RlQ2xpZW50RnVuY3Rpb25SZXN1bHRFcnJvci5uYW1lKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuRG9tTm9kZUNsaWVudEZ1bmN0aW9uUmVzdWx0RXJyb3IoY29tbWFuZC5pbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBjYWxsc2l0ZSk7XG4gICAgICAgICAgICBlbHNlIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5JbnZhbGlkU2VsZWN0b3JSZXN1bHRFcnJvci5uYW1lKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IoY2FsbHNpdGUpO1xuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudElzSW52aXNpYmxlRXJyb3IubmFtZSlcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVkRXJyb3JzLkFjdGlvbkVsZW1lbnRJc0ludmlzaWJsZUVycm9yKGNhbGxzaXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuVW5jYXVnaHRFcnJvckluQ2xpZW50RnVuY3Rpb25Db2RlKGNvbW1hbmQuaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgZGV0YWlscy50ZXh0LCBjYWxsc2l0ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVDbGllbnRGdW5jdGlvbiAoUnVudGltZTogUnVudGltZUFwaSwgY29tbWFuZDogRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZCwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbiA9IGAke1BST1hZTEVTU19TQ1JJUFR9LmV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQoJHtKU09OLnN0cmluZ2lmeShjb21tYW5kKX0pO2A7XG5cbiAgICAgICAgY29uc3QgeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gPSBhd2FpdCB0aGlzLmV2YWx1YXRlU2NyaXB0KFJ1bnRpbWUsIGV4cHJlc3Npb24pO1xuXG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLmNvZGUgPT09IEVYRUNVVElPTl9DVFhfV0FTX0RFU1RST1lFRF9DT0RFKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuQ2xpZW50RnVuY3Rpb25FeGVjdXRpb25JbnRlcnJ1cHRpb25FcnJvcihjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGNhbGxzaXRlKTtcblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhjZXB0aW9uRGV0YWlscylcbiAgICAgICAgICAgIENsaWVudEZ1bmN0aW9uRXhlY3V0b3IuX3Rocm93RXhjZXB0aW9uKGV4Y2VwdGlvbkRldGFpbHMsIGNvbW1hbmQsIGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXN1bHQhLnZhbHVlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVTZWxlY3RvciA8VCBleHRlbmRzIFNlbGVjdG9yU25hcHNob3RBcmdzIHwgU2VsZWN0b3JOb2RlQXJncz4gKGFyZ3M6IFQpOiBQcm9taXNlPFQgZXh0ZW5kcyBTZWxlY3Rvck5vZGVBcmdzID8gc3RyaW5nIDogb2JqZWN0PiB7XG4gICAgICAgIGNvbnN0IHsgUnVudGltZSwgY29tbWFuZCwgY2FsbHNpdGUsIHNlbGVjdG9yVGltZW91dCwgZXJyQ3RvcnMgfSA9IGFyZ3M7XG5cbiAgICAgICAgY29uc3QgcmV0dXJuTm9kZU9iaklkID0gJ0RPTScgaW4gYXJncztcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbiAgICAgID0gYCR7UFJPWFlMRVNTX1NDUklQVH0uZXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCgke0pTT04uc3RyaW5naWZ5KGNvbW1hbmQpfSwgJHtzZWxlY3RvclRpbWVvdXR9LCAke0RhdGUubm93KCl9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHtyZXR1cm5Ob2RlT2JqSWR9LCAke0pTT04uc3RyaW5naWZ5KGVyckN0b3JzKX0pO2A7XG5cbiAgICAgICAgY29uc3QgeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9ldmFsdWF0ZVNjcmlwdFdpdGhSZWxvYWRQYWdlSWdub3JlKFJ1bnRpbWUsIGV4cHJlc3Npb24pO1xuXG4gICAgICAgIGlmIChlcnJvcilcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuXG4gICAgICAgIGlmIChleGNlcHRpb25EZXRhaWxzKVxuICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fdGhyb3dFeGNlcHRpb24oZXhjZXB0aW9uRGV0YWlscywgY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgIHJldHVybiByZXR1cm5Ob2RlT2JqSWQgPyByZXN1bHQhLm9iamVjdElkIDogSlNPTi5wYXJzZShyZXN1bHQhLnZhbHVlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0Tm9kZSAoYXJnczogU2VsZWN0b3JOb2RlQXJncyk6IFByb21pc2U8U2VydmVyTm9kZT4ge1xuICAgICAgICBjb25zdCBvYmplY3RJZCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVNlbGVjdG9yKGFyZ3MpO1xuXG4gICAgICAgIHJldHVybiBkZXNjcmliZU5vZGUoYXJncy5ET00sIG9iamVjdElkKTtcbiAgICB9XG59XG4iXX0=