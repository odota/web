"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../adapter/index");
const request_1 = __importDefault(require("./request"));
const script_execution_1 = __importDefault(require("./script-execution"));
class BarriersComplex {
    constructor(reqEmitter, scriptEmitter, unloadBarrier) {
        this._requestBarrier = new request_1.default(reqEmitter);
        this._scriptExecutionBarrier = new script_execution_1.default(scriptEmitter);
        this._unloadBarrier = unloadBarrier;
        if (unloadBarrier.watchForPageNavigationTriggers)
            unloadBarrier.watchForPageNavigationTriggers();
    }
    wait() {
        return index_1.adapter.PromiseCtor.all([
            // NOTE: script can be added by xhr-request, so we should run
            // script execution barrier waiting after request barrier resolved
            this._requestBarrier.wait()
                .then(() => this._scriptExecutionBarrier.wait()),
            this._unloadBarrier.wait(),
        ]).then();
    }
}
exports.default = BarriersComplex;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGxleC1iYXJyaWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NoYXJlZC9iYXJyaWVycy9jb21wbGV4LWJhcnJpZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw0Q0FBMkM7QUFDM0Msd0RBQXVDO0FBQ3ZDLDBFQUF3RDtBQVN4RCxNQUFxQixlQUFlO0lBS2hDLFlBQW9CLFVBQW1DLEVBQUUsYUFBd0MsRUFBRSxhQUFnQztRQUMvSCxJQUFJLENBQUMsZUFBZSxHQUFXLElBQUksaUJBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSwwQkFBc0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN6RSxJQUFJLENBQUMsY0FBYyxHQUFZLGFBQWEsQ0FBQztRQUU3QyxJQUFJLGFBQWEsQ0FBQyw4QkFBOEI7WUFDNUMsYUFBYSxDQUFDLDhCQUE4QixFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVNLElBQUk7UUFDUCxPQUFPLGVBQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDO1lBQzNCLDZEQUE2RDtZQUM3RCxrRUFBa0U7WUFDbEUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUU7aUJBQ3RCLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFcEQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUU7U0FDN0IsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNKO0FBeEJELGtDQXdCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkYXB0ZXIgfSBmcm9tICcuLi9hZGFwdGVyL2luZGV4JztcbmltcG9ydCBSZXF1ZXN0QmFycmllciBmcm9tICcuL3JlcXVlc3QnO1xuaW1wb3J0IFNjcmlwdEV4ZWN1dGlvbkJhcnJpZXIgZnJvbSAnLi9zY3JpcHQtZXhlY3V0aW9uJztcbmltcG9ydCB7IENsaWVudFJlcXVlc3RFbWl0dGVyLCBTY3JpcHRFeGVjdXRpb25FbWl0dGVyIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5cbmludGVyZmFjZSBQYWdlVW5sb2FkQmFycmllciB7XG4gICAgd2F0Y2hGb3JQYWdlTmF2aWdhdGlvblRyaWdnZXJzPzogKCkgPT4gdm9pZDtcbiAgICB3YWl0OiAoKSA9PiBQcm9taXNlPHZvaWQ+O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBCYXJyaWVyc0NvbXBsZXg8UiwgUz4ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3JlcXVlc3RCYXJyaWVyOiBSZXF1ZXN0QmFycmllcjxSPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9zY3JpcHRFeGVjdXRpb25CYXJyaWVyOiBTY3JpcHRFeGVjdXRpb25CYXJyaWVyPFM+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3VubG9hZEJhcnJpZXI6IFBhZ2VVbmxvYWRCYXJyaWVyO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChyZXFFbWl0dGVyOiBDbGllbnRSZXF1ZXN0RW1pdHRlcjxSPiwgc2NyaXB0RW1pdHRlcjogU2NyaXB0RXhlY3V0aW9uRW1pdHRlcjxTPiwgdW5sb2FkQmFycmllcjogUGFnZVVubG9hZEJhcnJpZXIpIHtcbiAgICAgICAgdGhpcy5fcmVxdWVzdEJhcnJpZXIgICAgICAgICA9IG5ldyBSZXF1ZXN0QmFycmllcihyZXFFbWl0dGVyKTtcbiAgICAgICAgdGhpcy5fc2NyaXB0RXhlY3V0aW9uQmFycmllciA9IG5ldyBTY3JpcHRFeGVjdXRpb25CYXJyaWVyKHNjcmlwdEVtaXR0ZXIpO1xuICAgICAgICB0aGlzLl91bmxvYWRCYXJyaWVyICAgICAgICAgID0gdW5sb2FkQmFycmllcjtcblxuICAgICAgICBpZiAodW5sb2FkQmFycmllci53YXRjaEZvclBhZ2VOYXZpZ2F0aW9uVHJpZ2dlcnMpXG4gICAgICAgICAgICB1bmxvYWRCYXJyaWVyLndhdGNoRm9yUGFnZU5hdmlnYXRpb25UcmlnZ2VycygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB3YWl0ICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGFkYXB0ZXIuUHJvbWlzZUN0b3IuYWxsKFtcbiAgICAgICAgICAgIC8vIE5PVEU6IHNjcmlwdCBjYW4gYmUgYWRkZWQgYnkgeGhyLXJlcXVlc3QsIHNvIHdlIHNob3VsZCBydW5cbiAgICAgICAgICAgIC8vIHNjcmlwdCBleGVjdXRpb24gYmFycmllciB3YWl0aW5nIGFmdGVyIHJlcXVlc3QgYmFycmllciByZXNvbHZlZFxuICAgICAgICAgICAgdGhpcy5fcmVxdWVzdEJhcnJpZXIud2FpdCgpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fc2NyaXB0RXhlY3V0aW9uQmFycmllci53YWl0KCkpLFxuXG4gICAgICAgICAgICB0aGlzLl91bmxvYWRCYXJyaWVyLndhaXQoKSxcbiAgICAgICAgXSkudGhlbigpO1xuICAgIH1cbn1cbiJdfQ==