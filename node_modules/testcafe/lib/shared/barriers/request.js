"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../adapter");
const delay_1 = __importDefault(require("../../utils/delay"));
const REQUESTS_COLLECTION_DELAY_DEFAULT = 50;
class RequestBarrier {
    constructor(emitter, delays = {}) {
        var _a, _b, _c;
        this._delays = {
            requestsCollection: (_a = delays.requestsCollection) !== null && _a !== void 0 ? _a : REQUESTS_COLLECTION_DELAY_DEFAULT,
            additionalRequestsCollection: (_b = delays.additionalRequestsCollection) !== null && _b !== void 0 ? _b : REQUESTS_COLLECTION_DELAY_DEFAULT,
            pageInitialRequestsCollection: (_c = delays.pageInitialRequestsCollection) !== null && _c !== void 0 ? _c : REQUESTS_COLLECTION_DELAY_DEFAULT,
        };
        this._emitter = emitter;
        this._waitResolve = null;
        this._watchdog = null;
        this._requests = new Set();
        this._collectingReqs = true;
        this._startListening();
    }
    _startListening() {
        this._emitter.onRequestSend((req) => this._onRequestSend(req));
        this._emitter.onRequestCompleted((req) => this._onRequestCompleted(req));
        this._emitter.onRequestError((req) => this._onRequestError(req));
    }
    _offListening() {
        this._emitter.offAll();
    }
    _onRequestSend(req) {
        if (this._collectingReqs)
            this._requests.add(req);
    }
    _onRequestCompleted(req) {
        // NOTE: let the last real XHR handler finish its job and try to obtain
        // any additional requests if they were initiated by this handler
        delay_1.default(this._delays.additionalRequestsCollection)
            .then(() => this._onRequestFinished(req));
    }
    _onRequestFinished(req) {
        if (!this._requests.has(req))
            return;
        this._requests.delete(req);
        if (!this._collectingReqs && !this._requests.size && this._watchdog)
            this._finishWaiting();
    }
    _onRequestError(req) {
        this._onRequestFinished(req);
    }
    _finishWaiting() {
        if (this._watchdog) {
            const clearTimeout = adapter_1.adapter.nativeMethods.clearTimeout;
            clearTimeout(this._watchdog);
            this._watchdog = null;
        }
        this._requests.clear();
        this._offListening();
        this._waitResolve(); // eslint-disable-line @typescript-eslint/no-non-null-assertion
    }
    wait(isPageLoad) {
        return delay_1.default(isPageLoad ? this._delays.pageInitialRequestsCollection : this._delays.requestsCollection)
            .then(() => new adapter_1.adapter.PromiseCtor((resolve) => {
            this._collectingReqs = false;
            this._waitResolve = resolve;
            if (!this._requests.size) {
                this._finishWaiting();
                return;
            }
            const setTimeout = adapter_1.adapter.nativeMethods.setTimeout;
            this._watchdog = setTimeout(() => this._finishWaiting(), RequestBarrier.TIMEOUT);
        }));
    }
}
exports.default = RequestBarrier;
RequestBarrier.TIMEOUT = 3000;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaGFyZWQvYmFycmllcnMvcmVxdWVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdDQUFxQztBQUNyQyw4REFBc0M7QUFVdEMsTUFBTSxpQ0FBaUMsR0FBRyxFQUFFLENBQUM7QUFFN0MsTUFBcUIsY0FBYztJQVUvQixZQUFvQixPQUFnQyxFQUFFLFNBQTBCLEVBQUU7O1FBQzlFLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDWCxrQkFBa0IsUUFBYSxNQUFNLENBQUMsa0JBQWtCLG1DQUFJLGlDQUFpQztZQUM3Riw0QkFBNEIsUUFBRyxNQUFNLENBQUMsNEJBQTRCLG1DQUFJLGlDQUFpQztZQUN2Ryw2QkFBNkIsUUFBRSxNQUFNLENBQUMsNkJBQTZCLG1DQUFJLGlDQUFpQztTQUMzRyxDQUFDO1FBRUYsSUFBSSxDQUFDLFFBQVEsR0FBVSxPQUFPLENBQUM7UUFDL0IsSUFBSSxDQUFDLFlBQVksR0FBTSxJQUFJLENBQUM7UUFDNUIsSUFBSSxDQUFDLFNBQVMsR0FBUyxJQUFJLENBQUM7UUFDNUIsSUFBSSxDQUFDLFNBQVMsR0FBUyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBRTVCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRU8sZUFBZTtRQUNuQixJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxHQUFNLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVPLGFBQWE7UUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRU8sY0FBYyxDQUFFLEdBQU07UUFDMUIsSUFBSSxJQUFJLENBQUMsZUFBZTtZQUNwQixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU8sbUJBQW1CLENBQUUsR0FBTTtRQUMvQix1RUFBdUU7UUFDdkUsaUVBQWlFO1FBQ2pFLGVBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixDQUFDO2FBQzNDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRU8sa0JBQWtCLENBQUUsR0FBTTtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQ3hCLE9BQU87UUFFWCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUzQixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTO1lBQy9ELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRU8sZUFBZSxDQUFFLEdBQU07UUFDM0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFTyxjQUFjO1FBQ2xCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNoQixNQUFNLFlBQVksR0FBRyxpQkFBTyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUM7WUFFeEQsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU3QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztTQUN6QjtRQUVELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxZQUFhLEVBQUUsQ0FBQyxDQUFDLCtEQUErRDtJQUN6RixDQUFDO0lBRU0sSUFBSSxDQUFFLFVBQW9CO1FBQzdCLE9BQU8sZUFBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQzthQUNsRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxpQkFBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQW1CLEVBQUUsRUFBRTtZQUN4RCxJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztZQUM3QixJQUFJLENBQUMsWUFBWSxHQUFNLE9BQU8sQ0FBQztZQUUvQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFFdEIsT0FBTzthQUNWO1lBRUQsTUFBTSxVQUFVLEdBQUcsaUJBQU8sQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDO1lBRXBELElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRSxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckYsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNaLENBQUM7O0FBNUZMLGlDQTZGQztBQTVGMkIsc0JBQU8sR0FBRyxJQUFJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhZGFwdGVyIH0gZnJvbSAnLi4vYWRhcHRlcic7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IHsgTmF0aXZlTWV0aG9kcywgQ2xpZW50UmVxdWVzdEVtaXR0ZXIgfSBmcm9tICcuLi90eXBlcyc7XG5cblxuaW50ZXJmYWNlIERlbGF5cyB7XG4gICAgcmVxdWVzdHNDb2xsZWN0aW9uOiBudW1iZXI7XG4gICAgYWRkaXRpb25hbFJlcXVlc3RzQ29sbGVjdGlvbjogbnVtYmVyO1xuICAgIHBhZ2VJbml0aWFsUmVxdWVzdHNDb2xsZWN0aW9uOiBudW1iZXI7XG59XG5cbmNvbnN0IFJFUVVFU1RTX0NPTExFQ1RJT05fREVMQVlfREVGQVVMVCA9IDUwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXF1ZXN0QmFycmllcjxSPiB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVElNRU9VVCA9IDMwMDA7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9kZWxheXM6IERlbGF5cztcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9yZXF1ZXN0czogU2V0PFI+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2VtaXR0ZXI6IENsaWVudFJlcXVlc3RFbWl0dGVyPFI+O1xuICAgIHByaXZhdGUgX3dhaXRSZXNvbHZlOiAoKCkgPT4gdm9pZCkgfCBudWxsO1xuICAgIHByaXZhdGUgX3dhdGNoZG9nOiBSZXR1cm5UeXBlPE5hdGl2ZU1ldGhvZHNbJ3NldFRpbWVvdXQnXT4gfCBudWxsO1xuICAgIHByb3RlY3RlZCBfY29sbGVjdGluZ1JlcXM6IGJvb2xlYW47XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IgKGVtaXR0ZXI6IENsaWVudFJlcXVlc3RFbWl0dGVyPFI+LCBkZWxheXM6IFBhcnRpYWw8RGVsYXlzPiA9IHt9KSB7XG4gICAgICAgIHRoaXMuX2RlbGF5cyA9IHtcbiAgICAgICAgICAgIHJlcXVlc3RzQ29sbGVjdGlvbjogICAgICAgICAgICBkZWxheXMucmVxdWVzdHNDb2xsZWN0aW9uID8/IFJFUVVFU1RTX0NPTExFQ1RJT05fREVMQVlfREVGQVVMVCxcbiAgICAgICAgICAgIGFkZGl0aW9uYWxSZXF1ZXN0c0NvbGxlY3Rpb246ICBkZWxheXMuYWRkaXRpb25hbFJlcXVlc3RzQ29sbGVjdGlvbiA/PyBSRVFVRVNUU19DT0xMRUNUSU9OX0RFTEFZX0RFRkFVTFQsXG4gICAgICAgICAgICBwYWdlSW5pdGlhbFJlcXVlc3RzQ29sbGVjdGlvbjogZGVsYXlzLnBhZ2VJbml0aWFsUmVxdWVzdHNDb2xsZWN0aW9uID8/IFJFUVVFU1RTX0NPTExFQ1RJT05fREVMQVlfREVGQVVMVCxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLl9lbWl0dGVyICAgICAgICA9IGVtaXR0ZXI7XG4gICAgICAgIHRoaXMuX3dhaXRSZXNvbHZlICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5fd2F0Y2hkb2cgICAgICAgPSBudWxsO1xuICAgICAgICB0aGlzLl9yZXF1ZXN0cyAgICAgICA9IG5ldyBTZXQoKTtcbiAgICAgICAgdGhpcy5fY29sbGVjdGluZ1JlcXMgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuX3N0YXJ0TGlzdGVuaW5nKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc3RhcnRMaXN0ZW5pbmcgKCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9lbWl0dGVyLm9uUmVxdWVzdFNlbmQoKHJlcTogUikgPT4gdGhpcy5fb25SZXF1ZXN0U2VuZChyZXEpKTtcbiAgICAgICAgdGhpcy5fZW1pdHRlci5vblJlcXVlc3RDb21wbGV0ZWQoKHJlcTogUikgPT4gdGhpcy5fb25SZXF1ZXN0Q29tcGxldGVkKHJlcSkpO1xuICAgICAgICB0aGlzLl9lbWl0dGVyLm9uUmVxdWVzdEVycm9yKChyZXE6IFIpID0+IHRoaXMuX29uUmVxdWVzdEVycm9yKHJlcSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX29mZkxpc3RlbmluZyAoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2VtaXR0ZXIub2ZmQWxsKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25SZXF1ZXN0U2VuZCAocmVxOiBSKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLl9jb2xsZWN0aW5nUmVxcylcbiAgICAgICAgICAgIHRoaXMuX3JlcXVlc3RzLmFkZChyZXEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX29uUmVxdWVzdENvbXBsZXRlZCAocmVxOiBSKTogdm9pZCB7XG4gICAgICAgIC8vIE5PVEU6IGxldCB0aGUgbGFzdCByZWFsIFhIUiBoYW5kbGVyIGZpbmlzaCBpdHMgam9iIGFuZCB0cnkgdG8gb2J0YWluXG4gICAgICAgIC8vIGFueSBhZGRpdGlvbmFsIHJlcXVlc3RzIGlmIHRoZXkgd2VyZSBpbml0aWF0ZWQgYnkgdGhpcyBoYW5kbGVyXG4gICAgICAgIGRlbGF5KHRoaXMuX2RlbGF5cy5hZGRpdGlvbmFsUmVxdWVzdHNDb2xsZWN0aW9uKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fb25SZXF1ZXN0RmluaXNoZWQocmVxKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25SZXF1ZXN0RmluaXNoZWQgKHJlcTogUik6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuX3JlcXVlc3RzLmhhcyhyZXEpKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuX3JlcXVlc3RzLmRlbGV0ZShyZXEpO1xuXG4gICAgICAgIGlmICghdGhpcy5fY29sbGVjdGluZ1JlcXMgJiYgIXRoaXMuX3JlcXVlc3RzLnNpemUgJiYgdGhpcy5fd2F0Y2hkb2cpXG4gICAgICAgICAgICB0aGlzLl9maW5pc2hXYWl0aW5nKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25SZXF1ZXN0RXJyb3IgKHJlcTogUik6IHZvaWQge1xuICAgICAgICB0aGlzLl9vblJlcXVlc3RGaW5pc2hlZChyZXEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2ZpbmlzaFdhaXRpbmcgKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5fd2F0Y2hkb2cpIHtcbiAgICAgICAgICAgIGNvbnN0IGNsZWFyVGltZW91dCA9IGFkYXB0ZXIubmF0aXZlTWV0aG9kcy5jbGVhclRpbWVvdXQ7XG5cbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl93YXRjaGRvZyk7XG5cbiAgICAgICAgICAgIHRoaXMuX3dhdGNoZG9nID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3JlcXVlc3RzLmNsZWFyKCk7XG4gICAgICAgIHRoaXMuX29mZkxpc3RlbmluZygpO1xuICAgICAgICB0aGlzLl93YWl0UmVzb2x2ZSEoKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgfVxuXG4gICAgcHVibGljIHdhaXQgKGlzUGFnZUxvYWQ/OiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBkZWxheShpc1BhZ2VMb2FkID8gdGhpcy5fZGVsYXlzLnBhZ2VJbml0aWFsUmVxdWVzdHNDb2xsZWN0aW9uIDogdGhpcy5fZGVsYXlzLnJlcXVlc3RzQ29sbGVjdGlvbilcbiAgICAgICAgICAgIC50aGVuKCgpID0+IG5ldyBhZGFwdGVyLlByb21pc2VDdG9yKChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY29sbGVjdGluZ1JlcXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLl93YWl0UmVzb2x2ZSAgICA9IHJlc29sdmU7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3JlcXVlc3RzLnNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZmluaXNoV2FpdGluZygpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBzZXRUaW1lb3V0ID0gYWRhcHRlci5uYXRpdmVNZXRob2RzLnNldFRpbWVvdXQ7XG5cbiAgICAgICAgICAgICAgICB0aGlzLl93YXRjaGRvZyA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fZmluaXNoV2FpdGluZygpLCBSZXF1ZXN0QmFycmllci5USU1FT1VUKTtcbiAgICAgICAgICAgIH0pKTtcbiAgICB9XG59XG4iXX0=