"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../adapter");
const event_emitter_1 = __importDefault(require("../utils/event-emitter"));
const delay_1 = __importDefault(require("../utils/delay"));
const promise_1 = require("../utils/promise");
const automation_errors_1 = __importDefault(require("../errors/automation-errors"));
const errors_1 = require("../../shared/errors");
const elements_retriever_1 = __importDefault(require("../utils/elements-retriever"));
const MAX_DELAY_AFTER_EXECUTION = 2000;
const CHECK_ELEMENT_IN_AUTOMATIONS_INTERVAL = 250;
class ActionExecutor extends event_emitter_1.default {
    constructor(command, globalSelectorTimeout, testSpeed, executeSelectorFn) {
        var _a;
        super();
        this._command = command;
        this._targetElement = null;
        this._elements = [];
        this._globalSelectorTimeout = globalSelectorTimeout;
        this._executionStartTime = 0;
        this._executeSelectorFn = executeSelectorFn;
        // TODO: move it to the server
        // @ts-ignore
        if (command.options && !command.options.speed) // @ts-ignore
            command.options.speed = testSpeed;
        // TODO: and this
        // @ts-ignore
        this._commandSelectorTimeout = typeof ((_a = command.selector) === null || _a === void 0 ? void 0 : _a.timeout) === 'number' ? command.selector.timeout : globalSelectorTimeout;
    }
    _delayAfterExecution() {
        // @ts-ignore TODO
        if (!this._command.options || this._command.options.speed === 1)
            return adapter_1.adapter.PromiseCtor.resolve();
        // @ts-ignore TODO
        return delay_1.default((1 - this._command.options.speed) * MAX_DELAY_AFTER_EXECUTION);
    }
    _isExecutionTimeoutExpired() {
        return adapter_1.adapter.nativeMethods.dateNow() - this._executionStartTime >= this._commandSelectorTimeout;
    }
    _ensureCommandArguments() {
        const handler = ActionExecutor.ACTIONS_HANDLERS[this._command.type];
        if (!(handler === null || handler === void 0 ? void 0 : handler.ensureCmdArgs))
            return;
        handler.ensureCmdArgs(this._command);
    }
    _ensureCommandElements() {
        var _a;
        const elsRetriever = new elements_retriever_1.default(this._globalSelectorTimeout, this._executeSelectorFn);
        if (this._command.selector)
            // @ts-ignore TODO
            elsRetriever.push(this._command.selector);
        const additionalSelectorProps = (_a = ActionExecutor.ACTIONS_HANDLERS[this._command.type]) === null || _a === void 0 ? void 0 : _a.additionalSelectorProps;
        if (additionalSelectorProps) {
            for (const prop of additionalSelectorProps) {
                if (this._command[prop])
                    // @ts-ignore TODO
                    elsRetriever.push(this._command[prop], prop);
            }
        }
        return elsRetriever.getElements()
            .then(elements => {
            this._elements = elements;
        });
    }
    _ensureCommandElementsProperties() {
        const handler = ActionExecutor.ACTIONS_HANDLERS[this._command.type];
        if (!(handler === null || handler === void 0 ? void 0 : handler.ensureElsProps))
            return;
        handler.ensureElsProps(this._elements);
    }
    async _ensureCommandOptions() {
        const opts = this._command.options;
        // @ts-ignore TODO
        if (this._elements.length && opts && 'offsetX' in opts && 'offsetY' in opts) { // @ts-ignore
            const { offsetX, offsetY } = await adapter_1.adapter.getOffsetOptions(this._elements[0], opts.offsetX, opts.offsetY);
            // @ts-ignore TODO
            opts.offsetX = offsetX;
            // @ts-ignore TODO
            opts.offsetY = offsetY;
        }
    }
    _createAutomation() {
        const handler = ActionExecutor.ACTIONS_HANDLERS[this._command.type];
        if (!handler)
            throw new Error(`There is no handler for the "${this._command.type}" command.`);
        return handler.create(this._command, this._elements);
    }
    _runAction(strictElementCheck) {
        return this._ensureCommandElements()
            .then(() => this._ensureCommandElementsProperties())
            .then(() => this._ensureCommandOptions())
            .then(() => {
            const automation = this._createAutomation();
            if (automation.TARGET_ELEMENT_FOUND_EVENT) {
                automation.on(automation.TARGET_ELEMENT_FOUND_EVENT, e => {
                    this._targetElement = e.element;
                    this.emit(ActionExecutor.EXECUTION_STARTED_EVENT);
                });
            }
            else
                this.emit(ActionExecutor.EXECUTION_STARTED_EVENT);
            return automation.run(strictElementCheck);
        });
    }
    _runRecursively() {
        let actionFinished = false;
        let strictElementCheck = true;
        return promise_1.whilst(() => !actionFinished, () => {
            return this._runAction(strictElementCheck)
                .then(() => {
                actionFinished = true;
            })
                .catch(err => {
                if (!this._isExecutionTimeoutExpired())
                    return delay_1.default(CHECK_ELEMENT_IN_AUTOMATIONS_INTERVAL);
                if (err.message === automation_errors_1.default.foundElementIsNotTarget) {
                    // If we can't get a target element via elementFromPoint but it's
                    // visible we click on the point where the element is located.
                    strictElementCheck = false;
                    return adapter_1.adapter.PromiseCtor.resolve();
                }
                throw err.message === automation_errors_1.default.elementIsInvisibleError ?
                    new errors_1.ActionElementIsInvisibleError() : err;
            });
        });
    }
    execute(barriers) {
        this._executionStartTime = adapter_1.adapter.nativeMethods.dateNow();
        try {
            // TODO: I think that this check is unnecessary here. It checks only a key sequence of the pressKey command.
            // This check can be moved to the server.
            this._ensureCommandArguments();
        }
        catch (err) {
            return adapter_1.adapter.PromiseCtor.reject(err);
        }
        this.emit(ActionExecutor.WAITING_FOR_ELEMENT_EVENT, this._commandSelectorTimeout);
        return this._runRecursively()
            .then(() => Promise.all([
            this._delayAfterExecution(),
            barriers.wait(),
        ]))
            .then(() => {
            const elements = [...this._elements];
            if (this._targetElement)
                elements[0] = this._targetElement;
            return elements;
        });
    }
}
exports.default = ActionExecutor;
ActionExecutor.EXECUTION_STARTED_EVENT = 'execution-started';
ActionExecutor.WAITING_FOR_ELEMENT_EVENT = 'waiting-for-elements';
ActionExecutor.ACTIONS_HANDLERS = {};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aW9uLWV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NoYXJlZC9hY3Rpb25zL2FjdGlvbi1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdDQUFxQztBQUNyQywyRUFBa0Q7QUFFbEQsMkRBQW1DO0FBQ25DLDhDQUEwQztBQUcxQyxvRkFBaUU7QUFDakUsZ0RBQW9FO0FBRXBFLHFGQUE0RDtBQUk1RCxNQUFNLHlCQUF5QixHQUFlLElBQUksQ0FBQztBQUNuRCxNQUFNLHFDQUFxQyxHQUFHLEdBQUcsQ0FBQztBQUVsRCxNQUFxQixjQUFrQixTQUFRLHVCQUFZO0lBYXZELFlBQW9CLE9BQTBCLEVBQUUscUJBQTZCLEVBQUUsU0FBaUIsRUFBRSxpQkFBdUM7O1FBQ3JJLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLFFBQVEsR0FBUyxPQUFPLENBQUM7UUFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBUSxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDLHNCQUFzQixHQUFHLHFCQUFxQixDQUFDO1FBQ3BELElBQUksQ0FBQyxtQkFBbUIsR0FBTSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLGtCQUFrQixHQUFPLGlCQUFpQixDQUFDO1FBRWhELDhCQUE4QjtRQUM5QixhQUFhO1FBQ2IsSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsYUFBYTtZQUN4RCxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7UUFFdEMsaUJBQWlCO1FBQ2pCLGFBQWE7UUFDYixJQUFJLENBQUMsdUJBQXVCLEdBQUcsY0FBTyxPQUFPLENBQUMsUUFBUSwwQ0FBRSxPQUFPLENBQUEsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENB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QUFFLENBQUM7UUFFM0QsSUFBSTtZQUNBLDRHQUE0RztZQUM1Ryx5Q0FBeUM7WUFDekMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7U0FDbEM7UUFDRCxPQUFPLEdBQUcsRUFBRTtZQUNSLE9BQU8saUJBQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMseUJBQXlCLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFFbEYsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFO2FBQ3hCLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ3BCLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUMzQixRQUFRLENBQUMsSUFBSSxFQUFFO1NBQ2xCLENBQUMsQ0FBQzthQUNGLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDUCxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXJDLElBQUksSUFBSSxDQUFDLGNBQWM7Z0JBQ25CLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBRXRDLE9BQU8sUUFBUSxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQzs7QUExTEwsaUNBMkxDO0FBMUwwQixzQ0FBdUIsR0FBRyxtQkFBbUIsQ0FBQztBQUM5Qyx3Q0FBeUIsR0FBRyxzQkFBc0IsQ0FBQztBQUNuRCwrQkFBZ0IsR0FBa0MsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWRhcHRlciB9IGZyb20gJy4uL2FkYXB0ZXInO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICcuLi91dGlscy9ldmVudC1lbWl0dGVyJztcbmltcG9ydCBDb21wbGV4QmFycmllciBmcm9tICcuLi9iYXJyaWVycy9jb21wbGV4LWJhcnJpZXInO1xuaW1wb3J0IGRlbGF5IGZyb20gJy4uL3V0aWxzL2RlbGF5JztcbmltcG9ydCB7IHdoaWxzdCB9IGZyb20gJy4uL3V0aWxzL3Byb21pc2UnO1xuaW1wb3J0IHsgQWN0aW9uQ29tbWFuZEJhc2UgfSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9iYXNlJztcbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi8uLi9jb25maWd1cmF0aW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IEFVVE9NQVRJT05fRVJST1JfVFlQRVMgZnJvbSAnLi4vZXJyb3JzL2F1dG9tYXRpb24tZXJyb3JzJztcbmltcG9ydCB7IEFjdGlvbkVsZW1lbnRJc0ludmlzaWJsZUVycm9yIH0gZnJvbSAnLi4vLi4vc2hhcmVkL2Vycm9ycyc7XG5pbXBvcnQgeyBFeGVjdXRlU2VsZWN0b3JGbiB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCBFbGVtZW50c1JldHJpZXZlciBmcm9tICcuLi91dGlscy9lbGVtZW50cy1yZXRyaWV2ZXInO1xuaW1wb3J0IHsgQXV0b21hdGlvbiwgQXV0b21hdGlvbkhhbmRsZXIgfSBmcm9tICcuL3R5cGVzJztcblxuXG5jb25zdCBNQVhfREVMQVlfQUZURVJfRVhFQ1VUSU9OICAgICAgICAgICAgID0gMjAwMDtcbmNvbnN0IENIRUNLX0VMRU1FTlRfSU5fQVVUT01BVElPTlNfSU5URVJWQUwgPSAyNTA7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFjdGlvbkV4ZWN1dG9yPFQ+IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEVYRUNVVElPTl9TVEFSVEVEX0VWRU5UID0gJ2V4ZWN1dGlvbi1zdGFydGVkJztcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFdBSVRJTkdfRk9SX0VMRU1FTlRfRVZFTlQgPSAnd2FpdGluZy1mb3ItZWxlbWVudHMnO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgQUNUSU9OU19IQU5ETEVSUzogRGljdGlvbmFyeTxBdXRvbWF0aW9uSGFuZGxlcj4gPSB7fTtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NvbW1hbmQ6IEFjdGlvbkNvbW1hbmRCYXNlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2dsb2JhbFNlbGVjdG9yVGltZW91dDogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NvbW1hbmRTZWxlY3RvclRpbWVvdXQ6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9leGVjdXRlU2VsZWN0b3JGbjogRXhlY3V0ZVNlbGVjdG9yRm48VD47XG4gICAgcHJpdmF0ZSBfZWxlbWVudHM6IFRbXTtcbiAgICBwcml2YXRlIF9leGVjdXRpb25TdGFydFRpbWU6IG51bWJlcjtcbiAgICBwcml2YXRlIF90YXJnZXRFbGVtZW50OiBUIHwgbnVsbDtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAoY29tbWFuZDogQWN0aW9uQ29tbWFuZEJhc2UsIGdsb2JhbFNlbGVjdG9yVGltZW91dDogbnVtYmVyLCB0ZXN0U3BlZWQ6IG51bWJlciwgZXhlY3V0ZVNlbGVjdG9yRm46IEV4ZWN1dGVTZWxlY3RvckZuPFQ+KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5fY29tbWFuZCAgICAgICA9IGNvbW1hbmQ7XG4gICAgICAgIHRoaXMuX3RhcmdldEVsZW1lbnQgPSBudWxsO1xuICAgICAgICB0aGlzLl9lbGVtZW50cyAgICAgID0gW107XG5cbiAgICAgICAgdGhpcy5fZ2xvYmFsU2VsZWN0b3JUaW1lb3V0ID0gZ2xvYmFsU2VsZWN0b3JUaW1lb3V0O1xuICAgICAgICB0aGlzLl9leGVjdXRpb25TdGFydFRpbWUgICAgPSAwO1xuICAgICAgICB0aGlzLl9leGVjdXRlU2VsZWN0b3JGbiAgICAgPSBleGVjdXRlU2VsZWN0b3JGbjtcblxuICAgICAgICAvLyBUT0RPOiBtb3ZlIGl0IHRvIHRoZSBzZXJ2ZXJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAoY29tbWFuZC5vcHRpb25zICYmICFjb21tYW5kLm9wdGlvbnMuc3BlZWQpIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbW1hbmQub3B0aW9ucy5zcGVlZCA9IHRlc3RTcGVlZDtcblxuICAgICAgICAvLyBUT0RPOiBhbmQgdGhpc1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRoaXMuX2NvbW1hbmRTZWxlY3RvclRpbWVvdXQgPSB0eXBlb2YgY29tbWFuZC5zZWxlY3Rvcj8udGltZW91dCA9PT0gJ251bWJlcicgPyBjb21tYW5kLnNlbGVjdG9yLnRpbWVvdXQgOiBnbG9iYWxTZWxlY3RvclRpbWVvdXQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGVsYXlBZnRlckV4ZWN1dGlvbiAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ET1xuICAgICAgICBpZiAoIXRoaXMuX2NvbW1hbmQub3B0aW9ucyB8fCB0aGlzLl9jb21tYW5kLm9wdGlvbnMuc3BlZWQgPT09IDEpXG4gICAgICAgICAgICByZXR1cm4gYWRhcHRlci5Qcm9taXNlQ3Rvci5yZXNvbHZlKCk7XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZSBUT0RPXG4gICAgICAgIHJldHVybiBkZWxheSgoMSAtIHRoaXMuX2NvbW1hbmQub3B0aW9ucy5zcGVlZCkgKiBNQVhfREVMQVlfQUZURVJfRVhFQ1VUSU9OKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pc0V4ZWN1dGlvblRpbWVvdXRFeHBpcmVkICgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGFkYXB0ZXIubmF0aXZlTWV0aG9kcy5kYXRlTm93KCkgLSB0aGlzLl9leGVjdXRpb25TdGFydFRpbWUgPj0gdGhpcy5fY29tbWFuZFNlbGVjdG9yVGltZW91dDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9lbnN1cmVDb21tYW5kQXJndW1lbnRzICgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciA9IEFjdGlvbkV4ZWN1dG9yLkFDVElPTlNfSEFORExFUlNbdGhpcy5fY29tbWFuZC50eXBlXTtcblxuICAgICAgICBpZiAoIWhhbmRsZXI/LmVuc3VyZUNtZEFyZ3MpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgaGFuZGxlci5lbnN1cmVDbWRBcmdzKHRoaXMuX2NvbW1hbmQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Vuc3VyZUNvbW1hbmRFbGVtZW50cyAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGVsc1JldHJpZXZlciA9IG5ldyBFbGVtZW50c1JldHJpZXZlcih0aGlzLl9nbG9iYWxTZWxlY3RvclRpbWVvdXQsIHRoaXMuX2V4ZWN1dGVTZWxlY3RvckZuKTtcblxuICAgICAgICBpZiAodGhpcy5fY29tbWFuZC5zZWxlY3RvcilcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ET1xuICAgICAgICAgICAgZWxzUmV0cmlldmVyLnB1c2godGhpcy5fY29tbWFuZC5zZWxlY3Rvcik7XG5cbiAgICAgICAgY29uc3QgYWRkaXRpb25hbFNlbGVjdG9yUHJvcHMgPSBBY3Rpb25FeGVjdXRvci5BQ1RJT05TX0hBTkRMRVJTW3RoaXMuX2NvbW1hbmQudHlwZV0/LmFkZGl0aW9uYWxTZWxlY3RvclByb3BzO1xuXG4gICAgICAgIGlmIChhZGRpdGlvbmFsU2VsZWN0b3JQcm9wcykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBwcm9wIG9mIGFkZGl0aW9uYWxTZWxlY3RvclByb3BzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2NvbW1hbmRbcHJvcF0pXG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ET1xuICAgICAgICAgICAgICAgICAgICBlbHNSZXRyaWV2ZXIucHVzaCh0aGlzLl9jb21tYW5kW3Byb3BdLCBwcm9wKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlbHNSZXRyaWV2ZXIuZ2V0RWxlbWVudHMoKVxuICAgICAgICAgICAgLnRoZW4oZWxlbWVudHMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRzID0gZWxlbWVudHM7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9lbnN1cmVDb21tYW5kRWxlbWVudHNQcm9wZXJ0aWVzICgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciA9IEFjdGlvbkV4ZWN1dG9yLkFDVElPTlNfSEFORExFUlNbdGhpcy5fY29tbWFuZC50eXBlXTtcblxuICAgICAgICBpZiAoIWhhbmRsZXI/LmVuc3VyZUVsc1Byb3BzKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGhhbmRsZXIuZW5zdXJlRWxzUHJvcHModGhpcy5fZWxlbWVudHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2Vuc3VyZUNvbW1hbmRPcHRpb25zICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IHRoaXMuX2NvbW1hbmQub3B0aW9ucztcblxuICAgICAgICAvLyBAdHMtaWdub3JlIFRPRE9cbiAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnRzLmxlbmd0aCAmJiBvcHRzICYmICdvZmZzZXRYJyBpbiBvcHRzICYmICdvZmZzZXRZJyBpbiBvcHRzKSB7IC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGNvbnN0IHsgb2Zmc2V0WCwgb2Zmc2V0WSB9ID0gYXdhaXQgYWRhcHRlci5nZXRPZmZzZXRPcHRpb25zKHRoaXMuX2VsZW1lbnRzWzBdLCBvcHRzLm9mZnNldFgsIG9wdHMub2Zmc2V0WSk7XG5cbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ET1xuICAgICAgICAgICAgb3B0cy5vZmZzZXRYID0gb2Zmc2V0WDtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmUgVE9ET1xuICAgICAgICAgICAgb3B0cy5vZmZzZXRZID0gb2Zmc2V0WTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZUF1dG9tYXRpb24gKCk6IEF1dG9tYXRpb24ge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gQWN0aW9uRXhlY3V0b3IuQUNUSU9OU19IQU5ETEVSU1t0aGlzLl9jb21tYW5kLnR5cGVdO1xuXG4gICAgICAgIGlmICghaGFuZGxlcilcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlcmUgaXMgbm8gaGFuZGxlciBmb3IgdGhlIFwiJHt0aGlzLl9jb21tYW5kLnR5cGV9XCIgY29tbWFuZC5gKTtcblxuICAgICAgICByZXR1cm4gaGFuZGxlci5jcmVhdGUodGhpcy5fY29tbWFuZCwgdGhpcy5fZWxlbWVudHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3J1bkFjdGlvbiAoc3RyaWN0RWxlbWVudENoZWNrOiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnN1cmVDb21tYW5kRWxlbWVudHMoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fZW5zdXJlQ29tbWFuZEVsZW1lbnRzUHJvcGVydGllcygpKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fZW5zdXJlQ29tbWFuZE9wdGlvbnMoKSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBhdXRvbWF0aW9uID0gdGhpcy5fY3JlYXRlQXV0b21hdGlvbigpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGF1dG9tYXRpb24uVEFSR0VUX0VMRU1FTlRfRk9VTkRfRVZFTlQpIHtcbiAgICAgICAgICAgICAgICAgICAgYXV0b21hdGlvbi5vbihhdXRvbWF0aW9uLlRBUkdFVF9FTEVNRU5UX0ZPVU5EX0VWRU5ULCBlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RhcmdldEVsZW1lbnQgPSBlLmVsZW1lbnQ7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChBY3Rpb25FeGVjdXRvci5FWEVDVVRJT05fU1RBUlRFRF9FVkVOVCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChBY3Rpb25FeGVjdXRvci5FWEVDVVRJT05fU1RBUlRFRF9FVkVOVCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYXV0b21hdGlvbi5ydW4oc3RyaWN0RWxlbWVudENoZWNrKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3J1blJlY3Vyc2l2ZWx5ICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgbGV0IGFjdGlvbkZpbmlzaGVkICAgICA9IGZhbHNlO1xuICAgICAgICBsZXQgc3RyaWN0RWxlbWVudENoZWNrID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gd2hpbHN0KCgpID0+ICFhY3Rpb25GaW5pc2hlZCwgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1bkFjdGlvbihzdHJpY3RFbGVtZW50Q2hlY2spXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25GaW5pc2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pc0V4ZWN1dGlvblRpbWVvdXRFeHBpcmVkKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkoQ0hFQ0tfRUxFTUVOVF9JTl9BVVRPTUFUSU9OU19JTlRFUlZBTCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5tZXNzYWdlID09PSBBVVRPTUFUSU9OX0VSUk9SX1RZUEVTLmZvdW5kRWxlbWVudElzTm90VGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSBjYW4ndCBnZXQgYSB0YXJnZXQgZWxlbWVudCB2aWEgZWxlbWVudEZyb21Qb2ludCBidXQgaXQnc1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmlzaWJsZSB3ZSBjbGljayBvbiB0aGUgcG9pbnQgd2hlcmUgdGhlIGVsZW1lbnQgaXMgbG9jYXRlZC5cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmljdEVsZW1lbnRDaGVjayA9IGZhbHNlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWRhcHRlci5Qcm9taXNlQ3Rvci5yZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnIubWVzc2FnZSA9PT0gQVVUT01BVElPTl9FUlJPUl9UWVBFUy5lbGVtZW50SXNJbnZpc2libGVFcnJvciA/XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgQWN0aW9uRWxlbWVudElzSW52aXNpYmxlRXJyb3IoKSA6IGVycjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGV4ZWN1dGUgKGJhcnJpZXJzOiBDb21wbGV4QmFycmllcjxhbnksIGFueT4pOiBQcm9taXNlPFRbXT4ge1xuICAgICAgICB0aGlzLl9leGVjdXRpb25TdGFydFRpbWUgPSBhZGFwdGVyLm5hdGl2ZU1ldGhvZHMuZGF0ZU5vdygpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBJIHRoaW5rIHRoYXQgdGhpcyBjaGVjayBpcyB1bm5lY2Vzc2FyeSBoZXJlLiBJdCBjaGVja3Mgb25seSBhIGtleSBzZXF1ZW5jZSBvZiB0aGUgcHJlc3NLZXkgY29tbWFuZC5cbiAgICAgICAgICAgIC8vIFRoaXMgY2hlY2sgY2FuIGJlIG1vdmVkIHRvIHRoZSBzZXJ2ZXIuXG4gICAgICAgICAgICB0aGlzLl9lbnN1cmVDb21tYW5kQXJndW1lbnRzKCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIGFkYXB0ZXIuUHJvbWlzZUN0b3IucmVqZWN0KGVycik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmVtaXQoQWN0aW9uRXhlY3V0b3IuV0FJVElOR19GT1JfRUxFTUVOVF9FVkVOVCwgdGhpcy5fY29tbWFuZFNlbGVjdG9yVGltZW91dCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3J1blJlY3Vyc2l2ZWx5KClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICB0aGlzLl9kZWxheUFmdGVyRXhlY3V0aW9uKCksXG4gICAgICAgICAgICAgICAgYmFycmllcnMud2FpdCgpLFxuICAgICAgICAgICAgXSkpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudHMgPSBbLi4udGhpcy5fZWxlbWVudHNdO1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3RhcmdldEVsZW1lbnQpXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnRzWzBdID0gdGhpcy5fdGFyZ2V0RWxlbWVudDtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50cztcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==