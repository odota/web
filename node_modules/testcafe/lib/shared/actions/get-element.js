"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../adapter");
const is_window_iframe_1 = __importDefault(require("./utils/is-window-iframe"));
function ensureImageMap(imgElement, areaElement) {
    return adapter_1.adapter.PromiseCtor.resolve(adapter_1.adapter.dom.closest(areaElement, 'map'))
        .then(mapElement => {
        return mapElement && mapElement.name === adapter_1.adapter.dom.getImgMapName(imgElement) ? areaElement : imgElement;
    });
}
function findElementOrNonEmptyChildFromPoint(point, element) {
    return adapter_1.adapter.PromiseCtor.resolve(adapter_1.adapter.position.getElementFromPoint(point))
        .then(topElement => {
        return adapter_1.adapter.PromiseCtor.resolve(adapter_1.adapter.dom.containsElement(element, topElement))
            .then(containsEl => containsEl && adapter_1.adapter.dom.getNodeText(topElement))
            .then(isNonEmptyChild => isNonEmptyChild || topElement && adapter_1.adapter.dom.isNodeEqual(topElement, element) ? topElement : null);
    });
}
function correctTopElementByExpectedElement(topElement, expectedElement) {
    if (!expectedElement || !topElement || adapter_1.adapter.dom.isNodeEqual(topElement, expectedElement))
        return topElement;
    const isTREFElement = adapter_1.adapter.dom.getTagName(expectedElement) === 'tref';
    // NOTE: 'document.elementFromPoint' can't find these types of elements
    if (isTREFElement)
        return expectedElement;
    // NOTE: T299665 - Incorrect click automation for images with an associated map element in Firefox
    // All browsers return the <area> element from document.getElementFromPoint, but
    // Firefox returns the <img> element. We should accomplish this for Firefox as well.
    const isImageMapArea = adapter_1.adapter.dom.getTagName(expectedElement) === 'area' && adapter_1.adapter.dom.isImgElement(topElement);
    if (adapter_1.adapter.browser.isFirefox && isImageMapArea)
        return ensureImageMap(topElement, expectedElement);
    // NOTE: try to find a multi-line link by its rectangle (T163678)
    return adapter_1.adapter.PromiseCtor.resolve(adapter_1.adapter.dom.closest(expectedElement, 'a'))
        .then(anchor => !!anchor)
        .then(isLinkOrChildExpected => {
        if (!isLinkOrChildExpected)
            return false;
        return adapter_1.adapter.PromiseCtor.resolve(adapter_1.adapter.dom.containsElement(expectedElement, topElement))
            .then(containsElement => containsElement && adapter_1.adapter.dom.getNodeText(topElement))
            .then(isTopElementChildOfLink => !isTopElementChildOfLink && adapter_1.adapter.dom.getNodeText(expectedElement));
    })
        .then(shouldSearchForMultilineLink => {
        if (!shouldSearchForMultilineLink)
            return topElement;
        return adapter_1.adapter.PromiseCtor.resolve(adapter_1.adapter.position.getClientDimensions(expectedElement))
            .then(linkRect => findElementOrNonEmptyChildFromPoint({ x: linkRect.right - 1, y: linkRect.top + 1 }, expectedElement)
            .then(el => el || findElementOrNonEmptyChildFromPoint({ x: linkRect.left + 1, y: linkRect.bottom - 1 }, expectedElement))
            .then(el => el || topElement));
    });
}
function getElementFromPoint(point, win, expectedEl) {
    return adapter_1.adapter.getElementExceptUI(point)
        .then((topElement) => {
        // NOTE: when trying to get an element by elementFromPoint in iframe and the target
        // element is under any of shadow-ui elements, you will get null (only in IE).
        // In this case, you should hide a top window's shadow-ui root to obtain an element.
        let resChain = adapter_1.adapter.PromiseCtor.resolve(topElement);
        if (!topElement && is_window_iframe_1.default(win) && point.x > 0 && point.y > 0)
            resChain = resChain.then(() => adapter_1.adapter.getElementExceptUI(point, true));
        return resChain.then((element) => correctTopElementByExpectedElement(element, expectedEl));
    });
}
exports.default = getElementFromPoint;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWVsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhcmVkL2FjdGlvbnMvZ2V0LWVsZW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx3Q0FBcUM7QUFDckMsZ0ZBQXNEO0FBS3RELFNBQVMsY0FBYyxDQUFLLFVBQWEsRUFBRSxXQUFjO0lBQ3JELE9BQU8saUJBQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGlCQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDdEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQ2YsT0FBTyxVQUFVLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxpQkFBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO0lBQzlHLENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVELFNBQVMsbUNBQW1DLENBQUssS0FBNkIsRUFBRSxPQUFXO0lBQ3ZGLE9BQU8saUJBQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGlCQUFPLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzFFLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUNmLE9BQU8saUJBQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGlCQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7YUFDL0UsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxJQUFJLGlCQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUNyRSxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxlQUFlLElBQUksVUFBVSxJQUFJLGlCQUFPLENBQUMs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LENBQTZCLEtBQTZCLEVBQUUsR0FBTSxFQUFFLFVBQWM7SUFDekgsT0FBTyxpQkFBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQztTQUNuQyxJQUFJLENBQUMsQ0FBQyxVQUFhLEVBQUUsRUFBRTtRQUNwQixtRkFBbUY7UUFDbkYsOEVBQThFO1FBQzlFLG9GQUFvRjtRQUNwRixJQUFJLFFBQVEsR0FBRyxpQkFBTyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLFVBQVUsSUFBSSwwQkFBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNoRSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxpQkFBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTVFLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQVUsRUFBRSxFQUFFLENBQUMsa0NBQWtDLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDbEcsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBYkQsc0NBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhZGFwdGVyIH0gZnJvbSAnLi4vYWRhcHRlcic7XG5pbXBvcnQgaXNJZnJhbWVXaW5kb3cgZnJvbSAnLi91dGlscy9pcy13aW5kb3ctaWZyYW1lJztcbmltcG9ydCB7IEF4aXNWYWx1ZXNEYXRhIH0gZnJvbSAnLi4vdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCB7IFNoYXJlZFdpbmRvdyB9IGZyb20gJy4uL3R5cGVzJztcblxuXG5mdW5jdGlvbiBlbnN1cmVJbWFnZU1hcDxFPiAoaW1nRWxlbWVudDogRSwgYXJlYUVsZW1lbnQ6IEUpOiBQcm9taXNlPEU+IHtcbiAgICByZXR1cm4gYWRhcHRlci5Qcm9taXNlQ3Rvci5yZXNvbHZlKGFkYXB0ZXIuZG9tLmNsb3Nlc3QoYXJlYUVsZW1lbnQsICdtYXAnKSlcbiAgICAgICAgLnRoZW4obWFwRWxlbWVudCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbWFwRWxlbWVudCAmJiBtYXBFbGVtZW50Lm5hbWUgPT09IGFkYXB0ZXIuZG9tLmdldEltZ01hcE5hbWUoaW1nRWxlbWVudCkgPyBhcmVhRWxlbWVudCA6IGltZ0VsZW1lbnQ7XG4gICAgICAgIH0pO1xufVxuXG5mdW5jdGlvbiBmaW5kRWxlbWVudE9yTm9uRW1wdHlDaGlsZEZyb21Qb2ludDxFPiAocG9pbnQ6IEF4aXNWYWx1ZXNEYXRhPG51bWJlcj4sIGVsZW1lbnQ/OiBFKTogUHJvbWlzZTxFIHwgbnVsbD4ge1xuICAgIHJldHVybiBhZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoYWRhcHRlci5wb3NpdGlvbi5nZXRFbGVtZW50RnJvbVBvaW50KHBvaW50KSlcbiAgICAgICAgLnRoZW4odG9wRWxlbWVudCA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYWRhcHRlci5Qcm9taXNlQ3Rvci5yZXNvbHZlKGFkYXB0ZXIuZG9tLmNvbnRhaW5zRWxlbWVudChlbGVtZW50LCB0b3BFbGVtZW50KSlcbiAgICAgICAgICAgICAgICAudGhlbihjb250YWluc0VsID0+IGNvbnRhaW5zRWwgJiYgYWRhcHRlci5kb20uZ2V0Tm9kZVRleHQodG9wRWxlbWVudCkpXG4gICAgICAgICAgICAgICAgLnRoZW4oaXNOb25FbXB0eUNoaWxkID0+IGlzTm9uRW1wdHlDaGlsZCB8fCB0b3BFbGVtZW50ICYmIGFkYXB0ZXIuZG9tLmlzTm9kZUVxdWFsKHRvcEVsZW1lbnQsIGVsZW1lbnQpID8gdG9wRWxlbWVudCA6IG51bGwpO1xuICAgICAgICB9KTtcbn1cblxuZnVuY3Rpb24gY29ycmVjdFRvcEVsZW1lbnRCeUV4cGVjdGVkRWxlbWVudDxFPiAodG9wRWxlbWVudDogRSwgZXhwZWN0ZWRFbGVtZW50PzogRSk6IFByb21pc2U8RT4gfCBFIHtcbiAgICBpZiAoIWV4cGVjdGVkRWxlbWVudCB8fCAhdG9wRWxlbWVudCB8fCBhZGFwdGVyLmRvbS5pc05vZGVFcXVhbCh0b3BFbGVtZW50LCBleHBlY3RlZEVsZW1lbnQpKVxuICAgICAgICByZXR1cm4gdG9wRWxlbWVudDtcblxuICAgIGNvbnN0IGlzVFJFRkVsZW1lbnQgPSBhZGFwdGVyLmRvbS5nZXRUYWdOYW1lKGV4cGVjdGVkRWxlbWVudCkgPT09ICd0cmVmJztcblxuICAgIC8vIE5PVEU6ICdkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50JyBjYW4ndCBmaW5kIHRoZXNlIHR5cGVzIG9mIGVsZW1lbnRzXG4gICAgaWYgKGlzVFJFRkVsZW1lbnQpXG4gICAgICAgIHJldHVybiBleHBlY3RlZEVsZW1lbnQ7XG5cbiAgICAvLyBOT1RFOiBUMjk5NjY1IC0gSW5jb3JyZWN0IGNsaWNrIGF1dG9tYXRpb24gZm9yIGltYWdlcyB3aXRoIGFuIGFzc29jaWF0ZWQgbWFwIGVsZW1lbnQgaW4gRmlyZWZveFxuICAgIC8vIEFsbCBicm93c2VycyByZXR1cm4gdGhlIDxhcmVhPiBlbGVtZW50IGZyb20gZG9jdW1lbnQuZ2V0RWxlbWVudEZyb21Qb2ludCwgYnV0XG4gICAgLy8gRmlyZWZveCByZXR1cm5zIHRoZSA8aW1nPiBlbGVtZW50LiBXZSBzaG91bGQgYWNjb21wbGlzaCB0aGlzIGZvciBGaXJlZm94IGFzIHdlbGwuXG4gICAgY29uc3QgaXNJbWFnZU1hcEFyZWEgPSBhZGFwdGVyLmRvbS5nZXRUYWdOYW1lKGV4cGVjdGVkRWxlbWVudCkgPT09ICdhcmVhJyAmJiBhZGFwdGVyLmRvbS5pc0ltZ0VsZW1lbnQodG9wRWxlbWVudCk7XG5cbiAgICBpZiAoYWRhcHRlci5icm93c2VyLmlzRmlyZWZveCAmJiBpc0ltYWdlTWFwQXJlYSlcbiAgICAgICAgcmV0dXJuIGVuc3VyZUltYWdlTWFwKHRvcEVsZW1lbnQsIGV4cGVjdGVkRWxlbWVudCk7XG5cbiAgICAvLyBOT1RFOiB0cnkgdG8gZmluZCBhIG11bHRpLWxpbmUgbGluayBieSBpdHMgcmVjdGFuZ2xlIChUMTYzNjc4KVxuICAgIHJldHVybiBhZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoYWRhcHRlci5kb20uY2xvc2VzdChleHBlY3RlZEVsZW1lbnQsICdhJykpXG4gICAgICAgIC50aGVuKGFuY2hvciA9PiAhIWFuY2hvcilcbiAgICAgICAgLnRoZW4oaXNMaW5rT3JDaGlsZEV4cGVjdGVkID0+IHtcbiAgICAgICAgICAgIGlmICghaXNMaW5rT3JDaGlsZEV4cGVjdGVkKVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICAgICAgcmV0dXJuIGFkYXB0ZXIuUHJvbWlzZUN0b3IucmVzb2x2ZShhZGFwdGVyLmRvbS5jb250YWluc0VsZW1lbnQoZXhwZWN0ZWRFbGVtZW50LCB0b3BFbGVtZW50KSlcbiAgICAgICAgICAgICAgICAudGhlbihjb250YWluc0VsZW1lbnQgPT4gY29udGFpbnNFbGVtZW50ICYmIGFkYXB0ZXIuZG9tLmdldE5vZGVUZXh0KHRvcEVsZW1lbnQpKVxuICAgICAgICAgICAgICAgIC50aGVuKGlzVG9wRWxlbWVudENoaWxkT2ZMaW5rID0+ICFpc1RvcEVsZW1lbnRDaGlsZE9mTGluayAmJiBhZGFwdGVyLmRvbS5nZXROb2RlVGV4dChleHBlY3RlZEVsZW1lbnQpKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oc2hvdWxkU2VhcmNoRm9yTXVsdGlsaW5lTGluayA9PiB7XG4gICAgICAgICAgICBpZiAoIXNob3VsZFNlYXJjaEZvck11bHRpbGluZUxpbmspXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRvcEVsZW1lbnQ7XG5cbiAgICAgICAgICAgIHJldHVybiBhZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoYWRhcHRlci5wb3NpdGlvbi5nZXRDbGllbnREaW1lbnNpb25zKGV4cGVjdGVkRWxlbWVudCkpXG4gICAgICAgICAgICAgICAgLnRoZW4obGlua1JlY3QgPT4gZmluZEVsZW1lbnRPck5vbkVtcHR5Q2hpbGRGcm9tUG9pbnQoeyB4OiBsaW5rUmVjdC5yaWdodCAtIDEsIHk6IGxpbmtSZWN0LnRvcCArIDEgfSwgZXhwZWN0ZWRFbGVtZW50KVxuICAgICAgICAgICAgICAgICAgICAudGhlbihlbCA9PiBlbCB8fCBmaW5kRWxlbWVudE9yTm9uRW1wdHlDaGlsZEZyb21Qb2ludCh7IHg6IGxpbmtSZWN0LmxlZnQgKyAxLCB5OiBsaW5rUmVjdC5ib3R0b20gLSAxIH0sIGV4cGVjdGVkRWxlbWVudCkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGVsID0+IGVsIHx8IHRvcEVsZW1lbnQpKTtcbiAgICAgICAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGdldEVsZW1lbnRGcm9tUG9pbnQ8RSwgVyBleHRlbmRzIFNoYXJlZFdpbmRvdz4gKHBvaW50OiBBeGlzVmFsdWVzRGF0YTxudW1iZXI+LCB3aW46IFcsIGV4cGVjdGVkRWw/OiBFKTogUHJvbWlzZTxFPiB7XG4gICAgcmV0dXJuIGFkYXB0ZXIuZ2V0RWxlbWVudEV4Y2VwdFVJKHBvaW50KVxuICAgICAgICAudGhlbigodG9wRWxlbWVudDogRSkgPT4ge1xuICAgICAgICAgICAgLy8gTk9URTogd2hlbiB0cnlpbmcgdG8gZ2V0IGFuIGVsZW1lbnQgYnkgZWxlbWVudEZyb21Qb2ludCBpbiBpZnJhbWUgYW5kIHRoZSB0YXJnZXRcbiAgICAgICAgICAgIC8vIGVsZW1lbnQgaXMgdW5kZXIgYW55IG9mIHNoYWRvdy11aSBlbGVtZW50cywgeW91IHdpbGwgZ2V0IG51bGwgKG9ubHkgaW4gSUUpLlxuICAgICAgICAgICAgLy8gSW4gdGhpcyBjYXNlLCB5b3Ugc2hvdWxkIGhpZGUgYSB0b3Agd2luZG93J3Mgc2hhZG93LXVpIHJvb3QgdG8gb2J0YWluIGFuIGVsZW1lbnQuXG4gICAgICAgICAgICBsZXQgcmVzQ2hhaW4gPSBhZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUodG9wRWxlbWVudCk7XG5cbiAgICAgICAgICAgIGlmICghdG9wRWxlbWVudCAmJiBpc0lmcmFtZVdpbmRvdyh3aW4pICYmIHBvaW50LnggPiAwICYmIHBvaW50LnkgPiAwKVxuICAgICAgICAgICAgICAgIHJlc0NoYWluID0gcmVzQ2hhaW4udGhlbigoKSA9PiBhZGFwdGVyLmdldEVsZW1lbnRFeGNlcHRVSShwb2ludCwgdHJ1ZSkpO1xuXG4gICAgICAgICAgICByZXR1cm4gcmVzQ2hhaW4udGhlbigoZWxlbWVudDogRSkgPT4gY29ycmVjdFRvcEVsZW1lbnRCeUV4cGVjdGVkRWxlbWVudChlbGVtZW50LCBleHBlY3RlZEVsKSk7XG4gICAgICAgIH0pO1xufVxuIl19