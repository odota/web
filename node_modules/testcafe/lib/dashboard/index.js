"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const prompts_1 = __importDefault(require("prompts"));
const chalk_1 = __importDefault(require("chalk"));
const connector_1 = __importDefault(require("./connector"));
const email_validator_1 = __importDefault(require("email-validator"));
const messages_1 = __importDefault(require("./messages"));
const get_default_project_link_1 = __importDefault(require("./get-default-project-link"));
const config_storage_1 = __importDefault(require("../dashboard/config-storage"));
const formatting_1 = require("./formatting");
const DASHBOARD_DOCUMENTATION_URL = 'https://testcafe.io/dashboard-alpha';
const dashboardConnector = new connector_1.default();
const dashboardConfigStorage = new config_storage_1.default();
async function registerInDashboard() {
    formatting_1.info(messages_1.default.REGISTRATION_ENTER_EMAIL_INVITATION);
    const { email } = await prompts_1.default({
        type: 'text',
        name: 'email',
        message: messages_1.default.PROMPT_EMAIL_CAPTION,
        validate: (input) => {
            if (!email_validator_1.default.validate(input))
                return messages_1.default.PROMPT_INVALID_EMAIL;
            return true;
        },
    });
    if (!email) {
        formatting_1.error(messages_1.default.REGISTRATION_CANCELLED);
        return;
    }
    const sendEmailResult = await dashboardConnector.sendEmail(email);
    if (!sendEmailResult.success) {
        const sendEmailErrorMessage = sendEmailResult.isDashboardError
            ? sendEmailResult.errorMessage
            : messages_1.default.REGISTRATION_EMAIL_SENDING_NETWORK_ERROR;
        formatting_1.error(sendEmailErrorMessage);
        return;
    }
    formatting_1.info(messages_1.default.REGISTRATION_EMAIL_SENT);
    const { token } = await prompts_1.default({
        type: 'text',
        name: 'token',
        message: messages_1.default.PROMPT_TOKEN_CAPTION,
    });
    if (!token) {
        formatting_1.error(messages_1.default.REGISTRATION_CANCELLED);
        return;
    }
    const validationResult = await dashboardConnector.validateToken(token);
    if (!validationResult.success) {
        const validationResultErrorMessage = validationResult.isDashboardError
            ? validationResult.errorMessage
            : messages_1.default.TOKEN_VALIDATION_NETWORK_ERROR;
        formatting_1.error(validationResultErrorMessage);
        return;
    }
    dashboardConfigStorage.options.sendReport = true;
    await saveNewToken(token);
    formatting_1.success(messages_1.default.REGISTRATION_FINISHED);
    formatting_1.info('View test results at:\n' +
        `${chalk_1.default.underline.blueBright(get_default_project_link_1.default(token))}`);
    formatting_1.info(`Run ${chalk_1.default.black.bgWhiteBright('testcafe dashboard off')} to disable this behavior.` +
        `Learn more at:\n${chalk_1.default.underline.blueBright(DASHBOARD_DOCUMENTATION_URL)}`);
}
async function saveNewToken(token) {
    dashboardConfigStorage.options.token = token;
    await dashboardConfigStorage.save();
}
async function updateDefaultToken() {
    if (!dashboardConfigStorage.options.sendReport)
        formatting_1.warning(messages_1.default.TOKEN_UPDATING_NOT_SEND_REPORT);
    // NOTE: for the formatting reason
    formatting_1.info('');
    const { doYouWantToUpdateDefaultToken } = await prompts_1.default({
        type: 'confirm',
        name: 'doYouWantToUpdateDefaultToken',
        message: 'Your setup includes a default Dashboard token. Do you want to change it?:',
    });
    if (!doYouWantToUpdateDefaultToken) {
        formatting_1.error(messages_1.default.TOKEN_UPDATE_CANCELLED);
        return;
    }
    // NOTE: for the formatting reason
    formatting_1.info('');
    const { newToken } = await prompts_1.default({
        type: 'text',
        name: 'newToken',
        message: 'Enter the new default token value:',
    });
    if (!newToken) {
        formatting_1.error(messages_1.default.TOKEN_UPDATE_CANCELLED);
        return;
    }
    const validationResult = await dashboardConnector.validateToken(newToken);
    if (!validationResult.success) {
        const validationResultErrorMessage = validationResult.isDashboardError
            ? validationResult.errorMessage
            : messages_1.default.TOKEN_VALIDATION_NETWORK_ERROR;
        formatting_1.error(validationResultErrorMessage);
        return;
    }
    await saveNewToken(newToken);
    formatting_1.success(messages_1.default.TOKEN_UPDATED);
}
async function setSendReportState(state) {
    const sendReportAsBoolean = state === 'on';
    dashboardConfigStorage.options.sendReport = sendReportAsBoolean;
    await dashboardConfigStorage.save();
    const resultMessage = sendReportAsBoolean ? messages_1.default.SEND_REPORT_STATE_ON : messages_1.default.SEND_REPORT_STATE_OFF;
    formatting_1.success(resultMessage);
}
async function tryToRegisterInDashboard() {
    formatting_1.info(messages_1.default.TOKEN_NO_DEFAULT_FOUND);
    const { launchConfigurationWizard } = await prompts_1.default({
        type: 'confirm',
        name: 'launchConfigurationWizard',
        message: 'Do you want to launch the configuration wizard?',
        initial: true,
    });
    if (!launchConfigurationWizard) {
        formatting_1.error(messages_1.default.REGISTRATION_CANCELLED);
        return;
    }
    await registerInDashboard();
}
async function default_1(sendReportState) {
    const storageExists = await dashboardConfigStorage.load();
    if (sendReportState !== void 0) {
        if (storageExists)
            await setSendReportState(sendReportState);
        else
            await tryToRegisterInDashboard();
        return;
    }
    const thereIsDefaultToken = !!dashboardConfigStorage.options.token;
    if (thereIsDefaultToken)
        await updateDefaultToken();
    else
        await registerInDashboard();
}
exports.default = default_1;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGFzaGJvYXJkL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQThCO0FBQzlCLGtEQUEwQjtBQUMxQiw0REFBNkM7QUFDN0Msc0VBQTZDO0FBQzdDLDBEQUFrQztBQUNsQywwRkFBK0Q7QUFDL0QsaUZBQWlFO0FBR2pFLDZDQUtzQjtBQUV0QixNQUFNLDJCQUEyQixHQUFHLHFDQUFxQyxDQUFDO0FBRTFFLE1BQU0sa0JBQWtCLEdBQU8sSUFBSSxtQkFBa0IsRUFBRSxDQUFDO0FBQ3hELE1BQU0sc0JBQXNCLEdBQUcsSUFBSSx3QkFBc0IsRUFBRSxDQUFDO0FBRTVELEtBQUssVUFBVSxtQkFBbUI7SUFDOUIsaUJBQUksQ0FBQyxrQkFBUSxDQUFDLG1DQUFtQyxDQUFDLENBQUM7SUFFbkQsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0saUJBQU8sQ0FBQztRQUM1QixJQUFJLEVBQU0sTUFBTTtRQUNoQixJQUFJLEVBQU0sT0FBTztRQUNqQixPQUFPLEVBQUcsa0JBQVEsQ0FBQyxvQkFBb0I7UUFDdkMsUUFBUSxFQUFFLENBQUMsS0FBYSxFQUFFLEVBQUU7WUFDeEIsSUFBSSxDQUFDLHlCQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztnQkFDL0IsT0FBTyxrQkFBUSxDQUFDLG9CQUFvQixDQUFDO1lBRXpDLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7S0FDSixDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ1Isa0JBQUssQ0FBQyxrQkFBUSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFFdkMsT0FBTztLQUNWO0lBRUQsTUFBTSxlQUFlLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFbEUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLEVBQUU7UUFDMUIsTUFBTSxxQkFB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QztJQUVILElBQUksQ0FBQyx5QkFBeUIsRUFBRTtRQUM1QixrQkFBSyxDQUFDLGtCQUFRLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUV2QyxPQUFPO0tBQ1Y7SUFFRCxNQUFNLG1CQUFtQixFQUFFLENBQUM7QUFDaEMsQ0FBQztBQUVjLEtBQUssb0JBQVcsZUFBZ0M7SUFDM0QsTUFBTSxhQUFhLEdBQUcsTUFBTSxzQkFBc0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUUxRCxJQUFJLGVBQWUsS0FBSyxLQUFLLENBQUMsRUFBRTtRQUM1QixJQUFJLGFBQWE7WUFDYixNQUFNLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxDQUFDOztZQUUxQyxNQUFNLHdCQUF3QixFQUFFLENBQUM7UUFFckMsT0FBTztLQUNWO0lBRUQsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUVuRSxJQUFJLG1CQUFtQjtRQUNuQixNQUFNLGtCQUFrQixFQUFFLENBQUM7O1FBRTNCLE1BQU0sbUJBQW1CLEVBQUUsQ0FBQztBQUNwQyxDQUFDO0FBbEJELDRCQWtCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwcm9tcHRzIGZyb20gJ3Byb21wdHMnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBEYXNoYm9hcmRDb25uZWN0b3IgZnJvbSAnLi9jb25uZWN0b3InO1xuaW1wb3J0IGVtYWlsVmFsaWRhdG9yIGZyb20gJ2VtYWlsLXZhbGlkYXRvcic7XG5pbXBvcnQgbWVzc2FnZXMgZnJvbSAnLi9tZXNzYWdlcyc7XG5pbXBvcnQgZ2V0RGVmYXVsdFByb2plY3RMaW5rIGZyb20gJy4vZ2V0LWRlZmF1bHQtcHJvamVjdC1saW5rJztcbmltcG9ydCBEYXNoYm9hcmRDb25maWdTdG9yYWdlIGZyb20gJy4uL2Rhc2hib2FyZC9jb25maWctc3RvcmFnZSc7XG5pbXBvcnQgeyBTZW5kUmVwb3J0U3RhdGUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG5pbXBvcnQge1xuICAgIGluZm8sXG4gICAgd2FybmluZyxcbiAgICBlcnJvcixcbiAgICBzdWNjZXNzLFxufSBmcm9tICcuL2Zvcm1hdHRpbmcnO1xuXG5jb25zdCBEQVNIQk9BUkRfRE9DVU1FTlRBVElPTl9VUkwgPSAnaHR0cHM6Ly90ZXN0Y2FmZS5pby9kYXNoYm9hcmQtYWxwaGEnO1xuXG5jb25zdCBkYXNoYm9hcmRDb25uZWN0b3IgICAgID0gbmV3IERhc2hib2FyZENvbm5lY3RvcigpO1xuY29uc3QgZGFzaGJvYXJkQ29uZmlnU3RvcmFnZSA9IG5ldyBEYXNoYm9hcmRDb25maWdTdG9yYWdlKCk7XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVySW5EYXNoYm9hcmQgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGluZm8obWVzc2FnZXMuUkVHSVNUUkFUSU9OX0VOVEVSX0VNQUlMX0lOVklUQVRJT04pO1xuXG4gICAgY29uc3QgeyBlbWFpbCB9ID0gYXdhaXQgcHJvbXB0cyh7XG4gICAgICAgIHR5cGU6ICAgICAndGV4dCcsXG4gICAgICAgIG5hbWU6ICAgICAnZW1haWwnLFxuICAgICAgICBtZXNzYWdlOiAgbWVzc2FnZXMuUFJPTVBUX0VNQUlMX0NBUFRJT04sXG4gICAgICAgIHZhbGlkYXRlOiAoaW5wdXQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgaWYgKCFlbWFpbFZhbGlkYXRvci52YWxpZGF0ZShpbnB1dCkpXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzLlBST01QVF9JTlZBTElEX0VNQUlMO1xuXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmICghZW1haWwpIHtcbiAgICAgICAgZXJyb3IobWVzc2FnZXMuUkVHSVNUUkFUSU9OX0NBTkNFTExFRCk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHNlbmRFbWFpbFJlc3VsdCA9IGF3YWl0IGRhc2hib2FyZENvbm5lY3Rvci5zZW5kRW1haWwoZW1haWwpO1xuXG4gICAgaWYgKCFzZW5kRW1haWxSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICBjb25zdCBzZW5kRW1haWxFcnJvck1lc3NhZ2UgPSBzZW5kRW1haWxSZXN1bHQuaXNEYXNoYm9hcmRFcnJvclxuICAgICAgICAgICAgPyBzZW5kRW1haWxSZXN1bHQuZXJyb3JNZXNzYWdlXG4gICAgICAgICAgICA6IG1lc3NhZ2VzLlJFR0lTVFJBVElPTl9FTUFJTF9TRU5ESU5HX05FVFdPUktfRVJST1I7XG5cbiAgICAgICAgZXJyb3Ioc2VuZEVtYWlsRXJyb3JNZXNzYWdlKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaW5mbyhtZXNzYWdlcy5SRUdJU1RSQVRJT05fRU1BSUxfU0VOVCk7XG5cbiAgICBjb25zdCB7IHRva2VuIH0gPSBhd2FpdCBwcm9tcHRzKHtcbiAgICAgICAgdHlwZTogICAgJ3RleHQnLFxuICAgICAgICBuYW1lOiAgICAndG9rZW4nLFxuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlcy5QUk9NUFRfVE9LRU5fQ0FQVElPTixcbiAgICB9KTtcblxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgZXJyb3IobWVzc2FnZXMuUkVHSVNUUkFUSU9OX0NBTkNFTExFRCk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSBhd2FpdCBkYXNoYm9hcmRDb25uZWN0b3IudmFsaWRhdGVUb2tlbih0b2tlbik7XG5cbiAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0RXJyb3JNZXNzYWdlID0gdmFsaWRhdGlvblJlc3VsdC5pc0Rhc2hib2FyZEVycm9yXG4gICAgICAgICAgICA/IHZhbGlkYXRpb25SZXN1bHQuZXJyb3JNZXNzYWdlXG4gICAgICAgICAgICA6IG1lc3NhZ2VzLlRPS0VOX1ZBTElEQVRJT05fTkVUV09SS19FUlJPUjtcblxuICAgICAgICBlcnJvcih2YWxpZGF0aW9uUmVzdWx0RXJyb3JNZXNzYWdlKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZGFzaGJvYXJkQ29uZmlnU3RvcmFnZS5vcHRpb25zLnNlbmRSZXBvcnQgPSB0cnVlO1xuXG4gICAgYXdhaXQgc2F2ZU5ld1Rva2VuKHRva2VuKTtcblxuICAgIHN1Y2Nlc3MobWVzc2FnZXMuUkVHSVNUUkFUSU9OX0ZJTklTSEVEKTtcblxuICAgIGluZm8oXG4gICAgICAgICdWaWV3IHRlc3QgcmVzdWx0cyBhdDpcXG4nICtcbiAgICAgICAgYCR7Y2hhbGsudW5kZXJsaW5lLmJsdWVCcmlnaHQoZ2V0RGVmYXVsdFByb2plY3RMaW5rKHRva2VuKSl9YFxuICAgICk7XG5cbiAgICBpbmZvKFxuICAgICAgICBgUnVuICR7Y2hhbGsuYmxhY2suYmdXaGl0ZUJyaWdodCgndGVzdGNhZmUgZGFzaGJvYXJkIG9mZicpfSB0byBkaXNhYmxlIHRoaXMgYmVoYXZpb3IuYCArXG4gICAgICAgIGBMZWFybiBtb3JlIGF0OlxcbiR7Y2hhbGsudW5kZXJsaW5lLmJsdWVCcmlnaHQoREFTSEJPQVJEX0RPQ1VNRU5UQVRJT05fVVJMKX1gXG4gICAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2F2ZU5ld1Rva2VuICh0b2tlbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgZGFzaGJvYXJkQ29uZmlnU3RvcmFnZS5vcHRpb25zLnRva2VuID0gdG9rZW47XG5cbiAgICBhd2FpdCBkYXNoYm9hcmRDb25maWdTdG9yYWdlLnNhdmUoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlRGVmYXVsdFRva2VuICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWRhc2hib2FyZENvbmZpZ1N0b3JhZ2Uub3B0aW9ucy5zZW5kUmVwb3J0KVxuICAgICAgICB3YXJuaW5nKG1lc3NhZ2VzLlRPS0VOX1VQREFUSU5HX05PVF9TRU5EX1JFUE9SVCk7XG5cbiAgICAvLyBOT1RFOiBmb3IgdGhlIGZvcm1hdHRpbmcgcmVhc29uXG4gICAgaW5mbygnJyk7XG5cbiAgICBjb25zdCB7IGRvWW91V2FudFRvVXBkYXRlRGVmYXVsdFRva2VuIH0gPSBhd2FpdCBwcm9tcHRzKHtcbiAgICAgICAgdHlwZTogICAgJ2NvbmZpcm0nLFxuICAgICAgICBuYW1lOiAgICAnZG9Zb3VXYW50VG9VcGRhdGVEZWZhdWx0VG9rZW4nLFxuICAgICAgICBtZXNzYWdlOiAnWW91ciBzZXR1cCBpbmNsdWRlcyBhIGRlZmF1bHQgRGFzaGJvYXJkIHRva2VuLiBEbyB5b3Ugd2FudCB0byBjaGFuZ2UgaXQ/OicsXG4gICAgfSk7XG5cbiAgICBpZiAoIWRvWW91V2FudFRvVXBkYXRlRGVmYXVsdFRva2VuKSB7XG4gICAgICAgIGVycm9yKG1lc3NhZ2VzLlRPS0VOX1VQREFURV9DQU5DRUxMRUQpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBOT1RFOiBmb3IgdGhlIGZvcm1hdHRpbmcgcmVhc29uXG4gICAgaW5mbygnJyk7XG5cbiAgICBjb25zdCB7IG5ld1Rva2VuIH0gPSBhd2FpdCBwcm9tcHRzKHtcbiAgICAgICAgdHlwZTogICAgJ3RleHQnLFxuICAgICAgICBuYW1lOiAgICAnbmV3VG9rZW4nLFxuICAgICAgICBtZXNzYWdlOiAnRW50ZXIgdGhlIG5ldyBkZWZhdWx0IHRva2VuIHZhbHVlOicsXG4gICAgfSk7XG5cbiAgICBpZiAoIW5ld1Rva2VuKSB7XG4gICAgICAgIGVycm9yKG1lc3NhZ2VzLlRPS0VOX1VQREFURV9DQU5DRUxMRUQpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gYXdhaXQgZGFzaGJvYXJkQ29ubmVjdG9yLnZhbGlkYXRlVG9rZW4obmV3VG9rZW4pO1xuXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdEVycm9yTWVzc2FnZSA9IHZhbGlkYXRpb25SZXN1bHQuaXNEYXNoYm9hcmRFcnJvclxuICAgICAgICAgICAgPyB2YWxpZGF0aW9uUmVzdWx0LmVycm9yTWVzc2FnZVxuICAgICAgICAgICAgOiBtZXNzYWdlcy5UT0tFTl9WQUxJREFUSU9OX05FVFdPUktfRVJST1I7XG5cbiAgICAgICAgZXJyb3IodmFsaWRhdGlvblJlc3VsdEVycm9yTWVzc2FnZSk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGF3YWl0IHNhdmVOZXdUb2tlbihuZXdUb2tlbik7XG5cbiAgICBzdWNjZXNzKG1lc3NhZ2VzLlRPS0VOX1VQREFURUQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRTZW5kUmVwb3J0U3RhdGUgKHN0YXRlOiBTZW5kUmVwb3J0U3RhdGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzZW5kUmVwb3J0QXNCb29sZWFuID0gc3RhdGUgPT09ICdvbic7XG5cbiAgICBkYXNoYm9hcmRDb25maWdTdG9yYWdlLm9wdGlvbnMuc2VuZFJlcG9ydCA9IHNlbmRSZXBvcnRBc0Jvb2xlYW47XG5cbiAgICBhd2FpdCBkYXNoYm9hcmRDb25maWdTdG9yYWdlLnNhdmUoKTtcblxuICAgIGNvbnN0IHJlc3VsdE1lc3NhZ2UgPSBzZW5kUmVwb3J0QXNCb29sZWFuID8gbWVzc2FnZXMuU0VORF9SRVBPUlRfU1RBVEVfT04gOiBtZXNzYWdlcy5TRU5EX1JFUE9SVF9TVEFURV9PRkY7XG5cbiAgICBzdWNjZXNzKHJlc3VsdE1lc3NhZ2UpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB0cnlUb1JlZ2lzdGVySW5EYXNoYm9hcmQgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGluZm8obWVzc2FnZXMuVE9LRU5fTk9fREVGQVVMVF9GT1VORCk7XG5cbiAgICBjb25zdCB7IGxhdW5jaENvbmZpZ3VyYXRpb25XaXphcmQgfSA9IGF3YWl0IHByb21wdHMoe1xuICAgICAgICB0eXBlOiAgICAnY29uZmlybScsXG4gICAgICAgIG5hbWU6ICAgICdsYXVuY2hDb25maWd1cmF0aW9uV2l6YXJkJyxcbiAgICAgICAgbWVzc2FnZTogJ0RvIHlvdSB3YW50IHRvIGxhdW5jaCB0aGUgY29uZmlndXJhdGlvbiB3aXphcmQ/JyxcbiAgICAgICAgaW5pdGlhbDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGlmICghbGF1bmNoQ29uZmlndXJhdGlvbldpemFyZCkge1xuICAgICAgICBlcnJvcihtZXNzYWdlcy5SRUdJU1RSQVRJT05fQ0FOQ0VMTEVEKTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYXdhaXQgcmVnaXN0ZXJJbkRhc2hib2FyZCgpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoc2VuZFJlcG9ydFN0YXRlOiBTZW5kUmVwb3J0U3RhdGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzdG9yYWdlRXhpc3RzID0gYXdhaXQgZGFzaGJvYXJkQ29uZmlnU3RvcmFnZS5sb2FkKCk7XG5cbiAgICBpZiAoc2VuZFJlcG9ydFN0YXRlICE9PSB2b2lkIDApIHtcbiAgICAgICAgaWYgKHN0b3JhZ2VFeGlzdHMpXG4gICAgICAgICAgICBhd2FpdCBzZXRTZW5kUmVwb3J0U3RhdGUoc2VuZFJlcG9ydFN0YXRlKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgYXdhaXQgdHJ5VG9SZWdpc3RlckluRGFzaGJvYXJkKCk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHRoZXJlSXNEZWZhdWx0VG9rZW4gPSAhIWRhc2hib2FyZENvbmZpZ1N0b3JhZ2Uub3B0aW9ucy50b2tlbjtcblxuICAgIGlmICh0aGVyZUlzRGVmYXVsdFRva2VuKVxuICAgICAgICBhd2FpdCB1cGRhdGVEZWZhdWx0VG9rZW4oKTtcbiAgICBlbHNlXG4gICAgICAgIGF3YWl0IHJlZ2lzdGVySW5EYXNoYm9hcmQoKTtcbn1cbiJdfQ==