"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const promisified_functions_1 = require("../utils/promisified-functions");
const runtime_1 = require("../errors/runtime");
const types_1 = require("../errors/types");
const path_1 = require("path");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const crypto_1 = require("crypto");
const BEAUTIFY_REGEXP = /[/.:\s\\]/g;
const BEAUTIFY_CHAR = '_';
const EMPTY_CONTENT_STR = '{ content: <empty> }';
const CONTENT_STR_MAX_LENGTH = 30;
const CONTENT_ELLIPSIS_STR = '...';
const URL_UNIQUE_PART_LENGTH = 7;
class ClientScript {
    constructor(init, basePath) {
        this.init = init || null;
        this.url = testcafe_hammerhead_1.generateUniqueId(URL_UNIQUE_PART_LENGTH);
        this.content = '';
        this.path = null;
        this.module = null;
        this.hash = null;
        this.page = testcafe_hammerhead_1.RequestFilterRule.ANY;
        this.basePath = basePath;
    }
    _resolvePath(path) {
        let resolvedPath = null;
        if (path_1.isAbsolute(path))
            resolvedPath = path;
        else {
            if (!this.basePath)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptBasePathIsNotSpecified);
            resolvedPath = path_1.join(this.basePath, path);
        }
        return resolvedPath;
    }
    async _loadFromPath(path) {
        const resolvedPath = this._resolvePath(path);
        try {
            this.path = resolvedPath;
            this.content = await promisified_functions_1.readFile(this.path);
            this.content = this.content.toString();
            this.url = path || this.url;
        }
        catch (e) {
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.cannotLoadClientScriptFromPath, path, e.message);
        }
    }
    async _loadFromModule(name) {
        let resolvedPath = null;
        try {
            resolvedPath = require.resolve(name);
        }
        catch (e) {
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptModuleEntryPointPathCalculationError, e.message);
        }
        await this._loadFromPath(resolvedPath);
        this.module = name;
    }
    _prepareUrl() {
        this.url = this.url.replace(BEAUTIFY_REGEXP, BEAUTIFY_CHAR).toLowerCase();
    }
    async load() {
        if (this.init === null)
            throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptInitializerIsNotSpecified);
        else if (typeof this.init === 'string')
            await this._loadFromPath(this.init);
        else {
            const { path: initPath, content: initContent, module: initModule, page: initPage } = this.init;
            if (initPath && initContent || initPath && initModule || initContent && initModule)
                throw new runtime_1.GeneralError(types_1.RUNTIME_ERRORS.clientScriptInitializerMultipleContentSources);
            if (initPath)
                await this._loadFromPath(initPath);
            else if (initModule)
                await this._loadFromModule(initModule);
            else
                this.content = initContent;
            if (initPage)
                this.page = new testcafe_hammerhead_1.RequestFilterRule(initPage);
        }
        this._calculateHash();
        this._prepareUrl();
    }
    _calculateHash() {
        this.hash = crypto_1.createHash('md5').update(this.content).digest();
    }
    _contentToString() {
        let displayContent;
        if (this.content.length <= CONTENT_STR_MAX_LENGTH - CONTENT_ELLIPSIS_STR.length)
            displayContent = this.content;
        else
            displayContent = this.content.substring(0, CONTENT_STR_MAX_LENGTH - CONTENT_ELLIPSIS_STR.length) + CONTENT_ELLIPSIS_STR;
        return `{ content: '${displayContent}' }`;
    }
    toString() {
        if (!this.content)
            return EMPTY_CONTENT_STR;
        else if (this.content && !this.path)
            return this._contentToString();
        return `{ path: '${this.path}' }`;
    }
    static get URL_UNIQUE_PART_LENGTH() {
        return URL_UNIQUE_PART_LENGTH;
    }
}
exports.default = ClientScript;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LXNjcmlwdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jdXN0b20tY2xpZW50LXNjcmlwdHMvY2xpZW50LXNjcmlwdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDBFQUEwRDtBQUMxRCwrQ0FBaUQ7QUFDakQsMkNBQWlEO0FBQ2pELCtCQUF3QztBQUN4Qyw2REFBMEU7QUFDMUUsbUNBQW9DO0FBR3BDLE1BQU0sZUFBZSxHQUFHLFlBQVksQ0FBQztBQUNyQyxNQUFNLGFBQWEsR0FBSyxHQUFHLENBQUM7QUFFNUIsTUFBTSxpQkFBaUIsR0FBUSxzQkFBc0IsQ0FBQztBQUN0RCxNQUFNLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztBQUNsQyxNQUFNLG9CQUFvQixHQUFLLEtBQUssQ0FBQztBQUVyQyxNQUFNLHNCQUFzQixHQUFHLENBQUMsQ0FBQztBQUVqQyxNQUFxQixZQUFZO0lBVTdCLFlBQW9CLElBQStCLEVBQUUsUUFBZ0I7UUFDakUsSUFBSSxDQUFDLElBQUksR0FBTyxJQUFJLElBQUksSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxHQUFHLEdBQVEsc0NBQWdCLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsT0FBTyxHQUFJLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFLLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFPLHVDQUFpQixDQUFDLEdBQUcsQ0FBQztRQUN0QyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBRU8sWUFBWSxDQUFFLElBQVk7UUFDOUIsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBRXhCLElBQUksaUJBQVUsQ0FBQyxJQUFJLENBQUM7WUFDaEIsWUFBWSxHQUFH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RSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRU8sY0FBYztRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLG1CQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoRSxDQUFDO0lBRU8sZ0JBQWdCO1FBQ3BCLElBQUksY0FBYyxDQUFDO1FBRW5CLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksc0JBQXNCLEdBQUcsb0JBQW9CLENBQUMsTUFBTTtZQUMzRSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQzs7WUFFOUIsY0FBYyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxzQkFBc0IsR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxvQkFBb0IsQ0FBQztRQUU1SCxPQUFPLGVBQWUsY0FBYyxLQUFLLENBQUM7SUFDOUMsQ0FBQztJQUVNLFFBQVE7UUFDWCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87WUFDYixPQUFPLGlCQUFpQixDQUFDO2FBRXhCLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJO1lBQy9CLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFFbkMsT0FBTyxZQUFZLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQztJQUN0QyxDQUFDO0lBRU0sTUFBTSxLQUFLLHNCQUFzQjtRQUNwQyxPQUFPLHNCQUFzQixDQUFDO0lBQ2xDLENBQUM7Q0FDSjtBQTNIRCwrQkEySEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkRmlsZSB9IGZyb20gJy4uL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucyc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBSVU5USU1FX0VSUk9SUyB9IGZyb20gJy4uL2Vycm9ycy90eXBlcyc7XG5pbXBvcnQgeyBpc0Fic29sdXRlLCBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBSZXF1ZXN0RmlsdGVyUnVsZSwgZ2VuZXJhdGVVbmlxdWVJZCB9IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgQ2xpZW50U2NyaXB0SW5pdCBmcm9tICcuL2NsaWVudC1zY3JpcHQtaW5pdCc7XG5cbmNvbnN0IEJFQVVUSUZZX1JFR0VYUCA9IC9bLy46XFxzXFxcXF0vZztcbmNvbnN0IEJFQVVUSUZZX0NIQVIgICA9ICdfJztcblxuY29uc3QgRU1QVFlfQ09OVEVOVF9TVFIgICAgICA9ICd7IGNvbnRlbnQ6IDxlbXB0eT4gfSc7XG5jb25zdCBDT05URU5UX1NUUl9NQVhfTEVOR1RIID0gMzA7XG5jb25zdCBDT05URU5UX0VMTElQU0lTX1NUUiAgID0gJy4uLic7XG5cbmNvbnN0IFVSTF9VTklRVUVfUEFSVF9MRU5HVEggPSA3O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDbGllbnRTY3JpcHQge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgaW5pdDogbnVsbCB8IHN0cmluZyB8IENsaWVudFNjcmlwdEluaXQ7XG4gICAgcHVibGljIHVybDogc3RyaW5nO1xuICAgIHB1YmxpYyBjb250ZW50OiBzdHJpbmc7XG4gICAgcHVibGljIHBhdGg6IHN0cmluZyB8IG51bGw7XG4gICAgcHVibGljIG1vZHVsZTogc3RyaW5nIHwgbnVsbDtcbiAgICBwdWJsaWMgaGFzaDogQnVmZmVyIHwgbnVsbDtcbiAgICBwdWJsaWMgcGFnZTogUmVxdWVzdEZpbHRlclJ1bGU7XG4gICAgcHJpdmF0ZSByZWFkb25seSBiYXNlUGF0aDogc3RyaW5nO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChpbml0OiBzdHJpbmcgfCBDbGllbnRTY3JpcHRJbml0LCBiYXNlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuaW5pdCAgICAgPSBpbml0IHx8IG51bGw7XG4gICAgICAgIHRoaXMudXJsICAgICAgPSBnZW5lcmF0ZVVuaXF1ZUlkKFVSTF9VTklRVUVfUEFSVF9MRU5HVEgpO1xuICAgICAgICB0aGlzLmNvbnRlbnQgID0gJyc7XG4gICAgICAgIHRoaXMucGF0aCAgICAgPSBudWxsO1xuICAgICAgICB0aGlzLm1vZHVsZSAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5oYXNoICAgICA9IG51bGw7XG4gICAgICAgIHRoaXMucGFnZSAgICAgPSBSZXF1ZXN0RmlsdGVyUnVsZS5BTlk7XG4gICAgICAgIHRoaXMuYmFzZVBhdGggPSBiYXNlUGF0aDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZXNvbHZlUGF0aCAocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IHJlc29sdmVkUGF0aCA9IG51bGw7XG5cbiAgICAgICAgaWYgKGlzQWJzb2x1dGUocGF0aCkpXG4gICAgICAgICAgICByZXNvbHZlZFBhdGggPSBwYXRoO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5iYXNlUGF0aClcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNsaWVudFNjcmlwdEJhc2VQYXRoSXNOb3RTcGVjaWZpZWQpO1xuXG4gICAgICAgICAgICByZXNvbHZlZFBhdGggPSBqb2luKHRoaXMuYmFzZVBhdGgsIHBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmVkUGF0aDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9sb2FkRnJvbVBhdGggKHBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCByZXNvbHZlZFBhdGggPSB0aGlzLl9yZXNvbHZlUGF0aChwYXRoKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5wYXRoICAgID0gcmVzb2x2ZWRQYXRoO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50ID0gYXdhaXQgcmVhZEZpbGUodGhpcy5wYXRoKTtcbiAgICAgICAgICAgIHRoaXMuY29udGVudCA9IHRoaXMuY29udGVudC50b1N0cmluZygpO1xuICAgICAgICAgICAgdGhpcy51cmwgICAgID0gcGF0aCB8fCB0aGlzLnVybDtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5jYW5ub3RMb2FkQ2xpZW50U2NyaXB0RnJvbVBhdGgsIHBhdGgsIGUubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9sb2FkRnJvbU1vZHVsZSAobmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxldCByZXNvbHZlZFBhdGggPSBudWxsO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXNvbHZlZFBhdGggPSByZXF1aXJlLnJlc29sdmUobmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2xpZW50U2NyaXB0TW9kdWxlRW50cnlQb2ludFBhdGhDYWxjdWxhdGlvbkVycm9yLCBlLm1lc3NhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZyb21QYXRoKHJlc29sdmVkUGF0aCk7XG5cbiAgICAgICAgdGhpcy5tb2R1bGUgPSBuYW1lO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3ByZXBhcmVVcmwgKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnVybCA9IHRoaXMudXJsLnJlcGxhY2UoQkVBVVRJRllfUkVHRVhQLCBCRUFVVElGWV9DSEFSKS50b0xvd2VyQ2FzZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBsb2FkICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMuaW5pdCA9PT0gbnVsbClcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2xpZW50U2NyaXB0SW5pdGlhbGl6ZXJJc05vdFNwZWNpZmllZCk7XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiB0aGlzLmluaXQgPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fbG9hZEZyb21QYXRoKHRoaXMuaW5pdCk7XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgeyBwYXRoOiBpbml0UGF0aCwgY29udGVudDogaW5pdENvbnRlbnQsIG1vZHVsZTogaW5pdE1vZHVsZSwgcGFnZTogaW5pdFBhZ2UgfSA9IHRoaXMuaW5pdCBhcyBDbGllbnRTY3JpcHRJbml0O1xuXG4gICAgICAgICAgICBpZiAoaW5pdFBhdGggJiYgaW5pdENvbnRlbnQgfHwgaW5pdFBhdGggJiYgaW5pdE1vZHVsZSB8fCBpbml0Q29udGVudCAmJiBpbml0TW9kdWxlKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2xpZW50U2NyaXB0SW5pdGlhbGl6ZXJNdWx0aXBsZUNvbnRlbnRTb3VyY2VzKTtcblxuICAgICAgICAgICAgaWYgKGluaXRQYXRoKVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGcm9tUGF0aChpbml0UGF0aCk7XG4gICAgICAgICAgICBlbHNlIGlmIChpbml0TW9kdWxlKVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2xvYWRGcm9tTW9kdWxlKGluaXRNb2R1bGUpO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHRoaXMuY29udGVudCA9IGluaXRDb250ZW50O1xuXG4gICAgICAgICAgICBpZiAoaW5pdFBhZ2UpXG4gICAgICAgICAgICAgICAgdGhpcy5wYWdlID0gbmV3IFJlcXVlc3RGaWx0ZXJSdWxlKGluaXRQYWdlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2NhbGN1bGF0ZUhhc2goKTtcbiAgICAgICAgdGhpcy5fcHJlcGFyZVVybCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NhbGN1bGF0ZUhhc2ggKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2ggPSBjcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUodGhpcy5jb250ZW50KS5kaWdlc3QoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jb250ZW50VG9TdHJpbmcgKCk6IHN0cmluZyB7XG4gICAgICAgIGxldCBkaXNwbGF5Q29udGVudDtcblxuICAgICAgICBpZiAodGhpcy5jb250ZW50Lmxlbmd0aCA8PSBDT05URU5UX1NUUl9NQVhfTEVOR1RIIC0gQ09OVEVOVF9FTExJUFNJU19TVFIubGVuZ3RoKVxuICAgICAgICAgICAgZGlzcGxheUNvbnRlbnQgPSB0aGlzLmNvbnRlbnQ7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGRpc3BsYXlDb250ZW50ID0gdGhpcy5jb250ZW50LnN1YnN0cmluZygwLCBDT05URU5UX1NUUl9NQVhfTEVOR1RIIC0gQ09OVEVOVF9FTExJUFNJU19TVFIubGVuZ3RoKSArIENPTlRFTlRfRUxMSVBTSVNfU1RSO1xuXG4gICAgICAgIHJldHVybiBgeyBjb250ZW50OiAnJHtkaXNwbGF5Q29udGVudH0nIH1gO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b1N0cmluZyAoKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRlbnQpXG4gICAgICAgICAgICByZXR1cm4gRU1QVFlfQ09OVEVOVF9TVFI7XG5cbiAgICAgICAgZWxzZSBpZiAodGhpcy5jb250ZW50ICYmICF0aGlzLnBhdGgpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fY29udGVudFRvU3RyaW5nKCk7XG5cbiAgICAgICAgcmV0dXJuIGB7IHBhdGg6ICcke3RoaXMucGF0aH0nIH1gO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IFVSTF9VTklRVUVfUEFSVF9MRU5HVEggKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiBVUkxfVU5JUVVFX1BBUlRfTEVOR1RIO1xuICAgIH1cbn1cbiJdfQ==