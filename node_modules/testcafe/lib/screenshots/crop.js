"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cropScreenshot = exports.calculateClipInfo = exports.getClipInfoByCropDimensions = exports.getClipInfoByMarkPosition = exports.calculateMarkPosition = void 0;
const utils_1 = require("./utils");
const limit_number_1 = __importDefault(require("../utils/limit-number"));
const render_template_1 = __importDefault(require("../utils/render-template"));
const promisified_functions_1 = require("../utils/promisified-functions");
const test_run_1 = require("../errors/test-run/");
const constants_1 = require("./constants");
const warning_message_1 = __importDefault(require("../notifications/warning-message"));
const MARK_SEED_ERROR_THRESHOLD = 10;
const WHITE_COLOR_PART = 255;
const BLACK_COLOR_PART = 0;
function markSeedToId(markSeed) {
    let id = 0;
    for (let i = 0; i < constants_1.MARK_LENGTH; i++)
        id = id * 2 + (markSeed[i * constants_1.MARK_BYTES_PER_PIXEL] ? 1 : 0);
    return id;
}
function getCorrectedColorPart(colorPart) {
    const isWhite = colorPart > WHITE_COLOR_PART - MARK_SEED_ERROR_THRESHOLD;
    const isBlack = colorPart < MARK_SEED_ERROR_THRESHOLD;
    if (isBlack)
        return BLACK_COLOR_PART;
    if (isWhite)
        return WHITE_COLOR_PART;
    return colorPart;
}
async function validateClipInfo(clipInfo, path) {
    const clipWidth = clipInfo.clipRight - clipInfo.clipLeft;
    const clipHeight = clipInfo.clipBottom - clipInfo.clipTop;
    if (clipWidth <= 0 || clipHeight <= 0) {
        await promisified_functions_1.deleteFile(path);
        throw new test_run_1.InvalidElementScreenshotDimensionsError(clipWidth, clipHeight);
    }
}
function calculateMarkPosition(pngImage, markSeed) {
    const mark = Buffer.from(markSeed);
    const filtImg = Buffer.from(pngImage.data);
    for (let i = 0; i < filtImg.length; i++)
        filtImg[i] = getCorrectedColorPart(filtImg[i]);
    const markIndex = filtImg.indexOf(mark);
    if (markIndex < 0)
        return null;
    const endPosition = markIndex / constants_1.MARK_BYTES_PER_PIXEL + constants_1.MARK_LENGTH + constants_1.MARK_RIGHT_MARGIN;
    const x = endPosition % pngImage.width || pngImage.width;
    const y = (endPosition - x) / pngImage.width + 1;
    return { x, y };
}
exports.calculateMarkPosition = calculateMarkPosition;
function getClipInfoByMarkPosition(markPosition, { width, height }) {
    const { x, y } = markPosition;
    const clipRight = x;
    const clipBottom = y;
    const clipLeft = clipRight - width;
    const clipTop = clipBottom - height;
    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom,
    };
}
exports.getClipInfoByMarkPosition = getClipInfoByMarkPosition;
function getClipInfoByCropDimensions({ clipRight, clipLeft, clipBottom, clipTop }, cropDimensions) {
    if (cropDimensions) {
        const { right, top, bottom, left } = cropDimensions;
        clipRight = limit_number_1.default(clipLeft + right, clipLeft, clipRight);
        clipBottom = limit_number_1.default(clipTop + bottom, clipTop, clipBottom);
        clipLeft = limit_number_1.default(clipLeft + left, clipLeft, clipRight);
        clipTop = limit_number_1.default(clipTop + top, clipTop, clipBottom);
    }
    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom,
    };
}
exports.getClipInfoByCropDimensions = getClipInfoByCropDimensions;
function calculateClipInfo(pngImage, path, markSeed, clientAreaDimensions, cropDimensions) {
    let clipInfo = {
        clipRight: pngImage.width,
        clipBottom: pngImage.height,
        clipLeft: 0,
        clipTop: 0,
    };
    let markPosition = null;
    if (markSeed && clientAreaDimensions) {
        markPosition = calculateMarkPosition(pngImage, markSeed);
        if (!markPosition)
            throw new Error(render_template_1.default(warning_message_1.default.screenshotMarkNotFound, path, markSeedToId(markSeed)));
        clipInfo = getClipInfoByMarkPosition(markPosition, clientAreaDimensions);
    }
    clipInfo = getClipInfoByCropDimensions(clipInfo, cropDimensions);
    if (markPosition && markPosition.y === clipInfo.clipBottom)
        clipInfo.clipBottom--;
    return clipInfo;
}
exports.calculateClipInfo = calculateClipInfo;
async function cropScreenshot(image, { path, markSeed, clientAreaDimensions, cropDimensions }) {
    if (!markSeed && !cropDimensions)
        return null;
    const clip = calculateClipInfo(image, path, markSeed, clientAreaDimensions, cropDimensions);
    await validateClipInfo(clip, path);
    return utils_1.copyImagePart(image, clip);
}
exports.cropScreenshot = cropScreenshot;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jcm9wLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG1DQUF3QztBQUN4Qyx5RUFBZ0Q7QUFDaEQsK0VBQXNEO0FBQ3RELDBFQUE0RDtBQUM1RCxrREFBOEU7QUFDOUUsMkNBSXFCO0FBRXJCLHVGQUFnRTtBQUVoRSxNQUFNLHlCQUF5QixHQUFHLEVBQUUsQ0FBQztBQUNyQyxNQUFNLGdCQUFnQixHQUFZLEdBQUcsQ0FBQztBQUN0QyxNQUFNLGdCQUFnQixHQUFZLENBQUMsQ0FBQztBQUVwQyxTQUFTLFlBQVksQ0FBRSxRQUFRO0lBQzNCLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUVYLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyx1QkFBVyxFQUFFLENBQUMsRUFBRTtRQUNoQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsZ0NBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUvRCxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFFLFNBQVM7SUFDckMsTUFBTSxPQUFPLEdBQUcsU0FBUyxHQUFHLGdCQUFnQixHQUFHLHlCQUF5QixDQUFDO0lBQ3pFLE1BQU0sT0FBTyxHQUFHLFNBQVMsR0FBRyx5QkFBeUIsQ0FBQztJQUV0RCxJQUFJLE9BQU87UUFDUCxPQUFPLGdCQUFnQixDQUFDO0lBRTVCLElBQUksT0FBTztRQUNQLE9BQU8sZ0JBQWdCLENBQUM7SUFFNUIsT0FBTyxTQUFTLENBQUM7QUFDckIsQ0FBQztBQUVELEtBQUssVUFBVSxnQkFBZ0IsQ0FBRSxRQUFRLEVBQUUsSUFBSTtJQUMzQyxNQUFNLFNBQVMsR0FBSSxRQUFRLENBQUMsU0FBUyxHQUFH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QVEsRUFBRSxvQkFBb0IsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUU1RixNQUFNLGdCQUFnQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUVuQyxPQUFPLHFCQUFhLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFURCx3Q0FTQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvcHlJbWFnZVBhcnQgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsaW1pdE51bWJlciBmcm9tICcuLi91dGlscy9saW1pdC1udW1iZXInO1xuaW1wb3J0IHJlbmRlclRlbXBsYXRlIGZyb20gJy4uL3V0aWxzL3JlbmRlci10ZW1wbGF0ZSc7XG5pbXBvcnQgeyBkZWxldGVGaWxlIH0gZnJvbSAnLi4vdXRpbHMvcHJvbWlzaWZpZWQtZnVuY3Rpb25zJztcbmltcG9ydCB7IEludmFsaWRFbGVtZW50U2NyZWVuc2hvdERpbWVuc2lvbnNFcnJvciB9IGZyb20gJy4uL2Vycm9ycy90ZXN0LXJ1bi8nO1xuaW1wb3J0IHtcbiAgICBNQVJLX0xFTkdUSCxcbiAgICBNQVJLX1JJR0hUX01BUkdJTixcbiAgICBNQVJLX0JZVEVTX1BFUl9QSVhFTCxcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5cbmNvbnN0IE1BUktfU0VFRF9FUlJPUl9USFJFU0hPTEQgPSAxMDtcbmNvbnN0IFdISVRFX0NPTE9SX1BBUlQgICAgICAgICAgPSAyNTU7XG5jb25zdCBCTEFDS19DT0xPUl9QQVJUICAgICAgICAgID0gMDtcblxuZnVuY3Rpb24gbWFya1NlZWRUb0lkIChtYXJrU2VlZCkge1xuICAgIGxldCBpZCA9IDA7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1BUktfTEVOR1RIOyBpKyspXG4gICAgICAgIGlkID0gaWQgKiAyICsgKG1hcmtTZWVkW2kgKiBNQVJLX0JZVEVTX1BFUl9QSVhFTF0gPyAxIDogMCk7XG5cbiAgICByZXR1cm4gaWQ7XG59XG5cbmZ1bmN0aW9uIGdldENvcnJlY3RlZENvbG9yUGFydCAoY29sb3JQYXJ0KSB7XG4gICAgY29uc3QgaXNXaGl0ZSA9IGNvbG9yUGFydCA+IFdISVRFX0NPTE9SX1BBUlQgLSBNQVJLX1NFRURfRVJST1JfVEhSRVNIT0xEO1xuICAgIGNvbnN0IGlzQmxhY2sgPSBjb2xvclBhcnQgPCBNQVJLX1NFRURfRVJST1JfVEhSRVNIT0xEO1xuXG4gICAgaWYgKGlzQmxhY2spXG4gICAgICAgIHJldHVybiBCTEFDS19DT0xPUl9QQVJUO1xuXG4gICAgaWYgKGlzV2hpdGUpXG4gICAgICAgIHJldHVybiBXSElURV9DT0xPUl9QQVJUO1xuXG4gICAgcmV0dXJuIGNvbG9yUGFydDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVDbGlwSW5mbyAoY2xpcEluZm8sIHBhdGgpIHtcbiAgICBjb25zdCBjbGlwV2lkdGggID0gY2xpcEluZm8uY2xpcFJpZ2h0IC0gY2xpcEluZm8uY2xpcExlZnQ7XG4gICAgY29uc3QgY2xpcEhlaWdodCA9IGNsaXBJbmZvLmNsaXBCb3R0b20gLSBjbGlwSW5mby5jbGlwVG9wO1xuXG4gICAgaWYgKGNsaXBXaWR0aCA8PSAwIHx8IGNsaXBIZWlnaHQgPD0gMCkge1xuICAgICAgICBhd2FpdCBkZWxldGVGaWxlKHBhdGgpO1xuXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkRWxlbWVudFNjcmVlbnNob3REaW1lbnNpb25zRXJyb3IoY2xpcFdpZHRoLCBjbGlwSGVpZ2h0KTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVNYXJrUG9zaXRpb24gKHBuZ0ltYWdlLCBtYXJrU2VlZCkge1xuICAgIGNvbnN0IG1hcmsgICAgPSBCdWZmZXIuZnJvbShtYXJrU2VlZCk7XG4gICAgY29uc3QgZmlsdEltZyA9IEJ1ZmZlci5mcm9tKHBuZ0ltYWdlLmRhdGEpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWx0SW1nLmxlbmd0aDsgaSsrKVxuICAgICAgICBmaWx0SW1nW2ldID0gZ2V0Q29ycmVjdGVkQ29sb3JQYXJ0KGZpbHRJbWdbaV0pO1xuXG4gICAgY29uc3QgbWFya0luZGV4ID0gZmlsdEltZy5pbmRleE9mKG1hcmspO1xuXG4gICAgaWYgKG1hcmtJbmRleCA8IDApXG4gICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgZW5kUG9zaXRpb24gPSBtYXJrSW5kZXggLyBNQVJLX0JZVEVTX1BFUl9QSVhFTCArIE1BUktfTEVOR1RIICsgTUFSS19SSUdIVF9NQVJHSU47XG5cbiAgICBjb25zdCB4ID0gZW5kUG9zaXRpb24gJSBwbmdJbWFnZS53aWR0aCB8fCBwbmdJbWFnZS53aWR0aDtcbiAgICBjb25zdCB5ID0gKGVuZFBvc2l0aW9uIC0geCkgLyBwbmdJbWFnZS53aWR0aCArIDE7XG5cbiAgICByZXR1cm4geyB4LCB5IH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbGlwSW5mb0J5TWFya1Bvc2l0aW9uIChtYXJrUG9zaXRpb24sIHsgd2lkdGgsIGhlaWdodCB9KSB7XG4gICAgY29uc3QgeyB4LCB5IH0gPSBtYXJrUG9zaXRpb247XG5cbiAgICBjb25zdCBjbGlwUmlnaHQgID0geDtcbiAgICBjb25zdCBjbGlwQm90dG9tID0geTtcbiAgICBjb25zdCBjbGlwTGVmdCAgID0gY2xpcFJpZ2h0IC0gd2lkdGg7XG4gICAgY29uc3QgY2xpcFRvcCAgICA9IGNsaXBCb3R0b20gLSBoZWlnaHQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBjbGlwTGVmdCxcbiAgICAgICAgY2xpcFRvcCxcbiAgICAgICAgY2xpcFJpZ2h0LFxuICAgICAgICBjbGlwQm90dG9tLFxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbGlwSW5mb0J5Q3JvcERpbWVuc2lvbnMgKHsgY2xpcFJpZ2h0LCBjbGlwTGVmdCwgY2xpcEJvdHRvbSwgY2xpcFRvcCB9LCBjcm9wRGltZW5zaW9ucykge1xuICAgIGlmIChjcm9wRGltZW5zaW9ucykge1xuICAgICAgICBjb25zdCB7IHJpZ2h0LCB0b3AsIGJvdHRvbSwgbGVmdCB9ID0gY3JvcERpbWVuc2lvbnM7XG5cbiAgICAgICAgY2xpcFJpZ2h0ICA9IGxpbWl0TnVtYmVyKGNsaXBMZWZ0ICsgcmlnaHQsIGNsaXBMZWZ0LCBjbGlwUmlnaHQpO1xuICAgICAgICBjbGlwQm90dG9tID0gbGltaXROdW1iZXIoY2xpcFRvcCArIGJvdHRvbSwgY2xpcFRvcCwgY2xpcEJvdHRvbSk7XG4gICAgICAgIGNsaXBMZWZ0ICAgPSBsaW1pdE51bWJlcihjbGlwTGVmdCArIGxlZnQsIGNsaXBMZWZ0LCBjbGlwUmlnaHQpO1xuICAgICAgICBjbGlwVG9wICAgID0gbGltaXROdW1iZXIoY2xpcFRvcCArIHRvcCwgY2xpcFRvcCwgY2xpcEJvdHRvbSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgY2xpcExlZnQsXG4gICAgICAgIGNsaXBUb3AsXG4gICAgICAgIGNsaXBSaWdodCxcbiAgICAgICAgY2xpcEJvdHRvbSxcbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlQ2xpcEluZm8gKHBuZ0ltYWdlLCBwYXRoLCBtYXJrU2VlZCwgY2xpZW50QXJlYURpbWVuc2lvbnMsIGNyb3BEaW1lbnNpb25zKSB7XG4gICAgbGV0IGNsaXBJbmZvID0ge1xuICAgICAgICBjbGlwUmlnaHQ6ICBwbmdJbWFnZS53aWR0aCxcbiAgICAgICAgY2xpcEJvdHRvbTogcG5nSW1hZ2UuaGVpZ2h0LFxuICAgICAgICBjbGlwTGVmdDogICAwLFxuICAgICAgICBjbGlwVG9wOiAgICAwLFxuICAgIH07XG5cbiAgICBsZXQgbWFya1Bvc2l0aW9uID0gbnVsbDtcblxuICAgIGlmIChtYXJrU2VlZCAmJiBjbGllbnRBcmVhRGltZW5zaW9ucykge1xuICAgICAgICBtYXJrUG9zaXRpb24gPSBjYWxjdWxhdGVNYXJrUG9zaXRpb24ocG5nSW1hZ2UsIG1hcmtTZWVkKTtcblxuICAgICAgICBpZiAoIW1hcmtQb3NpdGlvbilcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZW5kZXJUZW1wbGF0ZShXQVJOSU5HX01FU1NBR0VTLnNjcmVlbnNob3RNYXJrTm90Rm91bmQsIHBhdGgsIG1hcmtTZWVkVG9JZChtYXJrU2VlZCkpKTtcblxuICAgICAgICBjbGlwSW5mbyA9IGdldENsaXBJbmZvQnlNYXJrUG9zaXRpb24obWFya1Bvc2l0aW9uLCBjbGllbnRBcmVhRGltZW5zaW9ucyk7XG4gICAgfVxuXG4gICAgY2xpcEluZm8gPSBnZXRDbGlwSW5mb0J5Q3JvcERpbWVuc2lvbnMoY2xpcEluZm8sIGNyb3BEaW1lbnNpb25zKTtcblxuICAgIGlmIChtYXJrUG9zaXRpb24gJiYgbWFya1Bvc2l0aW9uLnkgPT09IGNsaXBJbmZvLmNsaXBCb3R0b20pXG4gICAgICAgIGNsaXBJbmZvLmNsaXBCb3R0b20tLTtcblxuICAgIHJldHVybiBjbGlwSW5mbztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyb3BTY3JlZW5zaG90IChpbWFnZSwgeyBwYXRoLCBtYXJrU2VlZCwgY2xpZW50QXJlYURpbWVuc2lvbnMsIGNyb3BEaW1lbnNpb25zIH0pIHtcbiAgICBpZiAoIW1hcmtTZWVkICYmICFjcm9wRGltZW5zaW9ucylcbiAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBjbGlwID0gY2FsY3VsYXRlQ2xpcEluZm8oaW1hZ2UsIHBhdGgsIG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMpO1xuXG4gICAgYXdhaXQgdmFsaWRhdGVDbGlwSW5mbyhjbGlwLCBwYXRoKTtcblxuICAgIHJldHVybiBjb3B5SW1hZ2VQYXJ0KGltYWdlLCBjbGlwKTtcbn1cbiJdfQ==