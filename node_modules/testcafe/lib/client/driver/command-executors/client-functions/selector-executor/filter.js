"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../../../../shared/errors/index");
const utils_1 = require("./utils");
const index_2 = __importDefault(require("../adapter/index"));
const SELECTOR_FILTER_ERROR = {
    filterVisible: 1,
    filterHidden: 2,
    nth: 3,
};
const FILTER_ERROR_TO_API_RE = {
    [SELECTOR_FILTER_ERROR.filterVisible]: /^\.filterVisible\(\)$/,
    [SELECTOR_FILTER_ERROR.filterHidden]: /^\.filterHidden\(\)$/,
    [SELECTOR_FILTER_ERROR.nth]: /^\.nth\(\d+\)$/,
};
class SelectorFilter {
    constructor() {
        this._err = null;
    }
    get error() {
        return this._err;
    }
    set error(message) {
        if (this._err === null)
            this._err = message;
    }
    filter(nodes, options, apiInfo) {
        if (options.filterVisible) {
            nodes = nodes.filter(utils_1.visible);
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterVisible);
        }
        if (options.filterHidden) {
            nodes = nodes.filter(n => !utils_1.visible(n));
            this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.filterHidden);
        }
        if (options.counterMode) {
            if (options.index === null)
                return nodes.length;
            return SelectorFilter._getNodeByIndex(nodes, options.index) ? 1 : 0;
        }
        if (options.collectionMode) {
            if (options.index !== null) {
                const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index);
                nodes = nodeOnIndex ? [nodeOnIndex] : [];
                this._assertFilterError(nodes, apiInfo, SELECTOR_FILTER_ERROR.nth);
            }
            return nodes;
        }
        const nodeOnIndex = SelectorFilter._getNodeByIndex(nodes, options.index || 0);
        if (!nodeOnIndex)
            this.error = SelectorFilter._getErrorItem(apiInfo, SELECTOR_FILTER_ERROR.nth);
        return nodeOnIndex;
    }
    cast(searchResult) {
        if (searchResult === null || searchResult === void 0)
            return [];
        else if (searchResult instanceof index_2.default.nativeMethods.Node)
            return [searchResult];
        else if (utils_1.isArrayOfNodes(searchResult))
            return searchResult;
        else if (utils_1.isNodeCollection(searchResult))
            return utils_1.castToArray(searchResult);
        throw new index_1.InvalidSelectorResultError();
    }
    _assertFilterError(filtered, apiInfo, filterError) {
        if (filtered.length === 0)
            this.error = SelectorFilter._getErrorItem(apiInfo, filterError);
    }
    static _getErrorItem({ apiFnChain, apiFnID }, err) {
        if (err) {
            for (let i = apiFnID; i < apiFnChain.length; i++) {
                if (FILTER_ERROR_TO_API_RE[err].test(apiFnChain[i]))
                    return i;
            }
        }
        return null;
    }
    static _getNodeByIndex(nodes, index) {
        return index < 0 ? nodes[nodes.length + index] : nodes[index];
    }
}
exports.default = new SelectorFilter();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NsaWVudC9kcml2ZXIvY29tbWFuZC1leGVjdXRvcnMvY2xpZW50LWZ1bmN0aW9ucy9zZWxlY3Rvci1leGVjdXRvci9maWx0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw4REFBZ0Y7QUFDaEYsbUNBS2lCO0FBRWpCLDZEQUF1QztBQUd2QyxNQUFNLHFCQUFxQixHQUFHO0lBQzFCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLFlBQVksRUFBRyxDQUFDO0lBQ2hCLEdBQUcsRUFBWSxDQUFDO0NBQ25CLENBQUM7QUFFRixNQUFNLHNCQUFzQixHQUFHO0lBQzNCLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFDLEVBQUUsdUJBQXVCO0lBQzlELENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLEVBQUcsc0JBQXNCO0lBQzdELENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQVksZ0JBQWdCO0NBQzFELENBQUM7QUFHRixNQUFNLGNBQWM7SUFBcEI7UUFDWSxTQUFJLEdBQWtCLElBQUksQ0FBQztJQXNGdkMsQ0FBQztJQXBGRyxJQUFXLEtBQUs7UUFDWixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVELElBQVcsS0FBSyxDQUFFLE9BQXNCO1FBQ3BDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxJQUFJO1lBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO0lBQzVCLENBQUM7SUFFTSxNQUFNLENBQUUsS0FBYSxFQUFFLE9BQXNCLEVBQUUsT0FBZ0I7UUFDbEUsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFFO1lBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLGVBQU8sQ0FBQyxDQUFDO1lBRTlCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLHFCQUFxQixDQUFD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ZUFBZSxDQUFFLEtBQWEsRUFBRSxLQUFhO1FBQ3hELE9BQU8sS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsRSxDQUFDO0NBQ0o7QUFFRCxrQkFBZSxJQUFJLGNBQWMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9zaGFyZWQvZXJyb3JzL2luZGV4JztcbmltcG9ydCB7XG4gICAgdmlzaWJsZSxcbiAgICBpc05vZGVDb2xsZWN0aW9uLFxuICAgIGlzQXJyYXlPZk5vZGVzLFxuICAgIGNhc3RUb0FycmF5LFxufSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IEFQSUluZm8sIEZpbHRlck9wdGlvbnMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgYWRhcHRlciBmcm9tICcuLi9hZGFwdGVyL2luZGV4JztcblxuXG5jb25zdCBTRUxFQ1RPUl9GSUxURVJfRVJST1IgPSB7XG4gICAgZmlsdGVyVmlzaWJsZTogMSxcbiAgICBmaWx0ZXJIaWRkZW46ICAyLFxuICAgIG50aDogICAgICAgICAgIDMsXG59O1xuXG5jb25zdCBGSUxURVJfRVJST1JfVE9fQVBJX1JFID0ge1xuICAgIFtTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVyVmlzaWJsZV06IC9eXFwuZmlsdGVyVmlzaWJsZVxcKFxcKSQvLFxuICAgIFtTRUxFQ1RPUl9GSUxURVJfRVJST1IuZmlsdGVySGlkZGVuXTogIC9eXFwuZmlsdGVySGlkZGVuXFwoXFwpJC8sXG4gICAgW1NFTEVDVE9SX0ZJTFRFUl9FUlJPUi5udGhdOiAgICAgICAgICAgL15cXC5udGhcXChcXGQrXFwpJC8sXG59O1xuXG5cbmNsYXNzIFNlbGVjdG9yRmlsdGVyIHtcbiAgICBwcml2YXRlIF9lcnI6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gICAgcHVibGljIGdldCBlcnJvciAoKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lcnI7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBlcnJvciAobWVzc2FnZTogbnVtYmVyIHwgbnVsbCkge1xuICAgICAgICBpZiAodGhpcy5fZXJyID09PSBudWxsKVxuICAgICAgICAgICAgdGhpcy5fZXJyID0gbWVzc2FnZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmlsdGVyIChub2RlczogTm9kZVtdLCBvcHRpb25zOiBGaWx0ZXJPcHRpb25zLCBhcGlJbmZvOiBBUElJbmZvKTogbnVtYmVyIHwgTm9kZSB8IE5vZGVbXSB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGlmIChvcHRpb25zLmZpbHRlclZpc2libGUpIHtcbiAgICAgICAgICAgIG5vZGVzID0gbm9kZXMuZmlsdGVyKHZpc2libGUpO1xuXG4gICAgICAgICAgICB0aGlzLl9hc3NlcnRGaWx0ZXJFcnJvcihub2RlcywgYXBpSW5mbywgU0VMRUNUT1JfRklMVEVSX0VSUk9SLmZpbHRlclZpc2libGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVySGlkZGVuKSB7XG4gICAgICAgICAgICBub2RlcyA9IG5vZGVzLmZpbHRlcihuID0+ICF2aXNpYmxlKG4pKTtcblxuICAgICAgICAgICAgdGhpcy5fYXNzZXJ0RmlsdGVyRXJyb3Iobm9kZXMsIGFwaUluZm8sIFNFTEVDVE9SX0ZJTFRFUl9FUlJPUi5maWx0ZXJIaWRkZW4pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdGlvbnMuY291bnRlck1vZGUpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmluZGV4ID09PSBudWxsKVxuICAgICAgICAgICAgICAgIHJldHVybiBub2Rlcy5sZW5ndGg7XG5cbiAgICAgICAgICAgIHJldHVybiBTZWxlY3RvckZpbHRlci5fZ2V0Tm9kZUJ5SW5kZXgobm9kZXMsIG9wdGlvbnMuaW5kZXgpID8gMSA6IDA7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy5jb2xsZWN0aW9uTW9kZSkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5kZXggIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBub2RlT25JbmRleCA9IFNlbGVjdG9yRmlsdGVyLl9nZXROb2RlQnlJbmRleChub2Rlcywgb3B0aW9ucy5pbmRleCk7XG5cbiAgICAgICAgICAgICAgICBub2RlcyA9IG5vZGVPbkluZGV4ID8gW25vZGVPbkluZGV4XSA6IFtdO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5fYXNzZXJ0RmlsdGVyRXJyb3Iobm9kZXMsIGFwaUluZm8sIFNFTEVDVE9SX0ZJTFRFUl9FUlJPUi5udGgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gbm9kZXM7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBub2RlT25JbmRleCA9IFNlbGVjdG9yRmlsdGVyLl9nZXROb2RlQnlJbmRleChub2Rlcywgb3B0aW9ucy5pbmRleCB8fCAwKTtcblxuICAgICAgICBpZiAoIW5vZGVPbkluZGV4KVxuICAgICAgICAgICAgdGhpcy5lcnJvciA9IFNlbGVjdG9yRmlsdGVyLl9nZXRFcnJvckl0ZW0oYXBpSW5mbywgU0VMRUNUT1JfRklMVEVSX0VSUk9SLm50aCk7XG5cbiAgICAgICAgcmV0dXJuIG5vZGVPbkluZGV4O1xuICAgIH1cblxuICAgIHB1YmxpYyBjYXN0IChzZWFyY2hSZXN1bHQ6IHVua25vd24pOiBOb2RlW10ge1xuICAgICAgICBpZiAoc2VhcmNoUmVzdWx0ID09PSBudWxsIHx8IHNlYXJjaFJlc3VsdCA9PT0gdm9pZCAwKVxuICAgICAgICAgICAgcmV0dXJuIFtdO1xuXG4gICAgICAgIGVsc2UgaWYgKHNlYXJjaFJlc3VsdCBpbnN0YW5jZW9mIGFkYXB0ZXIubmF0aXZlTWV0aG9kcy5Ob2RlKVxuICAgICAgICAgICAgcmV0dXJuIFtzZWFyY2hSZXN1bHRdO1xuXG4gICAgICAgIGVsc2UgaWYgKGlzQXJyYXlPZk5vZGVzKHNlYXJjaFJlc3VsdCkpXG4gICAgICAgICAgICByZXR1cm4gc2VhcmNoUmVzdWx0O1xuXG4gICAgICAgIGVsc2UgaWYgKGlzTm9kZUNvbGxlY3Rpb24oc2VhcmNoUmVzdWx0KSlcbiAgICAgICAgICAgIHJldHVybiBjYXN0VG9BcnJheShzZWFyY2hSZXN1bHQpO1xuXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkU2VsZWN0b3JSZXN1bHRFcnJvcigpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Fzc2VydEZpbHRlckVycm9yIChmaWx0ZXJlZDogTm9kZVtdLCBhcGlJbmZvOiBBUElJbmZvLCBmaWx0ZXJFcnJvcjogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGlmIChmaWx0ZXJlZC5sZW5ndGggPT09IDApXG4gICAgICAgICAgICB0aGlzLmVycm9yID0gU2VsZWN0b3JGaWx0ZXIuX2dldEVycm9ySXRlbShhcGlJbmZvLCBmaWx0ZXJFcnJvcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldEVycm9ySXRlbSAoeyBhcGlGbkNoYWluLCBhcGlGbklEIH06IEFQSUluZm8sIGVycjogbnVtYmVyKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSBhcGlGbklEOyBpIDwgYXBpRm5DaGFpbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChGSUxURVJfRVJST1JfVE9fQVBJX1JFW2Vycl0udGVzdChhcGlGbkNoYWluW2ldKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfZ2V0Tm9kZUJ5SW5kZXggKG5vZGVzOiBOb2RlW10sIGluZGV4OiBudW1iZXIpOiBOb2RlIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIGluZGV4IDwgMCA/IG5vZGVzW25vZGVzLmxlbmd0aCArIGluZGV4XSA6IG5vZGVzW2luZGV4XTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IG5ldyBTZWxlY3RvckZpbHRlcigpO1xuIl19