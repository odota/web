"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = __importDefault(require("../utils/shared/adapter/index"));
const index_2 = __importDefault(require("./adapter/index"));
const scroll_1 = require("../utils/shared/scroll");
const positionUtils = __importStar(require("../utils/shared/position"));
const promiseUtils = __importStar(require("../../../shared/utils/promise"));
const style_1 = require("../utils/shared/style");
const is_window_in_iframe_1 = __importDefault(require("../../../utils/is-window-in-iframe"));
const axis_values_1 = __importDefault(require("../../../shared/utils/values/axis-values"));
const DEFAULT_MAX_SCROLL_MARGIN = 50;
const SCROLL_MARGIN_INCREASE_STEP = 20;
class ScrollAutomation {
    constructor(element, scrollOptions, maxScrollMargin) {
        this._element = element;
        this._offsets = new axis_values_1.default(scrollOptions.offsetX, scrollOptions.offsetY);
        this._scrollToCenter = !!scrollOptions.scrollToCenter;
        this._skipParentFrames = !!scrollOptions.skipParentFrames;
        this._maxScrollMargin = maxScrollMargin || { left: DEFAULT_MAX_SCROLL_MARGIN, top: DEFAULT_MAX_SCROLL_MARGIN };
        this._scrollWasPerformed = false;
    }
    static _isScrollValuesChanged(scrollElement, originalScroll) {
        return index_1.default.style.getScrollLeft(scrollElement) !== originalScroll.left ||
            index_1.default.style.getScrollTop(scrollElement) !== originalScroll.top;
    }
    _setScroll(element, { left, top }) {
        const scrollElement = index_1.default.dom.isHtmlElement(element) ? index_1.default.dom.findDocument(element) : element;
        const originalScroll = {
            left: index_1.default.style.getScrollLeft(scrollElement),
            top: index_1.default.style.getScrollTop(scrollElement),
        };
        left = Math.max(left, 0);
        top = Math.max(top, 0);
        let scrollPromise = index_2.default.controller.waitForScroll(scrollElement);
        index_1.default.style.setScrollLeft(scrollElement, left);
        index_1.default.style.setScrollTop(scrollElement, top);
        if (!ScrollAutomation._isScrollValuesChanged(scrollElement, originalScroll)) {
            // @ts-ignore
            scrollPromise.cancel();
            return index_2.default.PromiseCtor.resolve();
        }
        scrollPromise = scrollPromise.then(() => {
            if (!this._scrollWasPerformed)
                this._scrollWasPerformed = ScrollAutomation._isScrollValuesChanged(scrollElement, originalScroll);
        });
        return scrollPromise;
    }
    _getScrollToPoint(dimensions, point, maxScrollMargin) {
        const horizontalCenter = Math.floor(dimensions.width / 2);
        const verticalCenter = Math.floor(dimensions.height / 2);
        const leftScrollMargin = this._scrollToCenter ? horizontalCenter : Math.min(maxScrollMargin.left, horizontalCenter);
        const topScrollMargin = this._scrollToCenter ? verticalCenter : Math.min(maxScrollMargin.top, verticalCenter);
        let { left, top } = dimensions.scroll;
        const needForwardScrollLeft = point.x >= left + dimensions.width - leftScrollMargin;
        const needBackwardScrollLeft = point.x <= left + leftScrollMargin;
        const needForwardScrollTop = point.y >= top + dimensions.height - topScrollMargin;
        const needBackwardScrollTop = point.y <= top + topScrollMargin;
        if (needForwardScrollLeft)
            left = point.x - dimensions.width + leftScrollMargin;
        else if (needBackwardScrollLeft)
            left = point.x - leftScrollMargin;
        if (needForwardScrollTop)
            top = point.y - dimensions.height + topScrollMargin;
        else if (needBackwardScrollTop)
            top = point.y - topScrollMargin;
        return { left, top };
    }
    _getScrollToFullChildView(parentDimensions, childDimensions, maxScrollMargin) {
        const fullViewScroll = { left: null, top: null };
        const canShowFullElementWidth = parentDimensions.width >= childDimensions.width;
        const canShowFullElementHeight = parentDimensions.height >= childDimensions.height;
        const relativePosition = positionUtils.calcRelativePosition(childDimensions, parentDimensions);
        if (canShowFullElementWidth) {
            const availableLeftScrollMargin = parentDimensions.width - childDimensions.width;
            let leftScrollMargin = Math.min(maxScrollMargin.left, availableLeftScrollMargin);
            if (this._scrollToCenter)
                leftScrollMargin = availableLeftScrollMargin / 2;
            if (relativePosition.left < leftScrollMargin)
                fullViewScroll.left = Math.round(parentDimensions.scroll.left + relativePosition.left - leftScrollMargin);
            else if (relativePosition.right < leftScrollMargin) {
                fullViewScroll.left = Math.round(parentDimensions.scroll.left +
                    Math.min(relativePosition.left, -relativePosition.right) +
                    leftScrollMargin);
            }
        }
        if (canShowFullElementHeight) {
            const availableTopScrollMargin = parentDimensions.height - childDimensions.height;
            let topScrollMargin = Math.min(maxScrollMargin.top, availableTopScrollMargin);
            if (this._scrollToCenter)
                topScrollMargin = availableTopScrollMargin / 2;
            if (relativePosition.top < topScrollMargin)
                fullViewScroll.top = Math.round(parentDimensions.scroll.top + relativePosition.top - topScrollMargin);
            else if (relativePosition.bottom < topScrollMargin) {
                fullViewScroll.top = Math.round(parentDimensions.scroll.top +
                    Math.min(relativePosition.top, -relativePosition.bottom) +
                    topScrollMargin);
            }
        }
        return fullViewScroll;
    }
    static _getChildPoint(parentDimensions, childDimensions, offsets) {
        return axis_values_1.default.create(childDimensions)
            .sub(axis_values_1.default.create(parentDimensions))
            .add(axis_values_1.default.create(parentDimensions.scroll))
            .add(axis_values_1.default.create(childDimensions.border))
            .add(offsets);
    }
    _getScrollPosition(parentDimensions, childDimensions, offsets, maxScrollMargin) {
        const childPoint = ScrollAutomation._getChildPoint(parentDimensions, childDimensions, offsets);
        const scrollToPoint = this._getScrollToPoint(parentDimensions, childPoint, maxScrollMargin);
        const scrollToFullView = this._getScrollToFullChildView(parentDimensions, childDimensions, maxScrollMargin);
        return {
            left: Math.max(scrollToFullView.left === null ? scrollToPoint.left : scrollToFullView.left, 0),
            top: Math.max(scrollToFullView.top === null ? scrollToPoint.top : scrollToFullView.top, 0),
        };
    }
    static _getChildPointAfterScroll(parentDimensions, childDimensions, currentScroll, offsets) {
        return axis_values_1.default.create(childDimensions)
            .add(axis_values_1.default.create(parentDimensions.scroll))
            .sub(axis_values_1.default.create(currentScroll))
            .add(offsets);
    }
    _isChildFullyVisible(parentDimensions, childDimensions, offsets) {
        const childPoint = ScrollAutomation._getChildPointAfterScroll(parentDimensions, childDimensions, parentDimensions.scroll, offsets);
        const zeroMargin = { left: 0, top: 0 };
        const { left, top } = this._getScrollPosition(parentDimensions, childDimensions, offsets, zeroMargin);
        return !this._isTargetElementObscuredInPoint(childPoint) &&
            left === parentDimensions.scroll.left && top === parentDimensions.scroll.top;
    }
    _scrollToChild(parent, child, offsets) {
        const parentDimensions = positionUtils.getClientDimensions(parent);
        const childDimensions = positionUtils.getClientDimensions(child);
        const windowWidth = index_1.default.style.getInnerWidth(window);
        const windowHeight = index_1.default.style.getInnerHeight(window);
        let scrollPos = parentDimensions.scroll;
        let needScroll = !this._isChildFullyVisible(parentDimensions, childDimensions, offsets);
        while (needScroll) {
            scrollPos = this._getScrollPosition(parentDimensions, childDimensions, offsets, this._maxScrollMargin);
            const childPoint = ScrollAutomation._getChildPointAfterScroll(parentDimensions, childDimensions, scrollPos, offsets);
            const isTargetObscured = this._isTargetElementObscuredInPoint(childPoint);
            this._maxScrollMargin.left += SCROLL_MARGIN_INCREASE_STEP;
            if (this._maxScrollMargin.left >= windowWidth) {
                this._maxScrollMargin.left = DEFAULT_MAX_SCROLL_MARGIN;
                this._maxScrollMargin.top += SCROLL_MARGIN_INCREASE_STEP;
            }
            needScroll = isTargetObscured && this._maxScrollMargin.top < windowHeight;
        }
        this._maxScrollMargin = { left: DEFAULT_MAX_SCROLL_MARGIN, top: DEFAULT_MAX_SCROLL_MARGIN };
        return this._setScroll(parent, scrollPos);
    }
    _scrollElement() {
        if (!scroll_1.hasScroll(this._element))
            return index_2.default.PromiseCtor.resolve();
        const elementDimensions = positionUtils.getClientDimensions(this._element);
        const scroll = this._getScrollToPoint(elementDimensions, this._offsets, this._maxScrollMargin);
        return this._setScroll(this._element, scroll);
    }
    _scrollParents() {
        const parents = scroll_1.getScrollableParents(this._element);
        let currentChild = this._element;
        const scrollLeft = index_1.default.style.getScrollLeft(currentChild);
        const scrollTop = index_1.default.style.getScrollTop(currentChild);
        const currentOffset = axis_values_1.default.create(this._offsets).sub(new axis_values_1.default(scrollLeft, scrollTop).round());
        let childDimensions = null;
        let parentDimensions = null;
        const scrollParentsPromise = promiseUtils.times(parents.length, i => {
            return this._scrollToChild(parents[i], currentChild, currentOffset)
                .then(() => {
                childDimensions = positionUtils.getClientDimensions(currentChild);
                parentDimensions = positionUtils.getClientDimensions(parents[i]);
                currentOffset.add(axis_values_1.default.create(childDimensions))
                    .sub(axis_values_1.default.create(parentDimensions))
                    .add(axis_values_1.default.create(parentDimensions.border));
                currentChild = parents[i];
            });
        });
        const state = {
            scrollWasPerformed: this._scrollWasPerformed,
            offsetX: currentOffset.x,
            offsetY: currentOffset.y,
            maxScrollMargin: this._maxScrollMargin,
        };
        if (!index_1.default.sendRequestToFrame)
            return scrollParentsPromise.then(() => state);
        return scrollParentsPromise
            .then(() => {
            if (this._skipParentFrames || !is_window_in_iframe_1.default(window))
                return;
            state.cmd = ScrollAutomation.SCROLL_REQUEST_CMD;
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion, consistent-return
            return index_1.default.sendRequestToFrame(state, ScrollAutomation.SCROLL_RESPONSE_CMD, window.parent);
        })
            .then(() => this._scrollWasPerformed);
    }
    static _getFixedAncestorOrSelf(element) {
        return index_1.default.dom.findParent(element, true, style_1.isFixedElement);
    }
    _isTargetElementObscuredInPoint(point) {
        const elementInPoint = positionUtils.getElementFromPoint(point);
        if (!elementInPoint)
            return false;
        const fixedElement = ScrollAutomation._getFixedAncestorOrSelf(elementInPoint);
        return !!fixedElement && !fixedElement.contains(this._element);
    }
    run() {
        return this._scrollElement()
            .then(() => this._scrollParents());
    }
}
exports.default = ScrollAutomation;
ScrollAutomation.SCROLL_REQUEST_CMD = 'automation|scroll|request';
ScrollAutomation.SCROLL_RESPONSE_CMD = 'automation|scroll|response';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2xpZW50L2NvcmUvc2Nyb2xsL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDBFQUF5RDtBQUN6RCw0REFBNEM7QUFDNUMsbURBQXlFO0FBQ3pFLHdFQUEwRDtBQUMxRCw0RUFBOEQ7QUFDOUQsaURBQXVEO0FBQ3ZELDZGQUFnRTtBQUNoRSwyRkFBcUY7QUFjckYsTUFBTSx5QkFBeUIsR0FBSyxFQUFFLENBQUM7QUFDdkMsTUFBTSwyQkFBMkIsR0FBRyxFQUFFLENBQUM7QUFFdkMsTUFBcUIsZ0JBQWdCO0lBV2pDLFlBQW9CLE9BQWdCLEVBQUUsYUFBNEIsRUFBRSxlQUF1QztRQUN2RyxJQUFJLENBQUMsUUFBUSxHQUFZLE9BQU8sQ0FBQztRQUNqQyxJQUFJLENBQUMsUUFBUSxHQUFZLElBQUkscUJBQVUsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0RixJQUFJLENBQUMsZUFBZSxHQUFLLENBQUMsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDO1FBQ3hELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDO1FBRTFELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxlQUFlLElBQUksRUFBRSxJQUFJLEVBQUUseUJBQXlCLEVBQUUsR0FBRyxFQUFFLHlCQUF5QixFQUFFLENBQUM7UUFFL0csSUFBSSxDQUFDLG1CQUFtQixHQUFHLEtBQUssQ0FBQztJQUNyQyxDQUFDO0lBRU8sTUFBTSxDQUFDLHNCQUFzQixDQUFFLGFBQWlDLEVBQUUsY0FBcUM7UUFDM0csT0FBTyxlQUFZLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsS0FBSyxjQUFjLENBQUMsSUFBSTtZQUMxRSxlQUFZLENBQUMsS0FBSyxDQUFD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QUFHO1FBQ04sT0FBTyxJQUFJLENBQUMsY0FBYyxFQUFFO2FBQ3ZCLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDOztBQTVRTCxtQ0E2UUM7QUE1UTBCLG1DQUFrQixHQUFHLDJCQUEyQixDQUFDO0FBQ2pELG9DQUFtQixHQUFHLDRCQUE0QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV0aWxzQWRhcHRlciBmcm9tICcuLi91dGlscy9zaGFyZWQvYWRhcHRlci9pbmRleCc7XG5pbXBvcnQgc2Nyb2xsQWRhcHRlciBmcm9tICcuL2FkYXB0ZXIvaW5kZXgnO1xuaW1wb3J0IHsgaGFzU2Nyb2xsLCBnZXRTY3JvbGxhYmxlUGFyZW50cyB9IGZyb20gJy4uL3V0aWxzL3NoYXJlZC9zY3JvbGwnO1xuaW1wb3J0ICogYXMgcG9zaXRpb25VdGlscyBmcm9tICcuLi91dGlscy9zaGFyZWQvcG9zaXRpb24nO1xuaW1wb3J0ICogYXMgcHJvbWlzZVV0aWxzIGZyb20gJy4uLy4uLy4uL3NoYXJlZC91dGlscy9wcm9taXNlJztcbmltcG9ydCB7IGlzRml4ZWRFbGVtZW50IH0gZnJvbSAnLi4vdXRpbHMvc2hhcmVkL3N0eWxlJztcbmltcG9ydCBpc0lmcmFtZVdpbmRvdyBmcm9tICcuLi8uLi8uLi91dGlscy9pcy13aW5kb3ctaW4taWZyYW1lJztcbmltcG9ydCBBeGlzVmFsdWVzLCB7IExlZnRUb3BWYWx1ZXMgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCBEaW1lbnNpb25zIGZyb20gJy4uLy4uLy4uL3NoYXJlZC91dGlscy92YWx1ZXMvZGltZW5zaW9ucyc7XG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vLi4vLi4vY29uZmlndXJhdGlvbi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFNjcm9sbE9wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9vcHRpb25zJztcblxuXG5leHBvcnQgaW50ZXJmYWNlIFNjcm9sbFJlc3VsdFByb3h5bGVzcyB7XG4gICAgc2Nyb2xsV2FzUGVyZm9ybWVkOiBib29sZWFuO1xuICAgIG9mZnNldFg6IG51bWJlcjtcbiAgICBvZmZzZXRZOiBudW1iZXI7XG4gICAgbWF4U2Nyb2xsTWFyZ2luOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj47XG59XG5cblxuY29uc3QgREVGQVVMVF9NQVhfU0NST0xMX01BUkdJTiAgID0gNTA7XG5jb25zdCBTQ1JPTExfTUFSR0lOX0lOQ1JFQVNFX1NURVAgPSAyMDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2Nyb2xsQXV0b21hdGlvbiB7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBTQ1JPTExfUkVRVUVTVF9DTUQgPSAnYXV0b21hdGlvbnxzY3JvbGx8cmVxdWVzdCc7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBTQ1JPTExfUkVTUE9OU0VfQ01EID0gJ2F1dG9tYXRpb258c2Nyb2xsfHJlc3BvbnNlJztcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2VsZW1lbnQ6IEVsZW1lbnQ7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfb2Zmc2V0czogQXhpc1ZhbHVlczxudW1iZXI+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX3NraXBQYXJlbnRGcmFtZXM6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSByZWFkb25seSBfc2Nyb2xsVG9DZW50ZXI6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfbWF4U2Nyb2xsTWFyZ2luOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj47XG4gICAgcHJpdmF0ZSBfc2Nyb2xsV2FzUGVyZm9ybWVkOiBib29sZWFuO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChlbGVtZW50OiBFbGVtZW50LCBzY3JvbGxPcHRpb25zOiBTY3JvbGxPcHRpb25zLCBtYXhTY3JvbGxNYXJnaW4/OiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4pIHtcbiAgICAgICAgdGhpcy5fZWxlbWVudCAgICAgICAgICA9IGVsZW1lbnQ7XG4gICAgICAgIHRoaXMuX29mZnNldHMgICAgICAgICAgPSBuZXcgQXhpc1ZhbHVlcyhzY3JvbGxPcHRpb25zLm9mZnNldFgsIHNjcm9sbE9wdGlvbnMub2Zmc2V0WSk7XG4gICAgICAgIHRoaXMuX3Njcm9sbFRvQ2VudGVyICAgPSAhIXNjcm9sbE9wdGlvbnMuc2Nyb2xsVG9DZW50ZXI7XG4gICAgICAgIHRoaXMuX3NraXBQYXJlbnRGcmFtZXMgPSAhIXNjcm9sbE9wdGlvbnMuc2tpcFBhcmVudEZyYW1lcztcblxuICAgICAgICB0aGlzLl9tYXhTY3JvbGxNYXJnaW4gPSBtYXhTY3JvbGxNYXJnaW4gfHwgeyBsZWZ0OiBERUZBVUxUX01BWF9TQ1JPTExfTUFSR0lOLCB0b3A6IERFRkFVTFRfTUFYX1NDUk9MTF9NQVJHSU4gfTtcblxuICAgICAgICB0aGlzLl9zY3JvbGxXYXNQZXJmb3JtZWQgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfaXNTY3JvbGxWYWx1ZXNDaGFuZ2VkIChzY3JvbGxFbGVtZW50OiBFbGVtZW50IHwgRG9jdW1lbnQsIG9yaWdpbmFsU2Nyb2xsOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHV0aWxzQWRhcHRlci5zdHlsZS5nZXRTY3JvbGxMZWZ0KHNjcm9sbEVsZW1lbnQpICE9PSBvcmlnaW5hbFNjcm9sbC5sZWZ0IHx8XG4gICAgICAgICAgICB1dGlsc0FkYXB0ZXIuc3R5bGUuZ2V0U2Nyb2xsVG9wKHNjcm9sbEVsZW1lbnQpICE9PSBvcmlnaW5hbFNjcm9sbC50b3A7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2V0U2Nyb2xsIChlbGVtZW50OiBFbGVtZW50LCB7IGxlZnQsIHRvcCB9OiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgc2Nyb2xsRWxlbWVudCA9IHV0aWxzQWRhcHRlci5kb20uaXNIdG1sRWxlbWVudChlbGVtZW50KSA/IHV0aWxzQWRhcHRlci5kb20uZmluZERvY3VtZW50KGVsZW1lbnQpIDogZWxlbWVudDtcblxuICAgICAgICBjb25zdCBvcmlnaW5hbFNjcm9sbCA9IHtcbiAgICAgICAgICAgIGxlZnQ6IHV0aWxzQWRhcHRlci5zdHlsZS5nZXRTY3JvbGxMZWZ0KHNjcm9sbEVsZW1lbnQpLFxuICAgICAgICAgICAgdG9wOiAgdXRpbHNBZGFwdGVyLnN0eWxlLmdldFNjcm9sbFRvcChzY3JvbGxFbGVtZW50KSxcbiAgICAgICAgfTtcblxuICAgICAgICBsZWZ0ID0gTWF0aC5tYXgobGVmdCwgMCk7XG4gICAgICAgIHRvcCAgPSBNYXRoLm1heCh0b3AsIDApO1xuXG4gICAgICAgIGxldCBzY3JvbGxQcm9taXNlID0gc2Nyb2xsQWRhcHRlci5jb250cm9sbGVyLndhaXRGb3JTY3JvbGwoc2Nyb2xsRWxlbWVudCk7XG5cbiAgICAgICAgdXRpbHNBZGFwdGVyLnN0eWxlLnNldFNjcm9sbExlZnQoc2Nyb2xsRWxlbWVudCwgbGVmdCk7XG4gICAgICAgIHV0aWxzQWRhcHRlci5zdHlsZS5zZXRTY3JvbGxUb3Aoc2Nyb2xsRWxlbWVudCwgdG9wKTtcblxuICAgICAgICBpZiAoIVNjcm9sbEF1dG9tYXRpb24uX2lzU2Nyb2xsVmFsdWVzQ2hhbmdlZChzY3JvbGxFbGVtZW50LCBvcmlnaW5hbFNjcm9sbCkpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHNjcm9sbFByb21pc2UuY2FuY2VsKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBzY3JvbGxBZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHNjcm9sbFByb21pc2UgPSBzY3JvbGxQcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLl9zY3JvbGxXYXNQZXJmb3JtZWQpXG4gICAgICAgICAgICAgICAgdGhpcy5fc2Nyb2xsV2FzUGVyZm9ybWVkID0gU2Nyb2xsQXV0b21hdGlvbi5faXNTY3JvbGxWYWx1ZXNDaGFuZ2VkKHNjcm9sbEVsZW1lbnQsIG9yaWdpbmFsU2Nyb2xsKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHNjcm9sbFByb21pc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0U2Nyb2xsVG9Qb2ludCAoZGltZW5zaW9uczogRGltZW5zaW9ucywgcG9pbnQ6IEF4aXNWYWx1ZXM8bnVtYmVyPiwgbWF4U2Nyb2xsTWFyZ2luOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4pOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4ge1xuICAgICAgICBjb25zdCBob3Jpem9udGFsQ2VudGVyID0gTWF0aC5mbG9vcihkaW1lbnNpb25zLndpZHRoIC8gMik7XG4gICAgICAgIGNvbnN0IHZlcnRpY2FsQ2VudGVyICAgPSBNYXRoLmZsb29yKGRpbWVuc2lvbnMuaGVpZ2h0IC8gMik7XG4gICAgICAgIGNvbnN0IGxlZnRTY3JvbGxNYXJnaW4gPSB0aGlzLl9zY3JvbGxUb0NlbnRlciA/IGhvcml6b250YWxDZW50ZXIgOiBNYXRoLm1pbihtYXhTY3JvbGxNYXJnaW4ubGVmdCwgaG9yaXpvbnRhbENlbnRlcik7XG4gICAgICAgIGNvbnN0IHRvcFNjcm9sbE1hcmdpbiAgPSB0aGlzLl9zY3JvbGxUb0NlbnRlciA/IHZlcnRpY2FsQ2VudGVyIDogTWF0aC5taW4obWF4U2Nyb2xsTWFyZ2luLnRvcCwgdmVydGljYWxDZW50ZXIpO1xuICAgICAgICBsZXQgeyBsZWZ0LCB0b3AgfSAgICAgID0gZGltZW5zaW9ucy5zY3JvbGw7XG5cbiAgICAgICAgY29uc3QgbmVlZEZvcndhcmRTY3JvbGxMZWZ0ICA9IHBvaW50LnggPj0gbGVmdCArIGRpbWVuc2lvbnMud2lkdGggLSBsZWZ0U2Nyb2xsTWFyZ2luO1xuICAgICAgICBjb25zdCBuZWVkQmFja3dhcmRTY3JvbGxMZWZ0ID0gcG9pbnQueCA8PSBsZWZ0ICsgbGVmdFNjcm9sbE1hcmdpbjtcblxuICAgICAgICBjb25zdCBuZWVkRm9yd2FyZFNjcm9sbFRvcCAgPSBwb2ludC55ID49IHRvcCArIGRpbWVuc2lvbnMuaGVpZ2h0IC0gdG9wU2Nyb2xsTWFyZ2luO1xuICAgICAgICBjb25zdCBuZWVkQmFja3dhcmRTY3JvbGxUb3AgPSBwb2ludC55IDw9IHRvcCArIHRvcFNjcm9sbE1hcmdpbjtcblxuICAgICAgICBpZiAobmVlZEZvcndhcmRTY3JvbGxMZWZ0KVxuICAgICAgICAgICAgbGVmdCA9IHBvaW50LnggLSBkaW1lbnNpb25zLndpZHRoICsgbGVmdFNjcm9sbE1hcmdpbjtcbiAgICAgICAgZWxzZSBpZiAobmVlZEJhY2t3YXJkU2Nyb2xsTGVmdClcbiAgICAgICAgICAgIGxlZnQgPSBwb2ludC54IC0gbGVmdFNjcm9sbE1hcmdpbjtcblxuICAgICAgICBpZiAobmVlZEZvcndhcmRTY3JvbGxUb3ApXG4gICAgICAgICAgICB0b3AgPSBwb2ludC55IC0gZGltZW5zaW9ucy5oZWlnaHQgKyB0b3BTY3JvbGxNYXJnaW47XG4gICAgICAgIGVsc2UgaWYgKG5lZWRCYWNrd2FyZFNjcm9sbFRvcClcbiAgICAgICAgICAgIHRvcCA9IHBvaW50LnkgLSB0b3BTY3JvbGxNYXJnaW47XG5cbiAgICAgICAgcmV0dXJuIHsgbGVmdCwgdG9wIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0U2Nyb2xsVG9GdWxsQ2hpbGRWaWV3IChwYXJlbnREaW1lbnNpb25zOiBEaW1lbnNpb25zLCBjaGlsZERpbWVuc2lvbnM6IERpbWVuc2lvbnMsIG1heFNjcm9sbE1hcmdpbjogTGVmdFRvcFZhbHVlczxudW1iZXI+KTogTGVmdFRvcFZhbHVlczxudW1iZXIgfCBudWxsPiB7XG4gICAgICAgIGNvbnN0IGZ1bGxWaWV3U2Nyb2xsOiBMZWZ0VG9wVmFsdWVzPG51bWJlciB8IG51bGw+ID0geyBsZWZ0OiBudWxsLCB0b3A6IG51bGwgfTtcblxuICAgICAgICBjb25zdCBjYW5TaG93RnVsbEVsZW1lbnRXaWR0aCAgPSBwYXJlbnREaW1lbnNpb25zLndpZHRoID49IGNoaWxkRGltZW5zaW9ucy53aWR0aDtcbiAgICAgICAgY29uc3QgY2FuU2hvd0Z1bGxFbGVtZW50SGVpZ2h0ID0gcGFyZW50RGltZW5zaW9ucy5oZWlnaHQgPj0gY2hpbGREaW1lbnNpb25zLmhlaWdodDtcblxuICAgICAgICBjb25zdCByZWxhdGl2ZVBvc2l0aW9uID0gcG9zaXRpb25VdGlscy5jYWxjUmVsYXRpdmVQb3NpdGlvbihjaGlsZERpbWVuc2lvbnMsIHBhcmVudERpbWVuc2lvbnMpO1xuXG4gICAgICAgIGlmIChjYW5TaG93RnVsbEVsZW1lbnRXaWR0aCkge1xuICAgICAgICAgICAgY29uc3QgYXZhaWxhYmxlTGVmdFNjcm9sbE1hcmdpbiA9IHBhcmVudERpbWVuc2lvbnMud2lkdGggLSBjaGlsZERpbWVuc2lvbnMud2lkdGg7XG4gICAgICAgICAgICBsZXQgbGVmdFNjcm9sbE1hcmdpbiAgICAgICAgICAgID0gTWF0aC5taW4obWF4U2Nyb2xsTWFyZ2luLmxlZnQsIGF2YWlsYWJsZUxlZnRTY3JvbGxNYXJnaW4pO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5fc2Nyb2xsVG9DZW50ZXIpXG4gICAgICAgICAgICAgICAgbGVmdFNjcm9sbE1hcmdpbiA9IGF2YWlsYWJsZUxlZnRTY3JvbGxNYXJnaW4gLyAyO1xuXG4gICAgICAgICAgICBpZiAocmVsYXRpdmVQb3NpdGlvbi5sZWZ0IDwgbGVmdFNjcm9sbE1hcmdpbilcbiAgICAgICAgICAgICAgICBmdWxsVmlld1Njcm9sbC5sZWZ0ID0gTWF0aC5yb3VuZChwYXJlbnREaW1lbnNpb25zLnNjcm9sbC5sZWZ0ICsgcmVsYXRpdmVQb3NpdGlvbi5sZWZ0IC0gbGVmdFNjcm9sbE1hcmdpbik7XG4gICAgICAgICAgICBlbHNlIGlmIChyZWxhdGl2ZVBvc2l0aW9uLnJpZ2h0IDwgbGVmdFNjcm9sbE1hcmdpbikge1xuICAgICAgICAgICAgICAgIGZ1bGxWaWV3U2Nyb2xsLmxlZnQgPSBNYXRoLnJvdW5kKHBhcmVudERpbWVuc2lvbnMuc2Nyb2xsLmxlZnQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgubWluKHJlbGF0aXZlUG9zaXRpb24ubGVmdCwgLXJlbGF0aXZlUG9zaXRpb24ucmlnaHQpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0U2Nyb2xsTWFyZ2luKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjYW5TaG93RnVsbEVsZW1lbnRIZWlnaHQpIHtcbiAgICAgICAgICAgIGNvbnN0IGF2YWlsYWJsZVRvcFNjcm9sbE1hcmdpbiA9IHBhcmVudERpbWVuc2lvbnMuaGVpZ2h0IC0gY2hpbGREaW1lbnNpb25zLmhlaWdodDtcbiAgICAgICAgICAgIGxldCB0b3BTY3JvbGxNYXJnaW4gICAgICAgICAgICA9IE1hdGgubWluKG1heFNjcm9sbE1hcmdpbi50b3AsIGF2YWlsYWJsZVRvcFNjcm9sbE1hcmdpbik7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLl9zY3JvbGxUb0NlbnRlcilcbiAgICAgICAgICAgICAgICB0b3BTY3JvbGxNYXJnaW4gPSBhdmFpbGFibGVUb3BTY3JvbGxNYXJnaW4gLyAyO1xuXG4gICAgICAgICAgICBpZiAocmVsYXRpdmVQb3NpdGlvbi50b3AgPCB0b3BTY3JvbGxNYXJnaW4pXG4gICAgICAgICAgICAgICAgZnVsbFZpZXdTY3JvbGwudG9wID0gTWF0aC5yb3VuZChwYXJlbnREaW1lbnNpb25zLnNjcm9sbC50b3AgKyByZWxhdGl2ZVBvc2l0aW9uLnRvcCAtIHRvcFNjcm9sbE1hcmdpbik7XG4gICAgICAgICAgICBlbHNlIGlmIChyZWxhdGl2ZVBvc2l0aW9uLmJvdHRvbSA8IHRvcFNjcm9sbE1hcmdpbikge1xuICAgICAgICAgICAgICAgIGZ1bGxWaWV3U2Nyb2xsLnRvcCA9IE1hdGgucm91bmQocGFyZW50RGltZW5zaW9ucy5zY3JvbGwudG9wICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgubWluKHJlbGF0aXZlUG9zaXRpb24udG9wLCAtcmVsYXRpdmVQb3NpdGlvbi5ib3R0b20pICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcFNjcm9sbE1hcmdpbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZnVsbFZpZXdTY3JvbGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldENoaWxkUG9pbnQgKHBhcmVudERpbWVuc2lvbnM6IERpbWVuc2lvbnMsIGNoaWxkRGltZW5zaW9uczogRGltZW5zaW9ucywgb2Zmc2V0czogQXhpc1ZhbHVlczxudW1iZXI+KTogQXhpc1ZhbHVlczxudW1iZXI+IHtcbiAgICAgICAgcmV0dXJuIEF4aXNWYWx1ZXMuY3JlYXRlKGNoaWxkRGltZW5zaW9ucylcbiAgICAgICAgICAgIC5zdWIoQXhpc1ZhbHVlcy5jcmVhdGUocGFyZW50RGltZW5zaW9ucykpXG4gICAgICAgICAgICAuYWRkKEF4aXNWYWx1ZXMuY3JlYXRlKHBhcmVudERpbWVuc2lvbnMuc2Nyb2xsKSlcbiAgICAgICAgICAgIC5hZGQoQXhpc1ZhbHVlcy5jcmVhdGUoY2hpbGREaW1lbnNpb25zLmJvcmRlcikpXG4gICAgICAgICAgICAuYWRkKG9mZnNldHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFNjcm9sbFBvc2l0aW9uIChwYXJlbnREaW1lbnNpb25zOiBEaW1lbnNpb25zLCBjaGlsZERpbWVuc2lvbnM6IERpbWVuc2lvbnMsIG9mZnNldHM6IEF4aXNWYWx1ZXM8bnVtYmVyPiwgbWF4U2Nyb2xsTWFyZ2luOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4pOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4ge1xuICAgICAgICBjb25zdCBjaGlsZFBvaW50ICAgICAgID0gU2Nyb2xsQXV0b21hdGlvbi5fZ2V0Q2hpbGRQb2ludChwYXJlbnREaW1lbnNpb25zLCBjaGlsZERpbWVuc2lvbnMsIG9mZnNldHMpO1xuICAgICAgICBjb25zdCBzY3JvbGxUb1BvaW50ICAgID0gdGhpcy5fZ2V0U2Nyb2xsVG9Qb2ludChwYXJlbnREaW1lbnNpb25zLCBjaGlsZFBvaW50LCBtYXhTY3JvbGxNYXJnaW4pO1xuICAgICAgICBjb25zdCBzY3JvbGxUb0Z1bGxWaWV3ID0gdGhpcy5fZ2V0U2Nyb2xsVG9GdWxsQ2hpbGRWaWV3KHBhcmVudERpbWVuc2lvbnMsIGNoaWxkRGltZW5zaW9ucywgbWF4U2Nyb2xsTWFyZ2luKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbGVmdDogTWF0aC5tYXgoc2Nyb2xsVG9GdWxsVmlldy5sZWZ0ID09PSBudWxsID8gc2Nyb2xsVG9Qb2ludC5sZWZ0IDogc2Nyb2xsVG9GdWxsVmlldy5sZWZ0LCAwKSxcbiAgICAgICAgICAgIHRvcDogIE1hdGgubWF4KHNjcm9sbFRvRnVsbFZpZXcudG9wID09PSBudWxsID8gc2Nyb2xsVG9Qb2ludC50b3AgOiBzY3JvbGxUb0Z1bGxWaWV3LnRvcCwgMCksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldENoaWxkUG9pbnRBZnRlclNjcm9sbCAocGFyZW50RGltZW5zaW9uczogRGltZW5zaW9ucywgY2hpbGREaW1lbnNpb25zOiBEaW1lbnNpb25zLCBjdXJyZW50U2Nyb2xsOiBMZWZ0VG9wVmFsdWVzPG51bWJlcj4sIG9mZnNldHM6IEF4aXNWYWx1ZXM8bnVtYmVyPik6IEF4aXNWYWx1ZXM8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiBBeGlzVmFsdWVzLmNyZWF0ZShjaGlsZERpbWVuc2lvbnMpXG4gICAgICAgICAgICAuYWRkKEF4aXNWYWx1ZXMuY3JlYXRlKHBhcmVudERpbWVuc2lvbnMuc2Nyb2xsKSlcbiAgICAgICAgICAgIC5zdWIoQXhpc1ZhbHVlcy5jcmVhdGUoY3VycmVudFNjcm9sbCkpXG4gICAgICAgICAgICAuYWRkKG9mZnNldHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2lzQ2hpbGRGdWxseVZpc2libGUgKHBhcmVudERpbWVuc2lvbnM6IERpbWVuc2lvbnMsIGNoaWxkRGltZW5zaW9uczogRGltZW5zaW9ucywgb2Zmc2V0czogQXhpc1ZhbHVlczxudW1iZXI+KTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGNoaWxkUG9pbnQgPSBTY3JvbGxBdXRvbWF0aW9uLl9nZXRDaGlsZFBvaW50QWZ0ZXJTY3JvbGwocGFyZW50RGltZW5zaW9ucywgY2hpbGREaW1lbnNpb25zLCBwYXJlbnREaW1lbnNpb25zLnNjcm9sbCwgb2Zmc2V0cyk7XG4gICAgICAgIGNvbnN0IHplcm9NYXJnaW4gPSB7IGxlZnQ6IDAsIHRvcDogMCB9O1xuXG4gICAgICAgIGNvbnN0IHsgbGVmdCwgdG9wIH0gPSB0aGlzLl9nZXRTY3JvbGxQb3NpdGlvbihwYXJlbnREaW1lbnNpb25zLCBjaGlsZERpbWVuc2lvbnMsIG9mZnNldHMsIHplcm9NYXJnaW4pO1xuXG4gICAgICAgIHJldHVybiAhdGhpcy5faXNUYXJnZXRFbGVtZW50T2JzY3VyZWRJblBvaW50KGNoaWxkUG9pbnQpICYmXG4gICAgICAgICAgICAgICBsZWZ0ID09PSBwYXJlbnREaW1lbnNpb25zLnNjcm9sbC5sZWZ0ICYmIHRvcCA9PT0gcGFyZW50RGltZW5zaW9ucy5zY3JvbGwudG9wO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Njcm9sbFRvQ2hpbGQgKHBhcmVudDogRWxlbWVudCwgY2hpbGQ6IEVsZW1lbnQsIG9mZnNldHM6IEF4aXNWYWx1ZXM8bnVtYmVyPik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBwYXJlbnREaW1lbnNpb25zID0gcG9zaXRpb25VdGlscy5nZXRDbGllbnREaW1lbnNpb25zKHBhcmVudCk7XG4gICAgICAgIGNvbnN0IGNoaWxkRGltZW5zaW9ucyAgPSBwb3NpdGlvblV0aWxzLmdldENsaWVudERpbWVuc2lvbnMoY2hpbGQpO1xuICAgICAgICBjb25zdCB3aW5kb3dXaWR0aCAgICAgID0gdXRpbHNBZGFwdGVyLnN0eWxlLmdldElubmVyV2lkdGgod2luZG93KTtcbiAgICAgICAgY29uc3Qgd2luZG93SGVpZ2h0ICAgICA9IHV0aWxzQWRhcHRlci5zdHlsZS5nZXRJbm5lckhlaWdodCh3aW5kb3cpO1xuXG4gICAgICAgIGxldCBzY3JvbGxQb3MgID0gcGFyZW50RGltZW5zaW9ucy5zY3JvbGw7XG4gICAgICAgIGxldCBuZWVkU2Nyb2xsID0gIXRoaXMuX2lzQ2hpbGRGdWxseVZpc2libGUocGFyZW50RGltZW5zaW9ucywgY2hpbGREaW1lbnNpb25zLCBvZmZzZXRzKTtcblxuICAgICAgICB3aGlsZSAobmVlZFNjcm9sbCkge1xuICAgICAgICAgICAgc2Nyb2xsUG9zID0gdGhpcy5fZ2V0U2Nyb2xsUG9zaXRpb24ocGFyZW50RGltZW5zaW9ucywgY2hpbGREaW1lbnNpb25zLCBvZmZzZXRzLCB0aGlzLl9tYXhTY3JvbGxNYXJnaW4pO1xuXG4gICAgICAgICAgICBjb25zdCBjaGlsZFBvaW50ICAgICAgID0gU2Nyb2xsQXV0b21hdGlvbi5fZ2V0Q2hpbGRQb2ludEFmdGVyU2Nyb2xsKHBhcmVudERpbWVuc2lvbnMsIGNoaWxkRGltZW5zaW9ucywgc2Nyb2xsUG9zLCBvZmZzZXRzKTtcbiAgICAgICAgICAgIGNvbnN0IGlzVGFyZ2V0T2JzY3VyZWQgPSB0aGlzLl9pc1RhcmdldEVsZW1lbnRPYnNjdXJlZEluUG9pbnQoY2hpbGRQb2ludCk7XG5cbiAgICAgICAgICAgIHRoaXMuX21heFNjcm9sbE1hcmdpbi5sZWZ0ICs9IFNDUk9MTF9NQVJHSU5fSU5DUkVBU0VfU1RFUDtcblxuICAgICAgICAgICAgaWYgKHRoaXMuX21heFNjcm9sbE1hcmdpbi5sZWZ0ID49IHdpbmRvd1dpZHRoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbWF4U2Nyb2xsTWFyZ2luLmxlZnQgPSBERUZBVUxUX01BWF9TQ1JPTExfTUFSR0lOO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5fbWF4U2Nyb2xsTWFyZ2luLnRvcCArPSBTQ1JPTExfTUFSR0lOX0lOQ1JFQVNFX1NURVA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG5lZWRTY3JvbGwgPSBpc1RhcmdldE9ic2N1cmVkICYmIHRoaXMuX21heFNjcm9sbE1hcmdpbi50b3AgPCB3aW5kb3dIZWlnaHQ7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9tYXhTY3JvbGxNYXJnaW4gPSB7IGxlZnQ6IERFRkFVTFRfTUFYX1NDUk9MTF9NQVJHSU4sIHRvcDogREVGQVVMVF9NQVhfU0NST0xMX01BUkdJTiB9O1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9zZXRTY3JvbGwocGFyZW50LCBzY3JvbGxQb3MpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3Njcm9sbEVsZW1lbnQgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIWhhc1Njcm9sbCh0aGlzLl9lbGVtZW50KSlcbiAgICAgICAgICAgIHJldHVybiBzY3JvbGxBZGFwdGVyLlByb21pc2VDdG9yLnJlc29sdmUoKTtcblxuICAgICAgICBjb25zdCBlbGVtZW50RGltZW5zaW9ucyA9IHBvc2l0aW9uVXRpbHMuZ2V0Q2xpZW50RGltZW5zaW9ucyh0aGlzLl9lbGVtZW50KTtcbiAgICAgICAgY29uc3Qgc2Nyb2xsID0gdGhpcy5fZ2V0U2Nyb2xsVG9Qb2ludChlbGVtZW50RGltZW5zaW9ucywgdGhpcy5fb2Zmc2V0cywgdGhpcy5fbWF4U2Nyb2xsTWFyZ2luKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fc2V0U2Nyb2xsKHRoaXMuX2VsZW1lbnQsIHNjcm9sbCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2Nyb2xsUGFyZW50cyAoKTogUHJvbWlzZTxTY3JvbGxSZXN1bHRQcm94eWxlc3MgfCBib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHBhcmVudHMgICAgICAgID0gZ2V0U2Nyb2xsYWJsZVBhcmVudHModGhpcy5fZWxlbWVudCk7XG4gICAgICAgIGxldCBjdXJyZW50Q2hpbGQgICAgID0gdGhpcy5fZWxlbWVudDtcbiAgICAgICAgY29uc3Qgc2Nyb2xsTGVmdCAgICAgPSB1dGlsc0FkYXB0ZXIuc3R5bGUuZ2V0U2Nyb2xsTGVmdChjdXJyZW50Q2hpbGQpO1xuICAgICAgICBjb25zdCBzY3JvbGxUb3AgICAgICA9IHV0aWxzQWRhcHRlci5zdHlsZS5nZXRTY3JvbGxUb3AoY3VycmVudENoaWxkKTtcbiAgICAgICAgY29uc3QgY3VycmVudE9mZnNldCAgPSBBeGlzVmFsdWVzLmNyZWF0ZSh0aGlzLl9vZmZzZXRzKS5zdWIobmV3IEF4aXNWYWx1ZXMoc2Nyb2xsTGVmdCwgc2Nyb2xsVG9wKS5yb3VuZCgpKTtcbiAgICAgICAgbGV0IGNoaWxkRGltZW5zaW9ucyAgPSBudWxsO1xuICAgICAgICBsZXQgcGFyZW50RGltZW5zaW9ucyA9IG51bGw7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsUGFyZW50c1Byb21pc2UgPSBwcm9taXNlVXRpbHMudGltZXMocGFyZW50cy5sZW5ndGgsIGkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbFRvQ2hpbGQocGFyZW50c1tpXSwgY3VycmVudENoaWxkLCBjdXJyZW50T2Zmc2V0KVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGREaW1lbnNpb25zICA9IHBvc2l0aW9uVXRpbHMuZ2V0Q2xpZW50RGltZW5zaW9ucyhjdXJyZW50Q2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnREaW1lbnNpb25zID0gcG9zaXRpb25VdGlscy5nZXRDbGllbnREaW1lbnNpb25zKHBhcmVudHNbaV0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRPZmZzZXQuYWRkKEF4aXNWYWx1ZXMuY3JlYXRlKGNoaWxkRGltZW5zaW9ucykpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3ViKEF4aXNWYWx1ZXMuY3JlYXRlKHBhcmVudERpbWVuc2lvbnMpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmFkZChBeGlzVmFsdWVzLmNyZWF0ZShwYXJlbnREaW1lbnNpb25zLmJvcmRlcikpO1xuXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDaGlsZCA9IHBhcmVudHNbaV07XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHN0YXRlOiBEaWN0aW9uYXJ5PGFueT4gPSB7XG4gICAgICAgICAgICBzY3JvbGxXYXNQZXJmb3JtZWQ6IHRoaXMuX3Njcm9sbFdhc1BlcmZvcm1lZCxcbiAgICAgICAgICAgIG9mZnNldFg6ICAgICAgICAgICAgY3VycmVudE9mZnNldC54LFxuICAgICAgICAgICAgb2Zmc2V0WTogICAgICAgICAgICBjdXJyZW50T2Zmc2V0LnksXG4gICAgICAgICAgICBtYXhTY3JvbGxNYXJnaW46ICAgIHRoaXMuX21heFNjcm9sbE1hcmdpbixcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoIXV0aWxzQWRhcHRlci5zZW5kUmVxdWVzdFRvRnJhbWUpXG4gICAgICAgICAgICByZXR1cm4gc2Nyb2xsUGFyZW50c1Byb21pc2UudGhlbigoKSA9PiBzdGF0ZSBhcyBTY3JvbGxSZXN1bHRQcm94eWxlc3MpO1xuXG4gICAgICAgIHJldHVybiBzY3JvbGxQYXJlbnRzUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9za2lwUGFyZW50RnJhbWVzIHx8ICFpc0lmcmFtZVdpbmRvdyh3aW5kb3cpKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgICAgICBzdGF0ZS5jbWQgPSBTY3JvbGxBdXRvbWF0aW9uLlNDUk9MTF9SRVFVRVNUX0NNRDtcblxuICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uLCBjb25zaXN0ZW50LXJldHVyblxuICAgICAgICAgICAgICAgIHJldHVybiB1dGlsc0FkYXB0ZXIuc2VuZFJlcXVlc3RUb0ZyYW1lIShzdGF0ZSwgU2Nyb2xsQXV0b21hdGlvbi5TQ1JPTExfUkVTUE9OU0VfQ01ELCB3aW5kb3cucGFyZW50KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLl9zY3JvbGxXYXNQZXJmb3JtZWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXRGaXhlZEFuY2VzdG9yT3JTZWxmIChlbGVtZW50OiBFbGVtZW50KTogTm9kZSB8IG51bGwge1xuICAgICAgICByZXR1cm4gdXRpbHNBZGFwdGVyLmRvbS5maW5kUGFyZW50KGVsZW1lbnQsIHRydWUsIGlzRml4ZWRFbGVtZW50KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pc1RhcmdldEVsZW1lbnRPYnNjdXJlZEluUG9pbnQgKHBvaW50OiBBeGlzVmFsdWVzPG51bWJlcj4pOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZWxlbWVudEluUG9pbnQgPSBwb3NpdGlvblV0aWxzLmdldEVsZW1lbnRGcm9tUG9pbnQocG9pbnQpO1xuXG4gICAgICAgIGlmICghZWxlbWVudEluUG9pbnQpXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgZml4ZWRFbGVtZW50ID0gU2Nyb2xsQXV0b21hdGlvbi5fZ2V0Rml4ZWRBbmNlc3Rvck9yU2VsZihlbGVtZW50SW5Qb2ludCk7XG5cbiAgICAgICAgcmV0dXJuICEhZml4ZWRFbGVtZW50ICYmICFmaXhlZEVsZW1lbnQuY29udGFpbnModGhpcy5fZWxlbWVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJ1biAoKTogUHJvbWlzZTxTY3JvbGxSZXN1bHRQcm94eWxlc3MgfCBib29sZWFuPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zY3JvbGxFbGVtZW50KClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuX3Njcm9sbFBhcmVudHMoKSk7XG4gICAgfVxufVxuIl19