"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.execPowershell = exports.exec = exports.execFile = void 0;
const child_process_1 = __importDefault(require("child_process"));
const fs_1 = __importDefault(require("fs"));
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const del_1 = __importDefault(require("del"));
const execa_1 = __importDefault(require("execa"));
const fs_extra_1 = require("fs-extra");
const os_family_1 = __importDefault(require("os-family"));
const nanoid_1 = require("nanoid");
const promisify_1 = __importDefault(require("./promisify"));
const binaries_1 = __importDefault(require("../binaries"));
const flatten_whitespace_1 = __importDefault(require("./flatten-whitespace"));
const get_environment_variable_1 = __importDefault(require("./get-environment-variable"));
const errors_1 = require("../errors");
const EXIT_CODE_REGEXP = /Exit code: (-?\d+)/;
const OPEN_PATH = '/usr/bin/open';
const TEMP_PIPE_NAME = seed => `testcafe-browser-tools-fifo-${seed}`;
const WINDOWS_DIR = get_environment_variable_1.default('SystemRoot') || 'C:\\Windows';
const SYSTEM32_DIR = path_1.default.join(WINDOWS_DIR, 'System32');
const CHCP_COM = path_1.default.join(SYSTEM32_DIR, 'chcp.com');
const POWERSHELL_DIR = path_1.default.join(SYSTEM32_DIR, 'WindowsPowerShell\\v1.0');
const POWERSHELL_BINARY = path_1.default.join(POWERSHELL_DIR, 'powershell.exe');
const POWERSHELL_ARGS = ['-NoProfile', '-NoLogo', '-NonInteractive', '-Command'];
const POWERSHELL_COMMAND_WRAPPER = command => flatten_whitespace_1.default `
    $cp = (${CHCP_COM} | Select-String '\d+').Matches.Value;
    Try
    {
        ${CHCP_COM} 65001;
        ${command};
    }
    Finally
    {
        ${CHCP_COM} $cp;
    }
`;
function getTempPipePath() {
    return path_1.default.join(os_1.default.tmpdir(), TEMP_PIPE_NAME(nanoid_1.nanoid()));
}
var execFilePromise = promisify_1.default(child_process_1.default.execFile);
var execPromise = promisify_1.default(child_process_1.default.exec);
function readPipe(pipePath) {
    return new Promise((resolve, reject) => {
        let data = '';
        const stream = fs_1.default.createReadStream(pipePath);
        stream.on('data', newData => {
            data += newData ? newData.toString() : '';
        });
        stream.on('end', () => resolve(data));
        stream.on('error', reject);
    });
}
function spawnApp(pipePath, binaryPath, args) {
    return new Promise((resolve, reject) => {
        const child = child_process_1.default.spawn(OPEN_PATH, ['-n', '-a', binaries_1.default.app, '--args', binaries_1.default.main, pipePath, binaryPath, ...args]);
        let outputData = '';
        child.on('error', reject);
        child.on('exit', code => {
            if (code)
                reject(new errors_1.NativeBinaryHasFailedError({ binary: binaryPath, exitCode: code, output: outputData }));
            else
                resolve();
        });
        function dataHandler(data) {
            outputData += String(data);
        }
        child.stdout.on('data', dataHandler);
        child.stderr.on('data', dataHandler);
    });
}
async function runWithMacApp(binaryPath, args) {
    if (!await fs_extra_1.pathExists(binaries_1.default.appDir)) {
        await fs_extra_1.ensureDir(binaries_1.default.appDir);
        await fs_extra_1.copy(binaries_1.default.appLocalDir, binaries_1.default.appDir);
    }
    const pipePath = getTempPipePath();
    await execPromise(`mkfifo ${pipePath}`);
    try {
        const [data] = await Promise.all([
            readPipe(pipePath),
            spawnApp(pipePath, binaryPath, args)
        ]);
        const exitCodeMatch = data.match(EXIT_CODE_REGEXP);
        if (!exitCodeMatch)
            return data;
        const exitCode = Number(exitCodeMatch[1]);
        if (exitCode)
            throw new errors_1.NativeBinaryHasFailedError({ binary: binaryPath, output: data, exitCode });
        return data;
    }
    finally {
        await del_1.default(pipePath, { force: true });
    }
}
//API
async function execFile(filePath, args) {
    try {
        if (os_family_1.default.mac)
            return await runWithMacApp(filePath, args);
        return await execFilePromise(filePath, args);
    }
    catch (err) {
        if (err instanceof errors_1.NativeBinaryHasFailedError)
            throw err;
        const errorCode = err.status || err.code;
        if (errorCode === void 0 || typeof errorCode === 'string')
            throw err;
        throw new errors_1.NativeBinaryHasFailedError({ binary: filePath, exitCode: errorCode });
    }
}
exports.execFile = execFile;
async function exec(command) {
    return execPromise(command, { env: process.env });
}
exports.exec = exec;
async function execPowershell(command) {
    const wrappedCommand = POWERSHELL_COMMAND_WRAPPER(command);
    // NOTE: We have to ignore stdin due to a problem with PowerShell 2.0
    // See https://stackoverflow.com/a/9157170/11818061 for details.
    return execa_1.default(POWERSHELL_BINARY, [...POWERSHELL_ARGS, wrappedCommand], { stdin: 'ignore' });
}
exports.execPowershell = execPowershell;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9leGVjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtFQUFzQztBQUN0Qyw0Q0FBb0I7QUFDcEIsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4Qiw4Q0FBc0I7QUFDdEIsa0RBQTBCO0FBQzFCLHVDQUF1RDtBQUN2RCwwREFBMkI7QUFDM0IsbUNBQWdDO0FBQ2hDLDREQUFvQztBQUNwQywyREFBbUM7QUFDbkMsOEVBQXFEO0FBQ3JELDBGQUFnRTtBQUNoRSxzQ0FBdUQ7QUFHdkQsTUFBTSxnQkFBZ0IsR0FBRyxvQkFBb0IsQ0FBQztBQUU5QyxNQUFNLFNBQVMsR0FBUSxlQUFlLENBQUM7QUFDdkMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQywrQkFBK0IsSUFBSSxFQUFFLENBQUM7QUFFckUsTUFBTSxXQUFXLEdBQVMsa0NBQXNCLENBQUMsWUFBWSxDQUFDLElBQUksYUFBYSxDQUFDO0FBQ2hGLE1BQU0sWUFBWSxHQUFRLGNBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzdELE1BQU0sUUFBUSxHQUFZLGNBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzlELE1BQU0sY0FBYyxHQUFNLGNBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLHlCQUF5QixDQUFDLENBQUM7QUFDN0UsTUFBTSxpQkFBaUIsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3RFLE1BQU0sZUFBZSxHQUFLLENBQUMsWUFBWSxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUVuRixNQUFNLDBCQUEwQixHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUMsNEJBQWlCLENBQUM7YUFDbkQsUUFBUTs7O1VBR1gsUUFB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LEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFekMsSUFBSSxTQUFTLEtBQUssS0FBSyxDQUFDLElBQUksT0FBTyxTQUFTLEtBQUssUUFBUTtZQUNyRCxNQUFNLEdBQUcsQ0FBQztRQUVkLE1BQU0sSUFBSSxtQ0FBMEIsQ0FBQyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7S0FDbkY7QUFDTCxDQUFDO0FBbEJELDRCQWtCQztBQUVNLEtBQUssVUFBVSxJQUFJLENBQUUsT0FBTztJQUMvQixPQUFPLFdBQVcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUZELG9CQUVDO0FBRU0sS0FBSyxVQUFVLGNBQWMsQ0FBRSxPQUFPO0lBQ3pDLE1BQU0sY0FBYyxHQUFHLDBCQUEwQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTNELHFFQUFxRTtJQUNyRSxnRUFBZ0U7SUFDaEUsT0FBTyxlQUFLLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxHQUFHLGVBQWUsRUFBRSxjQUFjLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO0FBQy9GLENBQUM7QUFORCx3Q0FNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGlsZFByb2MgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGRlbCBmcm9tICdkZWwnO1xuaW1wb3J0IGV4ZWNhIGZyb20gJ2V4ZWNhJztcbmltcG9ydCB7IGVuc3VyZURpciwgcGF0aEV4aXN0cywgY29weSB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IHsgbmFub2lkIH0gZnJvbSAnbmFub2lkJztcbmltcG9ydCBwcm9taXNpZnkgZnJvbSAnLi9wcm9taXNpZnknO1xuaW1wb3J0IEJJTkFSSUVTIGZyb20gJy4uL2JpbmFyaWVzJztcbmltcG9ydCBmbGF0dGVuV2hpdGVzcGFjZSBmcm9tICcuL2ZsYXR0ZW4td2hpdGVzcGFjZSc7XG5pbXBvcnQgZ2V0RW52aXJvbm1lbnRWYXJpYWJsZSBmcm9tICcuL2dldC1lbnZpcm9ubWVudC12YXJpYWJsZSc7XG5pbXBvcnQgeyBOYXRpdmVCaW5hcnlIYXNGYWlsZWRFcnJvciB9IGZyb20gJy4uL2Vycm9ycyc7XG5cblxuY29uc3QgRVhJVF9DT0RFX1JFR0VYUCA9IC9FeGl0IGNvZGU6ICgtP1xcZCspLztcblxuY29uc3QgT1BFTl9QQVRIICAgICAgPSAnL3Vzci9iaW4vb3Blbic7XG5jb25zdCBURU1QX1BJUEVfTkFNRSA9IHNlZWQgPT4gYHRlc3RjYWZlLWJyb3dzZXItdG9vbHMtZmlmby0ke3NlZWR9YDtcblxuY29uc3QgV0lORE9XU19ESVIgICAgICAgPSBnZXRFbnZpcm9ubWVudFZhcmlhYmxlKCdTeXN0ZW1Sb290JykgfHwgJ0M6XFxcXFdpbmRvd3MnO1xuY29uc3QgU1lTVEVNMzJfRElSICAgICAgPSBwYXRoLmpvaW4oV0lORE9XU19ESVIsICdTeXN0ZW0zMicpO1xuY29uc3QgQ0hDUF9DT00gICAgICAgICAgPSBwYXRoLmpvaW4oU1lTVEVNMzJfRElSLCAnY2hjcC5jb20nKTtcbmNvbnN0IFBPV0VSU0hFTExfRElSICAgID0gcGF0aC5qb2luKFNZU1RFTTMyX0RJUiwgJ1dpbmRvd3NQb3dlclNoZWxsXFxcXHYxLjAnKTtcbmNvbnN0IFBPV0VSU0hFTExfQklOQVJZID0gcGF0aC5qb2luKFBPV0VSU0hFTExfRElSLCAncG93ZXJzaGVsbC5leGUnKTtcbmNvbnN0IFBPV0VSU0hFTExfQVJHUyAgID0gWyctTm9Qcm9maWxlJywgJy1Ob0xvZ28nLCAnLU5vbkludGVyYWN0aXZlJywgJy1Db21tYW5kJ107XG5cbmNvbnN0IFBPV0VSU0hFTExfQ09NTUFORF9XUkFQUEVSID0gY29tbWFuZCA9PiBmbGF0dGVuV2hpdGVzcGFjZSBgXG4gICAgJGNwID0gKCR7Q0hDUF9DT019IHwgU2VsZWN0LVN0cmluZyAnXFxkKycpLk1hdGNoZXMuVmFsdWU7XG4gICAgVHJ5XG4gICAge1xuICAgICAgICAke0NIQ1BfQ09NfSA2NTAwMTtcbiAgICAgICAgJHtjb21tYW5kfTtcbiAgICB9XG4gICAgRmluYWxseVxuICAgIHtcbiAgICAgICAgJHtDSENQX0NPTX0gJGNwO1xuICAgIH1cbmA7XG5cbmZ1bmN0aW9uIGdldFRlbXBQaXBlUGF0aCAoKSB7XG4gICAgcmV0dXJuIHBhdGguam9pbihvcy50bXBkaXIoKSwgVEVNUF9QSVBFX05BTUUobmFub2lkKCkpKTtcbn1cblxudmFyIGV4ZWNGaWxlUHJvbWlzZSA9IHByb21pc2lmeShjaGlsZFByb2MuZXhlY0ZpbGUpO1xudmFyIGV4ZWNQcm9taXNlICAgICA9IHByb21pc2lmeShjaGlsZFByb2MuZXhlYyk7XG5cblxuZnVuY3Rpb24gcmVhZFBpcGUgKHBpcGVQYXRoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgbGV0IGRhdGEgICAgID0gJyc7XG4gICAgICAgIGNvbnN0IHN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0ocGlwZVBhdGgpO1xuXG4gICAgICAgIHN0cmVhbS5vbignZGF0YScsIG5ld0RhdGEgPT4ge1xuICAgICAgICAgICAgZGF0YSArPSBuZXdEYXRhID8gbmV3RGF0YS50b1N0cmluZygpIDogJyc7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHN0cmVhbS5vbignZW5kJywgKCkgPT4gcmVzb2x2ZShkYXRhKSk7XG4gICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBzcGF3bkFwcCAocGlwZVBhdGgsIGJpbmFyeVBhdGgsIGFyZ3MpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkUHJvYy5zcGF3bihPUEVOX1BBVEgsIFsnLW4nLCAnLWEnLCBCSU5BUklFUy5hcHAsICctLWFyZ3MnLCBCSU5BUklFUy5tYWluLCBwaXBlUGF0aCwgYmluYXJ5UGF0aCwgLi4uYXJnc10pO1xuXG4gICAgICAgIGxldCBvdXRwdXREYXRhID0gJyc7XG5cbiAgICAgICAgY2hpbGQub24oJ2Vycm9yJywgcmVqZWN0KTtcblxuICAgICAgICBjaGlsZC5vbignZXhpdCcsIGNvZGUgPT4ge1xuICAgICAgICAgICAgaWYgKGNvZGUpXG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBOYXRpdmVCaW5hcnlIYXNGYWlsZWRFcnJvcih7IGJpbmFyeTogYmluYXJ5UGF0aCwgZXhpdENvZGU6IGNvZGUsIG91dHB1dDogb3V0cHV0RGF0YSB9KSk7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBmdW5jdGlvbiBkYXRhSGFuZGxlciAoZGF0YSkge1xuICAgICAgICAgICAgb3V0cHV0RGF0YSArPSBTdHJpbmcoZGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBjaGlsZC5zdGRvdXQub24oJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG4gICAgICAgIGNoaWxkLnN0ZGVyci5vbignZGF0YScsIGRhdGFIYW5kbGVyKTtcbiAgICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuV2l0aE1hY0FwcCAoYmluYXJ5UGF0aCwgYXJncykge1xuICAgIGlmICghYXdhaXQgcGF0aEV4aXN0cyhCSU5BUklFUy5hcHBEaXIpKSB7XG4gICAgICAgIGF3YWl0IGVuc3VyZURpcihCSU5BUklFUy5hcHBEaXIpO1xuICAgICAgICBhd2FpdCBjb3B5KEJJTkFSSUVTLmFwcExvY2FsRGlyLCBCSU5BUklFUy5hcHBEaXIpO1xuICAgIH1cblxuICAgIGNvbnN0IHBpcGVQYXRoID0gZ2V0VGVtcFBpcGVQYXRoKCk7XG5cbiAgICBhd2FpdCBleGVjUHJvbWlzZShgbWtmaWZvICR7cGlwZVBhdGh9YCk7XG5cbiAgICB0cnkge1xuICAgICAgICBjb25zdCBbZGF0YV0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICByZWFkUGlwZShwaXBlUGF0aCksXG4gICAgICAgICAgICBzcGF3bkFwcChwaXBlUGF0aCwgYmluYXJ5UGF0aCwgYXJncylcbiAgICAgICAgXSk7XG5cbiAgICAgICAgY29uc3QgZXhpdENvZGVNYXRjaCA9IGRhdGEubWF0Y2goRVhJVF9DT0RFX1JFR0VYUCk7XG5cbiAgICAgICAgaWYgKCFleGl0Q29kZU1hdGNoKVxuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG5cbiAgICAgICAgY29uc3QgZXhpdENvZGUgPSBOdW1iZXIoZXhpdENvZGVNYXRjaFsxXSk7XG5cbiAgICAgICAgaWYgKGV4aXRDb2RlKVxuICAgICAgICAgICAgdGhyb3cgbmV3IE5hdGl2ZUJpbmFyeUhhc0ZhaWxlZEVycm9yKHsgYmluYXJ5OiBiaW5hcnlQYXRoLCBvdXRwdXQ6IGRhdGEsIGV4aXRDb2RlIH0pO1xuXG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbiAgICBmaW5hbGx5IHtcbiAgICAgICAgYXdhaXQgZGVsKHBpcGVQYXRoLCB7IGZvcmNlOiB0cnVlIH0pO1xuICAgIH1cbn1cblxuLy9BUElcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjRmlsZSAoZmlsZVBhdGgsIGFyZ3MpIHtcbiAgICB0cnkge1xuICAgICAgICBpZiAoT1MubWFjKVxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHJ1bldpdGhNYWNBcHAoZmlsZVBhdGgsIGFyZ3MpO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBleGVjRmlsZVByb21pc2UoZmlsZVBhdGgsIGFyZ3MpO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBOYXRpdmVCaW5hcnlIYXNGYWlsZWRFcnJvcilcbiAgICAgICAgICAgIHRocm93IGVycjtcblxuICAgICAgICBjb25zdCBlcnJvckNvZGUgPSBlcnIuc3RhdHVzIHx8IGVyci5jb2RlO1xuXG4gICAgICAgIGlmIChlcnJvckNvZGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgZXJyb3JDb2RlID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgIHRocm93IGVycjtcblxuICAgICAgICB0aHJvdyBuZXcgTmF0aXZlQmluYXJ5SGFzRmFpbGVkRXJyb3IoeyBiaW5hcnk6IGZpbGVQYXRoLCBleGl0Q29kZTogZXJyb3JDb2RlIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGV4ZWMgKGNvbW1hbmQpIHtcbiAgICByZXR1cm4gZXhlY1Byb21pc2UoY29tbWFuZCwgeyBlbnY6IHByb2Nlc3MuZW52IH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZXhlY1Bvd2Vyc2hlbGwgKGNvbW1hbmQpIHtcbiAgICBjb25zdCB3cmFwcGVkQ29tbWFuZCA9IFBPV0VSU0hFTExfQ09NTUFORF9XUkFQUEVSKGNvbW1hbmQpO1xuXG4gICAgLy8gTk9URTogV2UgaGF2ZSB0byBpZ25vcmUgc3RkaW4gZHVlIHRvIGEgcHJvYmxlbSB3aXRoIFBvd2VyU2hlbGwgMi4wXG4gICAgLy8gU2VlIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vYS85MTU3MTcwLzExODE4MDYxIGZvciBkZXRhaWxzLlxuICAgIHJldHVybiBleGVjYShQT1dFUlNIRUxMX0JJTkFSWSwgWy4uLlBPV0VSU0hFTExfQVJHUywgd3JhcHBlZENvbW1hbmRdLCB7IHN0ZGluOiAnaWdub3JlJyB9KTtcbn1cbiJdfQ==